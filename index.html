<!DOCTYPE html>

<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Ä°zmir Devlet Tiyatrosu MÃ¼dÃ¼rlÃ¼ÄŸÃ¼ â€¢ Repertuvar KiÅŸi Takip Sistemi</title>
<style>

:root{
      --bg:#e9ded1;            /* premium warm ivory */
      --card:#fbf7f1;
      --text:#16161a;
      --muted:#5a5560;
      --line:#dccbb7;

      --accent:#7a1e2c;        /* bordo */
      --accent2:#c07a2a;       /* altÄ±n */
      --ok:#18794e;
      --warn:#b45309;
      --bad:#b42318;
      --shadow:0 10px 30px rgba(24,16,8,.12);
      --radius:18px;
      --radius2:14px;
    }


/* --- Alias tokens (compat) --- */
:root{
  --r: var(--radius);
  --r2: var(--radius2);
  --good: var(--ok);
  --border: var(--line);
  --primary: var(--accent);
  --ink: var(--text);
  --chip: color-mix(in srgb, var(--card) 82%, var(--bg) 18%);
}
html[data-theme="dark"]{
  --border: var(--line);
  --primary: var(--accent);
  --ink: var(--text);
}
html[data-theme="dark"]{
      --bg:#0b1020;
      --card:#0f172a;
      --text:#f1f5f9;
      --muted:#cbd5e1;
      --line:#1f2a44;

      --accent:#60a5fa;
      --accent2:#93c5fd;

      --shadow: 0 18px 44px rgba(0,0,0,.55);
      --chip:#111827;

      --soft1:rgba(96,165,250,.14);
      --soft2:rgba(34,197,94,.14);
      --soft3:rgba(245,158,11,.14);
      --soft4:rgba(236,72,153,.14);

      --tabActiveBg: rgba(148,163,184,.12);
      --tabActiveBorder: rgba(148,163,184,.25);
      --tabActiveText: #f1f5f9;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, sans-serif;color:var(--text);background:var(--bg);}
    a{color:inherit}
    header{
      position:sticky;top:0;z-index:40;
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1220px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;flex-wrap:wrap;
      padding:12px 16px;justify-content:space-between;gap:16px;}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:var(--shadow);
      display:grid;place-items:center;color:#fff;font-weight:900;
      letter-spacing:.6px;
    }
    .brand h1{margin:0;font-size:14px;line-height:1.25}
    .brand .sub{margin-top:3px;color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:nowrap;margin-left:auto;}

    .notif{position:relative}
    .badge{
      margin-left:6px;
      background:var(--accent);
      color:#fff;
      border-radius:999px;
      padding:2px 7px;
      font-size:11px;
      font-weight:800;
    }
    .hidden{display:none !important}
    .notifPanel{
      position:absolute;
      right:0;
      top:46px;
      width:min(420px, 92vw);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
      z-index:80;
    }
    .notifHd{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:flex;justify-content:flex-start;align-items:flex-start;gap:10px;
      background:linear-gradient(180deg,color-mix(in srgb, var(--card) 100%, transparent), color-mix(in srgb, var(--card) 92%, var(--bg) 8%));
    }
    .notifBd{max-height:52vh;overflow:auto;padding:10px}

    /* Mobilde bildirim paneli viewport dÄ±ÅŸÄ±na taÅŸmasÄ±n */
    @media (max-width: 760px){
      .notifPanel{
        position:fixed;
        top:76px;
        left:12px;
        right:12px;
        width:auto;
        max-height:78vh;
      }
      .notifBd{max-height:calc(78vh - 70px)}
    }
    .logItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      margin-bottom:8px;
      background:color-mix(in srgb, var(--card) 92%, var(--bg) 8%);
    }
    .logItem .meta{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;font-weight:700;
      background:var(--chip);
      color:var(--text);
      margin-left:8px;
      white-space:nowrap;
    }
    .tag.retired{
      border-color: color-mix(in srgb, var(--accent2) 35%, var(--line) 65%);
      background: color-mix(in srgb, var(--accent2) 10%, var(--card) 90%);
      color: color-mix(in srgb, var(--text) 60%, var(--accent) 40%);
    }

    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:var(--card);
      font-size:12px;color:var(--muted);
      display:flex;gap:8px;align-items:center;
      max-width:60vw; overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:9px 11px;border-radius:12px;
      cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;
      text-decoration:none;
      font-size:13px;
    }
    .btn:hover{border-color:color-mix(in srgb, var(--line) 55%, var(--accent) 45%)}
    .btn.primary{border-color:color-mix(in srgb, var(--accent) 35%, var(--line) 65%);background:color-mix(in srgb, var(--accent) 8%, var(--card) 92%);color:var(--accent2)}
    .btn.good{border-color:color-mix(in srgb, var(--good) 30%, var(--line) 70%);background:color-mix(in srgb, var(--good) 7%, var(--card) 93%);color:var(--good)}

    .nav{
      display:flex;gap:8px;flex-wrap:wrap;
      padding:0 16px 12px;
    }
    .tab{
      padding:9px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      cursor:pointer;font-size:13px;
    }
    .tab.active{
      border-color:var(--tabActiveBorder);
      background:var(--tabActiveBg);
      color:var(--tabActiveText);
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:flex-start;gap:10px;flex-wrap:wrap;
      background:linear-gradient(180deg,color-mix(in srgb, var(--card) 100%, transparent), color-mix(in srgb, var(--card) 92%, var(--bg) 8%));
    }
    .card .hd h2{margin:0;font-size:14px}
    .card .bd{padding:12px}
    .grid{display:grid;gap:12px;grid-template-columns: 1.1fr .9fr;margin-top:12px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} header{position:relative} }

    .kpis{
      display:grid;gap:12px;
      grid-template-columns:repeat(4,1fr);
      margin-bottom:12px;
    }
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr)}}
    @media (max-width: 520px){ .kpis{grid-template-columns:1fr}}
    .kpi{
display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  padding:18px 18px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.06);
  box-shadow: var(--shadow);
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:22px;font-weight:900;letter-spacing:.2px}
    .kpi .icon{
width:48px;
  height:48px;
  display:grid;
  place-items:center;
  border-radius:14px;
  font-size:26px; /* bigger icon */
  line-height:1;
  flex:0 0 auto;
  margin-left:18px;
  background: rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.06);
}
.kpi > div:first-child{flex:1; min-width:0;}

    /* KPI cards as shortcuts (Panel / Analiz / FigÃ¼ran / Grafikler) */
    .kpi[data-go]{cursor:pointer; user-select:none;}
    .kpi[data-go]:hover{transform:translateY(-1px);}
    .kpi[data-go]:active{transform:translateY(0);}
    .kpi[data-go]:focus{outline:3px solid rgba(192,122,42,.35); outline-offset:2px;}

    .kpi.soft1{background:linear-gradient(135deg,var(--soft1), var(--card));}
    .kpi.soft2{background:linear-gradient(135deg,var(--soft2), var(--card));}
    .kpi.soft3{background:linear-gradient(135deg,var(--soft3), var(--card));}
    .kpi.soft4{background:linear-gradient(135deg,var(--soft4), var(--card));}

    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;flex:1;justify-content:center;margin-left:auto;margin-right:auto}
    .input{
      display:flex;align-items:center;gap:8px;min-width:260px;max-width:560px;flex:0 1 560px;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      min-width: 190px;
      max-width: 640px;
      flex:1 1 260px;
    }
    .input input, .input select{
      width:100%;background:transparent;border:0;outline:0;
      color:var(--text);font-size:14px;
      appearance:none;
    }
    /* Dark-mode select dropdown readability */
    select, option{
      color:var(--text);
      background: color-mix(in srgb, var(--card) 95%, var(--bg) 5%);
    }
    html[data-theme="dark"] select, html[data-theme="dark"] option{
      background:#0f172a;
      color:#e5e7eb;
    }

    .seg{
      display:inline-flex;align-items:center;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background:var(--card);
    }
    .seg button{
      border:0;background:transparent;color:var(--muted);
      padding:10px 12px;cursor:pointer;font-size:13px;
    }
    .seg button.active{
      color:var(--text);
      background: color-mix(in srgb, var(--card) 78%, var(--bg) 22%);
      font-weight:800;
    }

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      padding:12px;border-radius:var(--r2);
      border:1px solid var(--line);
      background:var(--card);
      cursor:pointer;
    }
    .item:hover{border-color:color-mix(in srgb, var(--line) 60%, var(--accent) 40%)}
    .item .t{display:flex;align-items:flex-start;justify-content:flex-start;gap:10px}
    .name{font-weight:850; letter-spacing:.2px}
    .meta{margin-top:4px;color:var(--muted);font-size:12px}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .chip{
      padding:6px 9px;border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      font-size:12px;color:var(--muted);
      max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .chip.warn{border-color:color-mix(in srgb, var(--warn) 30%, var(--line) 70%);background:color-mix(in srgb, var(--warn) 10%, var(--chip) 90%);color:color-mix(in srgb, var(--warn) 65%, var(--text) 35%)}
    .chip.good{border-color:color-mix(in srgb, var(--good) 30%, var(--line) 70%);background:color-mix(in srgb, var(--good) 10%, var(--chip) 90%);color:var(--good)}
    .chip.bad{border-color:color-mix(in srgb, var(--bad) 30%, var(--line) 70%);background:color-mix(in srgb, var(--bad) 10%, var(--chip) 90%);color:var(--bad)}
    .empty{
      padding:16px;border-radius:14px;
      border:1px dashed color-mix(in srgb, var(--line) 70%, var(--muted) 30%);
      color:var(--muted);text-align:center;
      background:var(--card);
    }
    .title{margin:0 0 6px;font-size:18px}
    .subtitle{margin:0 0 12px;color:var(--muted);font-size:13px}

    .table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      border:1px solid var(--line);
      border-radius:14px;overflow:hidden;
      background:var(--card);
    }
    .table th,.table td{
      padding:10px 10px;border-bottom:1px solid var(--line);
      text-align:left;font-size:13px;vertical-align:top;
    }
    .table th{color:var(--muted);font-weight:800;background:color-mix(in srgb, var(--card) 70%, var(--bg) 30%)}
    .table tr:last-child td{border-bottom:0}
    footer{padding:12px 14px;color:var(--muted);font-size:12px;border-top:1px solid var(--line);background:var(--card)}
    code{background:color-mix(in srgb, var(--card) 70%, var(--bg) 30%);padding:2px 6px;border-radius:8px;border:1px solid var(--line)}
    .small{color:var(--muted);font-size:12px}

    /* Charts */
    .chartsNav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .chartsNav .tab{border-radius:999px}
    canvas{width:100%;height:340px;display:block;border-radius:14px;border:1px solid var(--line);background:var(--card);cursor:pointer}

    .drawer{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:var(--card);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:sticky; top:98px;
      height: fit-content;
      min-height: 140px;
    }
    .drawer .hd{padding:12px;border-bottom:1px solid var(--line);display:flex;justify-content:flex-start;gap:10px;align-items:center}
    .drawer .bd{padding:12px}
    .drawer.hidden{display:none}
    .drawerTitle{font-weight:900}
    .drawerSub{color:var(--muted);font-size:12px;margin-top:2px}
    .miniList{display:flex;flex-direction:column;gap:8px;margin-top:10px;max-height:60vh;overflow:auto}
    .miniItem{border:1px solid var(--line);border-radius:14px;padding:10px;background:color-mix(in srgb, var(--card) 88%, var(--bg) 12%)}
    .miniItem b{display:block}
  

    /* ---- UI tweaks ---- */
    .seg button{ padding:12px 16px; font-size:15px; }
    .seg button.active{ box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 55%, transparent); }
    input, select, textarea{ color: var(--text); background: var(--card); border:1px solid var(--border); }
    input::placeholder, textarea::placeholder{ color: color-mix(in srgb, var(--text) 45%, transparent); }
    table{ color: var(--text); }
    th, td{ color: var(--text); }
    .muted{ color: var(--muted); }

    /* Mobile detail as modal */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:50; }
    .modal{ position:fixed; left:50%; transform:translateX(-50%); bottom:12px; width:min(980px, calc(100% - 24px));
            max-height:80vh; background:var(--card); border:1px solid var(--border); border-radius:16px; z-index:60;
            box-shadow: 0 20px 60px rgba(0,0,0,.25); overflow:hidden; }
    .modalHead{ display:flex; align-items:center; justify-content:flex-start; padding:12px 12px; border-bottom:1px solid var(--border); }
    .modalTitle{ font-weight:800; }
    .modalBody{ padding:12px; overflow:auto; max-height:calc(80vh - 54px); }
    .hidden{ display:none !important; }

    @media (min-width: 981px){
      /* Desktop: keep modal hidden */
      #mobileModal, #mobileOverlay{ display:none !important; }
    }

/* --- UI sadeleÅŸtirme: sadece Panel + Grafikler --- */
.tabs button#tabDistribution,
.tabs button#tabIntersection,
.tabs button#tabFiguran { display:none !important; }

/* Dark mode dÃ¼ÄŸmesini gizle (tema sabit) */


/* Mobilde detay modalÄ± daha geniÅŸ ve okunur */
@media (max-width: 900px){
  .modal{ width:min(92vw, 720px) !important; }
  .modalContent{ max-height: 75vh !important; overflow:auto; }

  /* Grafikler: mobilde tek kolon + Ã§izimler taÅŸmasÄ±n */
  #viewCharts .grid{ grid-template-columns: 1fr !important; }
  /* Mobilde canvas yerine dokunmatik liste kullanacaÄŸÄ±z */
  #chartMain{ display:none !important; }
  canvas{ max-width:100%; height:auto; }

  /* Mobil modal iÃ§indeki tablolar yatay kaydÄ±rÄ±labilir olsun */
  #mobileModalBd table{ display:block; width:100%; overflow-x:auto; }
}

/* ---- Mobil Grafik Listesi (Canvas alternatifi) ---- */
.mobileChartWrap{ display:none; }
.mobileChartList{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
.chipRow{ display:flex; align-items:center; justify-content:flex-start; gap:10px; padding:12px 12px; border-radius:14px; cursor:pointer; user-select:none;
  border:1px solid rgba(0,0,0,.08); box-shadow: 0 6px 20px rgba(0,0,0,.06); }
.chipLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
.dot{ width:14px; height:14px; border-radius:999px; flex:0 0 14px; box-shadow:0 0 0 4px rgba(255,255,255,.35) inset; }
.chipTitle{ font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:62vw; }
.chipCount{ font-weight:900; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.55); border:1px solid rgba(255,255,255,.35); }

@media (max-width: 900px){
  .mobileChartWrap{ display:block; }
}

/* Grafik yazÄ±larÄ± daha okunur */
.chartWrap svg text{ font-size: 12px; fill: var(--text); }


/* --- Notifications (chat bubble) --- */
.notif-bubble{
  display:flex;
  gap:10px;
  align-items:flex-start;
  padding:8px 10px;
  margin:8px 0;
  border-radius:14px;
  background:rgba(255,255,255,.78);
  border:1px solid rgba(0,0,0,.06);
  box-shadow:0 6px 14px rgba(0,0,0,.06);
  cursor:pointer
}
.notif-bubble:hover{transform:translateY(-1px)}
.notif-bubble.seen{opacity:.62}
.notif-type{
  width:28px;height:28px;
  display:flex;align-items:center;justify-content:center;
  border-radius:10px;
  background:rgba(0,0,0,.05);
  font-size:15px;
  flex:0 0 28px
}
.notif-title{font-weight:800;margin-bottom:2px;font-size:13px;letter-spacing:.2px}
.notif-msg{margin:2px 0 6px 0;font-size:13px;line-height:1.35}
.notif-meta{font-size:12px;opacity:.8}
.notif-ts{font-size:11px;opacity:.65;margin-top:6px}

/* Mobil breadcrumb (oyun -> ekip) */
.mobile-breadcrumb{display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:8px 10px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.55);backdrop-filter: blur(6px);}
.mobile-breadcrumb .mb-text{font-weight:600;color:var(--ink);opacity:.9}
@media (max-width: 980px){
  .mobile-breadcrumb{position:sticky;top:8px;z-index:5}
}



    /* --- Responsive: mobilde canvas gizle, renkli liste gÃ¶ster --- */
    @media (max-width: 820px){
  #chartMain{ display:none !important; }
  .mobileChartWrap{ display:block !important; }
  .drawer{ position:relative !important; top:auto !important; inset:auto !important; border-radius: var(--r) !important; z-index:auto !important; }
}
.miniItem{ padding:14px !important; }
      .miniItem b{ font-size:16px; }
    }



body.drawerOpen{ overflow:auto; }



/* Enforce theme text colors */
body{ background:var(--bg); color:var(--text); }
a{ color:inherit; }
.table th, .table td{ color:var(--text); }
.btn{ color:var(--text); }
.input input, .input select, input, select, textarea{ color:var(--text); background:transparent; }



    /* Dark mode â€“ bazÄ± tarayÄ±cÄ±larda siyah kalan metinleri zorla dÃ¼zelt */
    html[data-theme="dark"] body{ color: var(--text); }
    html[data-theme="dark"] button,
    html[data-theme="dark"] input,
    html[data-theme="dark"] select,
    html[data-theme="dark"] textarea,
    html[data-theme="dark"] option,
    html[data-theme="dark"] label,
    html[data-theme="dark"] summary,
    html[data-theme="dark"] .btn,
    html[data-theme="dark"] .input,
    html[data-theme="dark"] .table,
    html[data-theme="dark"] .table td,
    html[data-theme="dark"] .table th,
    html[data-theme="dark"] .modal,
    html[data-theme="dark"] .drawer{
      color: var(--text);
    }
    html[data-theme="dark"] .subtitle,
    html[data-theme="dark"] .muted,
    html[data-theme="dark"] .pill,
    html[data-theme="dark"] footer{
      color: var(--muted);
    }
    /* Safari/Chrome autofill siyah yazÄ± bug'Ä± */
    html[data-theme="dark"] input:-webkit-autofill,
    html[data-theme="dark"] textarea:-webkit-autofill,
    html[data-theme="dark"] select:-webkit-autofill{
      -webkit-text-fill-color: var(--text) !important;
      transition: background-color 999999s ease-in-out 0s;
    }
    /* SVG iÃ§inde text (ikon vb.) */
    html[data-theme="dark"] svg text{ fill: var(--text); }



    #distributionBox th:nth-child(2){white-space:nowrap; width:110px}


/* UX: tÄ±klanabilir liste Ã¶ÄŸeleri */
.miniItem, .miniRow{
  cursor:pointer;
}
.miniItem:hover, .miniRow:hover{
  filter: brightness(1.04);
}

@media (max-width: 720px){.actions{flex-wrap:wrap;margin-left:0} .top{flex-wrap:wrap;justify-content:flex-start}}

/* --- Polishing: arama scope + temizle --- */
.input{position:relative}
.q-scope{
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--card) 90%, var(--bg) 10%);
  color:var(--text);
  border-radius:10px;
  padding:8px 10px;
  font-size:12px;
  font-weight:700;
  max-width:140px;
}
.q-clear{
  border:0;
  background:transparent;
  color:var(--muted);
  cursor:pointer;
  font-size:16px;
  line-height:1;
  padding:6px 8px;
  border-radius:10px;
}
.q-clear:hover{ background: color-mix(in srgb, var(--card) 75%, var(--bg) 25%); color:var(--text); }

/* --- Polishing: GeliÅŸmiÅŸ menÃ¼sÃ¼ --- */
.menu{ position:relative; }
.menuPanel{
  position:absolute;
  right:0;
  top:46px;
  width:min(280px, 92vw);
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  box-shadow:var(--shadow);
  overflow:hidden;
  z-index:90;
}
.menuPanel .mi{
  padding:10px 12px;
  cursor:pointer;
  border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between;
  font-weight:700;
}
.menuPanel .mi:last-child{border-bottom:0}
.menuPanel .mi:hover{ background: color-mix(in srgb, var(--card) 78%, var(--bg) 22%); }
.menuPanel .mi small{ color:var(--muted); font-weight:600; }

/* Mobil: modal head sticky */
@media (max-width: 980px){
  .modalHead{ position:sticky; top:0; background:var(--card); z-index:2; }
}


/* --- Mobile polishing (layout fixes) --- */
@media (max-width: 760px){
  .top{flex-direction:column; align-items:flex-start; gap:10px; padding:10px 12px;}
  .brand h1{font-size:13px; line-height:1.25;}
  .actions{width:100%; flex-wrap:wrap; justify-content:flex-start; gap:8px; margin-left:0;}
  .pill{max-width:100%; width:100%;}
  .btn{padding:9px 10px; border-radius:12px;}
  .wrap{padding:12px;}
  .kpis{grid-template-columns:repeat(2,1fr);}
  .kpi{padding:14px 14px;}
}
/* Tabs: yatay kaydÄ±rma (mobil) */
@media (max-width: 980px){
  .nav{overflow-x:auto; -webkit-overflow-scrolling:touch; flex-wrap:nowrap; gap:8px; padding-bottom:10px;}
  .nav::-webkit-scrollbar{display:none;}
  .tab{white-space:nowrap;}
}
/* Mobile chart list visuals */
@media (max-width: 900px){
  .chipRow{border:1px solid color-mix(in srgb, var(--line) 75%, transparent); }
  .chipTitle{max-width:58vw;}
}

/* --- Mobile nav: scrollable & Intersection visible --- */
@media (max-width: 980px){
  .nav{overflow-x:auto; -webkit-overflow-scrolling:touch; flex-wrap:nowrap; gap:8px; padding-bottom:10px;}
  .nav::-webkit-scrollbar{display:none;}
  .tab{white-space:nowrap;}
  #tabIntersection{order:2;}
  #tabFiguran{order:3;}
  #tabCharts{order:4;}
  #tabDistribution{order:5;}
}
/* --- Overflow safety: no clipped text --- */
*{ overflow-wrap:anywhere; }
.name,.meta,.chip,.pill,.btn,.tab,.drawerTitle,.drawerSub,.miniItem b,.miniItem div{ word-break:break-word; }
.chip,.pill{ max-width:100%; white-space:normal; text-overflow:clip; }
.table{ display:block; width:100%; overflow-x:auto; }
.table th,.table td{ white-space:nowrap; }
@media (min-width: 981px){
  .table{ display:table; overflow:visible; }
  .table th,.table td{ white-space:normal; }
}
/* --- Arama kapsamÄ±: gÃ¶rÃ¼nÃ¼r kutucuk --- */
.qScopeBox{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border:1px solid var(--line);
  border-radius:12px;
  background: color-mix(in srgb, var(--card) 86%, var(--bg) 14%);
}
select.q-scope{
  border:0;
  background:transparent;
  padding:6px 6px;
  font-weight:900;
  font-size:13px;
  color:var(--text);
  outline:none;
  cursor:pointer;
}

/* input satÄ±rÄ±nda dÃ¼zgÃ¼n hizalama */
.filters .input{ gap:10px; flex-wrap:wrap; }
.filters .input input{ flex:1 1 220px; min-width:220px; }

/* Sadece mobilde Ek AraÃ§lar butonunu kaldÄ±r */

/* --- Kapsam seÃ§ici: label kalktÄ±, ok eklendi --- */
.qScopeBox{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background: color-mix(in srgb, var(--card) 86%, var(--bg) 14%);
}
.qScopeBox::after{
  content:"â–¾";
  font-weight:900;
  color:var(--muted);
  margin-left:2px;
}
select.q-scope{
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  border:0;
  background:transparent;
  padding:6px 0;
  font-weight:900;
  font-size:13px;
  color:var(--text);
  outline:none;
  cursor:pointer;
}


/* --- MasaÃ¼stÃ¼ sekme sÄ±rasÄ±: Grafikler 1, Panel 2 --- */
.nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
#tabCharts{order:1;}
#tabPanel{order:2;}
#tabDistribution{order:3;}
#tabIntersection{order:4;}
#tabFiguran{order:5;}
#advBtn{order:6;}


/* =========================
   v26 HOTFIX (SAFE)
   - Ek AraÃ§lar tamamen kaldÄ±r (CSS ile gizle, JS kÄ±rÄ±lmasÄ±n)
   - KesiÅŸim: tek satÄ±r + modern numara badge
   - Kapsam oku hizasÄ± iyileÅŸtir
   ========================= */

/* Ek AraÃ§lar: tamamen gizle */
#advBtn, #advMenu { display:none !important; }
.menu { display:none !important; } /* ek araÃ§lar menÃ¼sÃ¼ komple */

/* Kapsam seÃ§ici ok hizasÄ± (override) */
.qScopeBox{ position:relative; }
.qScopeBox::after{
  content:"â–¾";
  position:absolute; right:10px; top:50%;
  transform:translateY(-50%);
  pointer-events:none;
  font-weight:900;
  color:var(--muted);
}
select.q-scope{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  padding-right:28px !important;
}

/* KesiÅŸim: input satÄ±rÄ± tek satÄ±r */
#viewIntersection .filters .input{
  display:flex !important;
  align-items:center !important;
  gap:10px !important;
  flex-wrap:nowrap !important;
  white-space:nowrap;
}
#viewIntersection .filters .input select{
  min-width:0 !important;
  flex:1 1 auto !important;
}
.numBadge{
  width:26px;height:26px;display:grid;place-items:center;
  border-radius:10px;font-weight:900;font-size:13px;
  background: color-mix(in srgb, var(--accent) 10%, var(--card) 90%);
  border:1px solid color-mix(in srgb, var(--accent) 22%, var(--line) 78%);
  color: var(--accent);
  flex:0 0 auto;
}

/* =========================
   NOTIFICATIONS: CONTRAST FIX (v28)
   ========================= */
#notifBell{ position:relative; }
#notifBtn{
  display:inline-flex;
  align-items:center;
  gap:8px;
}
#notifBadge{
  min-width:20px;
  height:20px;
  padding:0 6px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  line-height:20px;
  color: var(--card);
  background: var(--bad);
}
#notifPanel{
  position:absolute;
  right:0;
  top:calc(100% + 10px);
  width:min(420px, calc(100vw - 24px));
  max-height:420px;
  overflow:auto;
  border:1px solid var(--line);
  border-radius:14px;
  background: var(--card);
  color: var(--text);
  box-shadow: var(--shadow);
  padding:10px;
  z-index:999;
}
.notifItem{
  border:1px solid color-mix(in srgb, var(--line) 70%, transparent 30%);
  border-radius:12px;
  padding:10px 12px;
  margin:8px 0;
  background: color-mix(in srgb, var(--card) 88%, var(--bg) 12%);
  color: var(--text);
}
.notifTop{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
  margin-bottom:6px;
}
.notifTop b{ color: var(--text); }
.notifTop .muted,
.notifItem .muted{
  color: var(--muted) !important;
  opacity:1 !important;
}
.notifItem div{ color: var(--text); }

/* dark theme: ensure panel stays dark but text stays light */
html[data-theme="dark"] #notifPanel{
  background: color-mix(in srgb, var(--card) 92%, #000 8%);
  border-color: color-mix(in srgb, var(--line) 70%, #000 30%);
}

/* =========================
   NOTIF BUBBLES THEME FIX (v30)
   Fix: dark theme had white text on light bubble background.
   ========================= */

/* Base (light) */
#notifPanel .notif-bubble{
  background: #ffffff !important;
  color: #0f172a !important;
}
#notifPanel .notif-title,
#notifPanel .notif-msg,
#notifPanel .notif-meta,
#notifPanel .notif-ts{
  color:#0f172a !important;
}
#notifPanel .notif-meta{ color:#334155 !important; opacity:1 !important; }
#notifPanel .notif-ts{ color:#64748b !important; opacity:1 !important; }
#notifPanel .notif-type{
  background: rgba(15,23,42,.06) !important;
}

/* Seen state: don't fade text; just soften bg */
#notifPanel .notif-bubble.seen{
  opacity:1 !important;
  background: #f8fafc !important;
  border-color: rgba(15,23,42,.08) !important;
}

/* Dark theme */
html[data-theme="dark"] #notifPanel{
  background: rgba(11,16,32,.96) !important;
  color:#f8fafc !important;
}
html[data-theme="dark"] #notifPanel .notif-bubble{
  background: rgba(30,41,59,.92) !important;
  border-color: rgba(148,163,184,.18) !important;
  color:#f8fafc !important;
}
html[data-theme="dark"] #notifPanel .notif-title,
html[data-theme="dark"] #notifPanel .notif-msg{
  color:#f8fafc !important;
}
html[data-theme="dark"] #notifPanel .notif-meta{
  color:#cbd5e1 !important;
  opacity:1 !important;
}
html[data-theme="dark"] #notifPanel .notif-ts{
  color:#94a3b8 !important;
  opacity:1 !important;
}
html[data-theme="dark"] #notifPanel .notif-type{
  background: rgba(255,255,255,.08) !important;
}
html[data-theme="dark"] #notifPanel .notif-bubble.seen{
  opacity:1 !important;
  background: rgba(30,41,59,.72) !important;
}

/* --- Panel sade: Liste "Oyunlar/KiÅŸiler" gÃ¶rÃ¼nÃ¼m toggle'Ä±nÄ± gizle --- */
#viewPanel .seg[title="GÃ¶rÃ¼nÃ¼m"]{ display:none !important; }

/* --- Arama kutusunu (Liste) desktop'ta biraz daralt --- */
@media (min-width: 981px){
  #viewPanel .filters .input{ max-width:460px; flex:0 1 460px; }
}

/* --- PDF indir: yazdÄ±rma gÃ¶rÃ¼nÃ¼mÃ¼ (Save as PDF) --- */
@media print{
  header, .nav, #tabbar, .actions, .pill, .notifPanel{ display:none !important; }
  body{ background:#fff !important; }
  .wrap{ max-width:none !important; padding:0 !important; }
  #viewPanel, #viewDistribution, #viewIntersection, #viewFiguran{ display:none !important; }
  #viewCharts{ display:block !important; }
  #chartDrawer{ display:none !important; }
  canvas{ border:0 !important; }
}


/* --- Mobile Tab Bar (thumb-driven) --- */
.tabbar{display:none;}
@media (max-width: 980px){
  body{ padding-bottom: 76px; }
  .nav{ display:none !important; }
  .tabbar{
    display:flex;
    position:fixed;
    left:12px; right:12px; bottom:12px;
    height:64px;
    border-radius:18px;
    border:1px solid color-mix(in srgb, var(--line) 70%, transparent 30%);
    background: color-mix(in srgb, var(--card) 92%, var(--bg) 8%);
    box-shadow: 0 16px 40px rgba(0,0,0,.18);
    overflow:hidden;
    z-index:9999;
    pointer-events:auto;
  }
  .tabbar .tb{
    flex:1;
    border:0;
    background:transparent;
    color:var(--muted);
    cursor:pointer;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:2px;
  }
  .tabbar .tb .ico{ font-size:20px; line-height:1; }
  .tabbar .tb .lbl{ font-size:11px; font-weight:800; letter-spacing:.2px; }
  .tabbar .tb.active{
    color:var(--text);
    background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 12%, transparent), transparent);
  }
}

/* --- Mobile: Liste yatay kaydÄ±rma (kart carousel) --- */
@media (max-width: 980px){
  #list{
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:visible;
}
  #list .item{
    min-width: 78vw;
    max-width: 78vw;
    scroll-snap-align:start;
  }
  /* Detay kartÄ± Ã¼stte kalsÄ±n, yatay listede seÃ§im rahat */
  .split{ grid-template-columns: 1fr !important; }
}


/* ----- Smooth theme transitions ----- */
body, .card, .item, .panel, .top, header, .btn, .tabs button, .tabbar button{
  transition: background-color .3s ease, color .3s ease, border-color .3s ease, box-shadow .3s ease;
}

/* ----- Mobile: table -> stacked cards (requires td[data-label]) ----- */
@media (max-width: 768px){
  .table, .table thead, .table tbody, .table th, .table td, .table tr{ display:block; }
  .table thead tr{ position:absolute; top:-9999px; left:-9999px; }
  .table tbody tr{
    border:1px solid var(--line);
    margin-bottom:12px;
    border-radius:var(--r2);
    padding:10px;
    background:var(--card);
  }
  .table tbody td{
    border:none;
    position:relative;
    padding:8px 0 8px 50%;
    text-align:right;
    white-space:normal;
  }
  .table tbody td:before{
    content: attr(data-label);
    position:absolute;
    left:10px;
    width:45%;
    text-align:left;
    font-weight:800;
    color:var(--muted);
  }
}

/* ----- Notifications: mobile safe + click-outside close ----- */
.backdrop{
  position:fixed; inset:0;
  background:rgba(0,0,0,.35);
  z-index:79;
}
@media (max-width: 768px){
  .notifPanel{
    position:fixed !important;
    left:10px; right:10px;
    top:78px;
    bottom:88px;
    width:auto !important;
    max-height:none !important;
    overflow:auto;
  }
}


/* --- Mobile touch + notifications + inline accordion --- */
#notifBackdrop.hidden{display:none;}
#notifBackdrop{position:fixed;inset:0;z-index:998;background:transparent;}
@media (max-width: 980px){
  .tabbar .tb{ touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
  #notifPanel{
    position:fixed;
    left:12px; right:12px;
    top:112px; bottom:92px;
    width:auto;
    max-height:none;
    z-index:9999;
  }
}
/* inline accordion panel under cards */
.inlinePanel{
  margin-top:10px;
  border:1px solid color-mix(in srgb, var(--line) 70%, transparent 30%);
  border-radius:14px;
  background: color-mix(in srgb, var(--card) 92%, var(--bg) 8%);
  overflow:hidden;
}
.inlineHead{
  padding:10px 12px;
  font-weight:900;
  border-bottom:1px solid color-mix(in srgb, var(--line) 70%, transparent 30%);
}
.inlineTableWrap{ overflow:auto; -webkit-overflow-scrolling:touch; }
.inlineTable{ min-width: 520px; }
/* Figuran table: stack gÃ¶rÃ¼nÃ¼mÃ¼nde daha dÃ¼zenli */
@media (max-width: 768px){
  #viewFiguran td{
    padding-left: 0 !important;
    text-align: left !important;
  }
  #viewFiguran td:before{
    position: static !important;
    display: block !important;
    width: auto !important;
    margin: 0 0 2px 0 !important;
    font-size: 11px !important;
    color: var(--muted) !important;
  }
  #viewFiguran tr{
    padding: 12px !important;
  }
}

/* Mobile tap reliability */
#tabbar .tb{touch-action:manipulation;}
button, a{touch-action:manipulation;}

/* Modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9998; }
.modal{ position:fixed; inset: 10vh 6vw auto 6vw; max-height:80vh; z-index:9999; background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 18px 60px rgba(0,0,0,.35); padding:14px; overflow:hidden; }
.modal-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:10px; }
.modal-title{ font-weight:800; font-size:16px; }
.modal-sub{ color:var(--muted); font-size:12px; margin-top:2px; }
.modal-text{ width:100%; height:44vh; min-height:220px; border-radius:12px; border:1px solid var(--line); background:transparent; color:var(--text); padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
.modal-foot{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }
@media (min-width: 900px){
  .modal{ inset: 12vh 22vw auto 22vw; }
}
</style>
</head>
<body>
<header>
<div class="top">
<div class="brand">
<div class="logo">IDT</div>
<div>
<h1>Ä°DT PANEL | <small style="font-weight:700;opacity:.85">SANAT TEKNÄ°K BÃœROSU</small></h1>
</div>
</div>
<div class="actions">
<button class="btn" id="themeBtn" title="AydÄ±nlÄ±k/KaranlÄ±k">ğŸŒ“ Tema</button>
<span class="pill" id="status">â³ YÃ¼kleniyorâ€¦</span>
<button class="btn" id="reloadBtn">â†» Yenile</button>
<div class="menu">
<button class="btn" id="advBtn" title="Ek AraÃ§lar">ğŸ§° Ek AraÃ§lar</button>
<div aria-label="Ek AraÃ§lar" class="menuPanel hidden" id="advMenu" role="menu">
<div class="mi" id="advDist">ğŸ“Š DaÄŸÄ±lÄ±m <small>Oyunlara gÃ¶re</small></div>
<div class="mi" id="advInter">ğŸ§© KesiÅŸim <small>2 oyun</small></div>
</div>
</div>
<div class="notif">
<button class="btn" id="notifBtn" title="Bildirimler (LOG)">
          ğŸ”” Bildirimler <span class="badge hidden" id="notifCount">0</span>
</button>
<div class="hidden" id="notifBackdrop"></div>
<div aria-label="Bildirimler" class="notifPanel hidden" id="notifPanel" role="dialog">
<div class="notifHd">
<div>
<b>Bildirimler</b>
<div class="small">Kaynak: BÄ°LDÄ°RÄ°MLER (Google Sheets)</div>
</div>
<div class="row" style="gap:8px">
<button class="btn" id="notifRefresh">â†»</button>
<button class="btn" id="notifClose">âœ•</button>
</div>
</div>
<div class="notifBd" id="notifList">
<div class="empty">LOG okunuyorâ€¦</div>
</div>
</div>
</div>
<div aria-hidden="true" class="backdrop hidden" id="notifBackdrop"></div>
<a class="btn primary" href="#" id="sheetBtn" rel="noreferrer" target="_blank">ğŸ“„ Google Sheetâ€™i AÃ§</a>
</div>
</div>
<div class="nav">
<button class="tab active" id="tabPanel">Panel</button>
<button class="tab" id="tabDistribution">Oyunlara GÃ¶re Personel DaÄŸÄ±lÄ±mÄ±</button>
<button class="tab" id="tabIntersection">KesiÅŸim Analizi</button>
<button class="tab" id="tabFiguran">FigÃ¼ranlar</button>
<button class="tab" id="tabCharts">Grafikler</button>
</div>
</header>
<div class="wrap">
<div class="kpis" id="kpis">
<div aria-label="Oyun listesine git" class="kpi soft1" data-go="Panel" data-mode="plays" role="button" tabindex="0"><div><div class="label">Aktif Oyun</div><div class="value" id="kpiPlays">-</div></div><div class="icon">ğŸ­</div></div>
<div aria-label="KiÅŸi listesine git" class="kpi soft2" data-go="Panel" data-mode="people" role="button" tabindex="0"><div><div class="label">Toplam Personel</div><div class="value" id="kpiPeople">-</div></div><div class="icon">ğŸ‘¥</div></div>
<div aria-label="Panele git" class="kpi soft3" data-go="Panel" data-mode="rows" role="button" tabindex="0"><div><div class="label">GÃ¶rev AtamasÄ±</div><div class="value" id="kpiRows">-</div></div><div class="icon">ğŸ§¾</div></div>
<div aria-label="FigÃ¼ran listesine git" class="kpi soft4" data-go="Figuran" data-mode="figuran" role="button" tabindex="0"><div><div class="label">FigÃ¼ran</div><div class="value" id="kpiFiguran">-</div></div><div class="icon">ğŸŸï¸</div></div>
</div>
<!-- PANEL -->
<section id="viewPanel">
<div class="card">
<div class="hd">
<h2>Liste</h2>
<div class="filters">
<div class="input" title="Ara">
            ğŸ” <input autocomplete="off" id="q" placeholder="Oyun / kiÅŸi / gÃ¶rev araâ€¦" type="search"/>
<div class="qScopeBox"><select class="q-scope" id="qScope" title="Arama kapsamÄ±">
<option value="all">TÃ¼mÃ¼</option>
<option value="play">Oyun</option>
<option value="person">KiÅŸi</option>
<option value="role">GÃ¶rev</option>
</select></div>
<button class="q-clear" id="qClear" title="Temizle">âœ•</button>
</div>
<div class="seg" title="GÃ¶rÃ¼nÃ¼m">
<button class="active" id="btnPlays">ğŸ­ Oyunlar</button>
<button id="btnPeople">ğŸ‘¥ KiÅŸiler</button>
</div>
<button class="btn" id="clearBtn">Temizle</button>
</div>
</div>
<div class="bd">
<div class="grid">
<div>
<div class="list" id="list"></div>
<div class="small" id="hint" style="margin-top:10px"></div>
</div>
<div class="card" style="box-shadow:none">
<div class="hd">
<h2>Detay</h2>
<button class="btn" id="copyBtn">ğŸ“‹ Kopyala (Excel)</button>
</div>
<div class="bd" id="details">
<div class="empty">Soldan bir oyun veya kiÅŸi seÃ§.</div>
</div>
<footer>
<div><b>CanlÄ±:</b> Sheetâ€™te yaptÄ±ÄŸÄ±n deÄŸiÅŸiklikler <b>yenileyince</b> gelir.</div>
<div style="margin-top:6px"><b>PaylaÅŸÄ±m:</b> Sheet â†’ PaylaÅŸ â†’ <code>BaÄŸlantÄ±ya sahip herkes: GÃ¶rÃ¼ntÃ¼leyebilir</code></div>
</footer>
</div>
</div>
</div>
</div>
</section>
<!-- OYUNLARA GÃ–RE PERSONEL DAÄILIMI -->
<section id="viewDistribution" style="display:none">
<div class="card">
<div class="hd">
<h2>Oyunlara GÃ¶re Personel DaÄŸÄ±lÄ±mÄ±</h2>
<div class="small">AynÄ± personelin birden fazla oyunda yer almasÄ± â€œdaÄŸÄ±lÄ±m yoÄŸunluÄŸuâ€ olarak listelenir.</div>
</div>
<div class="bd">
<div class="filters" style="margin-bottom:10px">
<div class="input" title="Ara">
            ğŸ” <input autocomplete="off" id="dq" placeholder="KiÅŸi veya oyun araâ€¦" type="search"/>
</div>
<button class="btn" id="dCopy">ğŸ“‹ Excel'e Kopyala</button>
<button class="btn" id="dClear">Temizle</button>
</div>
<div id="distributionBox"></div>
</div>
</div>
</section>
<!-- KESÄ°ÅÄ°M -->
<section id="viewIntersection" style="display:none">
<div class="card">
<div class="hd">
<h2>KesiÅŸim Analizi</h2>
<div class="small">Ä°ki oyunu seÃ§ â€” ortak personeli ve gÃ¶revlerini gÃ¶sterir.</div>
</div>
<div class="bd">
<div class="filters" style="margin-bottom:10px">
<div class="input" title="1. Oyun">
            1ï¸âƒ£
            <select id="p1"></select>
</div>
<div class="input" title="2. Oyun">
            2ï¸âƒ£
            <select id="p2"></select>
</div>
<button class="btn" id="swapBtn">â‡„ DeÄŸiÅŸtir</button>
</div>
<div id="intersectionBox"></div>
</div>
<footer>
        Not: KesiÅŸim iÃ§in kiÅŸi hÃ¼cresindeki â€œvirgÃ¼l / ve / / / satÄ±r sonuâ€ ayrÄ±mlarÄ± otomatik yapÄ±lÄ±r.
      </footer>
</div>
</section>
<!-- FÄ°GÃœRAN -->
<section id="viewFiguran" style="display:none">
<div class="card">
<div class="hd">
<h2>FigÃ¼ranlar</h2>
<div class="small">Apps Script mantÄ±ÄŸÄ±yla: Ã§oklu kiÅŸi varsa sadece <code>(FigÃ¼ran)</code> etiketi olanlar alÄ±nÄ±r.</div>
</div>
<div class="bd">
<div class="filters" style="margin-bottom:10px">
<div class="input" title="Ara">
            ğŸ” <input autocomplete="off" id="fq" placeholder="FigÃ¼ran / oyun araâ€¦" type="search"/>
</div>
<button class="btn" id="figDownloadAllBtn">ğŸ“‹ Excelâ€™e Kopyala (TÃ¼mÃ¼)</button>
<button class="btn" id="fClear">Temizle</button>
</div>
<div id="figuranBox"></div>
</div>
</div>
</section>
<!-- GRAFÄ°KLER -->
<section id="viewCharts" style="display:none">
<div class="chartsNav">
<button class="tab active" id="chartTabRoles">GÃ¶revlere GÃ¶re DaÄŸÄ±lÄ±m</button>
<button class="tab" id="chartTabCats">Kategori DaÄŸÄ±lÄ±mÄ±</button>
</div>
<div class="grid" style="grid-template-columns: 1.1fr .9fr">
<div class="card">
<div class="hd">
<h2 id="chartTitle">GÃ¶revlere GÃ¶re DaÄŸÄ±lÄ±m</h2>
<div class="small" id="chartHint">Ä°pucu: grafik dilimine/bara tÄ±kla â†’ saÄŸda liste aÃ§Ä±lÄ±r.</div><div style="margin-left:auto;display:flex;gap:8px;align-items:center"><button class="btn" id="chartDownloadBtn" title="GrafiÄŸi PDF olarak indir">ğŸ§¾ PDF indir</button></div>
</div>
<div class="bd">
<canvas height="340" id="chartMain" width="900"></canvas>
<div class="mobileChartWrap">
<div class="small" style="margin:10px 0 6px">Mobil ipucu: kategoriye dokun â†’ detay listesi aÃ§Ä±lÄ±r.</div>
<div class="mobileChartList" id="chartMobileList"></div>
</div>
</div>
</div>
<aside class="drawer hidden" id="chartDrawer">
<div class="hd">
<div>
<div class="drawerTitle" id="drawerTitle">SeÃ§im</div>
<div class="drawerSub" id="drawerSub">â€”</div>
</div>
<div style="display:flex;gap:8px;align-items:center">
<button class="btn" id="drawerCopyAll" style="display:none" title="Excel'e Kopyala (Ã–zet)">Excelâ€™e Kopyala (Ã–zet)</button>
<button class="btn" id="drawerCopyVisible" style="display:none" title="Excel'e Kopyala (GÃ¶rÃ¼nen)">Excelâ€™e Kopyala (GÃ¶rÃ¼nen)</button>
<button class="btn" id="drawerCopyExpanded" style="display:none" title="Excel'e Kopyala (SatÄ±r SatÄ±r)">Excelâ€™e Kopyala (SatÄ±r SatÄ±r)</button>
<button class="btn" id="drawerBack" style="display:none" title="Geri">â†</button>
<button class="btn" id="drawerClose">âœ•</button>
</div>
</div>
<div class="bd">
<div class="input" style="min-width:unset" title="Ara">
            ğŸ” <input autocomplete="off" id="drawerSearch" placeholder="Ä°sim / oyun araâ€¦" type="search"/>
</div>
<div class="miniList" id="drawerList"></div>
</div>
</aside>
</div>
</section>
<!-- Ä°STATÄ°STÄ°KLER -->
</div>
<script>

const CONFIG = {
  SPREADSHEET_ID: "1sIzswZnMkyRPJejAsE_ylSKzAF0RmFiACP4jYtz-AE0",
  API_BASE: "https://script.google.com/macros/s/AKfycbz-Td3cnbMkGRVW4kFXvlvD58O6yygQ-U2aJ7vHSkxAFrAsR5j7QhMFt0xrGg4gZQLb/exec",
  NOTIF_API_BASE: "https://script.google.com/macros/s/AKfycbx-Q5P-dF5EB3GGCSHMUFV3din4OEYHhvSeGSZZjmSj7fN4_XtEL4h9E55XFy0-tL8V/exec",
  SHEET_MAIN: "BÃœTÃœN OYUNLAR",
  SHEET_FIGURAN: "FÄ°GÃœRAN LÄ°STESÄ°",
  SHEET_NOTIFS: "BÄ°LDÄ°RÄ°MLER",


  // Ana veri (genelde: "BÃœTÃœN OYUNLAR")
  GID: "1233566992",

  // Apps Script'in oluÅŸturduÄŸu LOG sayfasÄ±nÄ±n gid'sini buraya yaz (URL'den kopyala: ...?gid=XXXX)
  LOG_GID: "",

  sheetUrl(gid=this.GID){ return `https://docs.google.com/spreadsheets/d/${this.SPREADSHEET_ID}/edit?gid=${gid}`; },
  gvizUrl(gid=this.GID){ return `https://docs.google.com/spreadsheets/d/${this.SPREADSHEET_ID}/gviz/tq?gid=${gid}&tqx=out:json&_=${Date.now()}`; },
  csvUrl(gid=this.GID){  return `https://docs.google.com/spreadsheets/d/${this.SPREADSHEET_ID}/export?format=csv&gid=${gid}&_=${Date.now()}`; },
};
/* ---------- cache (5dk) ---------- */
const CACHE_MAIN_KEY = "idt_data_cache_v1";
function cacheGet(key){
  try{ const raw = localStorage.getItem(key); return raw? JSON.parse(raw): null; }catch(e){ return null; }
}
function cacheSet(key, data){
  try{ localStorage.setItem(key, JSON.stringify({timestamp: Date.now(), data})); }catch(e){}
}
function cacheFresh(entry, maxAgeMs){
  return entry && entry.timestamp && (Date.now() - entry.timestamp) < maxAgeMs && entry.data;
}


function isMobile(){
  return window.matchMedia && window.matchMedia("(max-width: 980px)").matches;
}

// --- Fuzzy search (mobile-friendly) ---
function isSubsequence(hay, needle){
  let i=0,j=0;
  while(i<hay.length && j<needle.length){
    if(hay[i]===needle[j]) j++;
    i++;
  }
  return j===needle.length;
}
function levenshtein(a,b){
  a=String(a); b=String(b);
  const m=a.length, n=b.length;
  if(!m) return n;
  if(!n) return m;
  const dp = Array(n+1);
  for(let j=0;j<=n;j++) dp[j]=j;
  for(let i=1;i<=m;i++){
    let prev=dp[0]; dp[0]=i;
    for(let j=1;j<=n;j++){
      const tmp=dp[j];
      const cost = a[i-1]===b[j-1] ? 0 : 1;
      dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev+cost);
      prev=tmp;
    }
  }
  return dp[n];
}
function fuzzyTokenMatch(hay, tok){
  if(!tok) return true;
  if(hay.includes(tok)) return true;
  if(tok.length>=3 && isSubsequence(hay, tok)) return true;
  if(tok.length<=6 && hay.length<=80){
    const words = hay.split(/\s+/g).slice(0,40);
    for(const w of words){
      if(Math.abs(w.length - tok.length) <= 2 && levenshtein(w, tok) <= 1) return true;
    }
  }
  return false;
}
function fuzzyMatch(hay, q){
  const query = (q||"").trim().toLowerCase();
  if(!query) return true;
  const h = (hay||"").toLowerCase();
  const toks = query.split(/\s+/g).filter(Boolean);
  return toks.every(t=>fuzzyTokenMatch(h, t));
}

// Filtre eÅŸleÅŸmeleri: boÅŸluk / bÃ¼yÃ¼k-kÃ¼Ã§Ã¼k harf / gÃ¶rÃ¼nmez karakter farklarÄ±nÄ± tolere et
function normKey(s){
  return String(s||"")
    .trim()
    .toLowerCase()
    .normalize("NFKC")
    .replace(/\s+/g, " ");
}

function openMobileModal(html){
  if(!isMobile()) return;
  els.mobileContent.innerHTML = html;
  els.mobileOverlay.classList.remove("hidden");
  els.mobileModal.classList.remove("hidden");
  els.mobileOverlay.setAttribute("aria-hidden","false");
  document.body.style.overflow="hidden";
}
function closeMobileModal(){
  els.mobileOverlay.classList.add("hidden");
  els.mobileModal.classList.add("hidden");
  els.mobileOverlay.setAttribute("aria-hidden","true");
  document.body.style.overflow="";
}

const el = (id)=>document.getElementById(id);
\1

// --- Copy Modal helpers (manual TSV) ---
const copyEls = {
  backdrop: document.getElementById("copyModalBackdrop"),
  modal: document.getElementById("copyModal"),
  close: document.getElementById("copyModalClose"),
  text: document.getElementById("copyModalText"),
  select: document.getElementById("copyModalSelect"),
  copy: document.getElementById("copyModalCopy"),
};
function openCopyModal(tsv){
  if(!copyEls.modal) return;
  copyEls.text.value = tsv || "";
  copyEls.backdrop.classList.remove("hidden");
  copyEls.modal.classList.remove("hidden");
  copyEls.backdrop.setAttribute("aria-hidden","false");
  document.body.style.overflow="hidden";
  // auto select for convenience
  setTimeout(()=>{ copyEls.text.focus(); copyEls.text.select(); }, 50);
}
function closeCopyModal(){
  if(!copyEls.modal) return;
  copyEls.backdrop.classList.add("hidden");
  copyEls.modal.classList.add("hidden");
  copyEls.backdrop.setAttribute("aria-hidden","true");
  document.body.style.overflow="";
}
if(copyEls.close){
  copyEls.close.addEventListener("click", closeCopyModal);
  copyEls.backdrop.addEventListener("click", closeCopyModal);
  copyEls.select.addEventListener("click", ()=>{ copyEls.text.focus(); copyEls.text.select(); });
  copyEls.copy.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(copyEls.text.value);
      toast("Panoya kopyalandÄ±!");
      closeCopyModal();
    }catch(e){
      // keep modal open; user can manual copy
      toast("Manuel kopyala: metni seÃ§ â†’ Kopyala");
    }
  });
}
// --- end copy modal ---

els.sheetBtn.href = CONFIG.sheetUrl();

let rawRows = [];
let rows = [];
let plays = [];
let people = [];
let roles = [];
let playsList = [];
let activeMode = "plays";
let showAssignments = false; // KPI "GÃ¶rev AtamasÄ±" gÃ¶rÃ¼nÃ¼mÃ¼
let activeId = null;
let selectedItem = null;

let distribution = [];
let figuran = [];
let retiredSet = new Set();
let activePlayFilter = null; // mobilde: oyundan kiÅŸilere geÃ§ince filtre

let chartMode = "roles"; // roles | cats
let chartHits = []; // clickable regions
let drawerData = [];

/* ---------- Theme toggle ---------- */
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("idt_theme", theme);
}
(function initTheme(){
  const saved = localStorage.getItem("idt_theme");
  if(saved === "dark" || saved === "light") applyTheme(saved);
  else applyTheme(window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
})();
els.themeBtn.addEventListener("click", ()=>{
  const cur = document.documentElement.getAttribute("data-theme") || "light";
  applyTheme(cur === "dark" ? "light" : "dark");
  if(rows.length && els.viewCharts.style.display!=="none"){ drawChart(); }
});


/* ---------- Mobile Tab Bar ---------- */
function setTabbarActive(tabName){
  const bar = document.getElementById("tabbar");
  if(!bar) return;
  bar.querySelectorAll(".tb").forEach(b=>b.classList.toggle("active", b.getAttribute("data-tab")===tabName));
}
function initTabbar(){
  const bar = document.getElementById("tabbar");
  if(!bar) return;

  const go = (t)=>{
    if(t==="Panel") els.tabPanel && els.tabPanel.click();
    else if(t==="Analiz") els.tabIntersection && els.tabIntersection.click();
    else if(t==="Figuran") els.tabFiguran && els.tabFiguran.click();
    else if(t==="Grafikler") els.tabCharts && els.tabCharts.click();
  };

  const bind = (btn)=>{
    const t = btn.getAttribute("data-tab");
    const handler = (e)=>{ e.stopPropagation(); go(t); setTabbarActive(t); };
    btn.addEventListener("click", handler);
    btn.addEventListener("pointerup", handler);
  };

  bar.querySelectorAll(".tb").forEach(bind);
}
/* ---------- helpers ---------- */
function setStatus(text, tone="") {
  els.status.textContent = text;
  els.status.style.borderColor = "";
  els.status.style.background = "";
  els.status.style.color = "var(--muted)";
  if (tone === "ok") {
    els.status.style.borderColor = "color-mix(in srgb, var(--good) 25%, var(--line) 75%)";
    els.status.style.background = "color-mix(in srgb, var(--good) 10%, var(--card) 90%)";
    els.status.style.color = "var(--good)";
  } else if (tone === "bad") {
    els.status.style.borderColor = "color-mix(in srgb, var(--bad) 25%, var(--line) 75%)";
    els.status.style.background = "color-mix(in srgb, var(--bad) 10%, var(--card) 90%)";
    els.status.style.color = "var(--bad)";
  } else if (tone === "warn") {
    els.status.style.borderColor = "color-mix(in srgb, var(--warn) 25%, var(--line) 75%)";
    els.status.style.background = "color-mix(in srgb, var(--warn) 10%, var(--card) 90%)";
    els.status.style.color = "var(--warn)";
  } else {
    els.status.style.borderColor = "var(--line)";
    els.status.style.background = "var(--card)";
  }
}
function escapeHtml(s) {
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function personTag(name){
  const n=(name||"").toString().trim();
  return (n && retiredSet && retiredSet.has(n)) ? `<span class="tag retired">Kurumdan Emekli SanatÃ§Ä±</span>` : "";
}

function normalizeHeader(h){ return (h||"").trim().toLowerCase().replace(/\s+/g," "); }
function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

/* ---------- load from Google ---------- */
function parseGviz(text){
  const m = text.match(/setResponse\((.*)\);?\s*$/s);
  if(!m) throw new Error("GViz formatÄ± okunamadÄ±.");
  return JSON.parse(m[1]);
}
function buildFromGviz(obj){
  const table = obj?.table;
  const cols = (table?.cols||[]).map(c=>(c.label||"").trim());
  const dataRows = (table?.rows||[]).map(r=>(r.c||[]).map(cell => (cell?.v ?? "")));

  const hn = cols.map(normalizeHeader);
  const need = ["oyun adÄ±","kategori","gÃ¶rev","kiÅŸi"];
  if(!need.every(n=>hn.includes(n))) throw new Error("BaÅŸlÄ±klar farklÄ±: Oyun AdÄ± / Kategori / GÃ¶rev / KiÅŸi");

  const idx = { play: hn.indexOf("oyun adÄ±"), cat: hn.indexOf("kategori"), role: hn.indexOf("gÃ¶rev"), person: hn.indexOf("kiÅŸi") };
  const out=[];
  for(const r of dataRows){
    const play=(r[idx.play]??"").toString().trim();
    const category=(r[idx.cat]??"").toString().trim();
    const role=(r[idx.role]??"").toString().trim();
    const person=(r[idx.person]??"").toString().trim();
    if(!play && !person && !role && !category) continue;
    if(!play) continue;
    out.push({play, category, role, person});
  }
  return out;
}
function csvToRows(csvText){
  const rows=[]; let cur="", inQ=false; let row=[];
  for(let i=0;i<csvText.length;i++){
    const ch=csvText[i], next=csvText[i+1];
    if(ch === '"' && inQ && next === '"'){ cur+='"'; i++; }
    else if(ch === '"'){ inQ=!inQ; }
    else if(ch === ',' && !inQ){ row.push(cur); cur=""; }
    else if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && next === '\n') i++;
      row.push(cur); cur="";
      if(row.some(v=>v!=="")) rows.push(row);
      row=[];
    } else cur+=ch;
  }
  row.push(cur);
  if(row.some(v=>v!=="")) rows.push(row);
  return rows;
}
function buildFromCsv(raw){
  const need=["oyun adÄ±","kategori","gÃ¶rev","kiÅŸi"];
  let headerIdx=-1;
  for(let i=0;i<Math.min(raw.length,30);i++){
    const hdr=raw[i].map(normalizeHeader);
    if(need.every(n=>hdr.includes(n))){ headerIdx=i; break; }
  }
  if(headerIdx===-1) throw new Error("BaÅŸlÄ±k satÄ±rÄ± bulunamadÄ±. (CSV)");
  const header=raw[headerIdx].map(x=>(x||"").trim());
  const hn=header.map(normalizeHeader);
  const idx={ play: hn.indexOf("oyun adÄ±"), cat: hn.indexOf("kategori"), role: hn.indexOf("gÃ¶rev"), person: hn.indexOf("kiÅŸi") };

  const out=[];
  for(let i=headerIdx+1;i<raw.length;i++){
    const r=raw[i];
    const play=(r[idx.play]||"").trim();
    const category=(r[idx.cat]||"").trim();
    const role=(r[idx.role]||"").trim();
    const person=(r[idx.person]||"").trim();
    if(!play && !person && !role && !category) continue;
    if(!play) continue;
    out.push({play, category, role, person});
  }
  return out;
}

function jsonp(url, timeoutMs=20000){
  return new Promise((resolve, reject)=>{
    const cb = "idt_cb_" + Math.random().toString(36).slice(2);
    const s = document.createElement("script");
    let done=false;
    const t = setTimeout(()=>{
      if(done) return;
      done=true;
      cleanup();
      reject(new Error("JSONP zaman aÅŸÄ±mÄ±"));
    }, timeoutMs);

    function cleanup(){
      clearTimeout(t);
      try{ delete window[cb]; }catch{}
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb] = (data)=>{
      if(done) return;
      done=true;
      cleanup();
      resolve(data);
    };

    const sep = url.includes("?") ? "&" : "?";
    s.src = url + sep + "callback=" + cb + "&_=" + Date.now();
    s.onerror = ()=>{
      if(done) return;
      done=true;
      cleanup();
      reject(new Error("JSONP yÃ¼klenemedi"));
    };
    document.body.appendChild(s);
  });
}

async function tryLoadApiJsonp(){
  if(!CONFIG.API_BASE) throw new Error("API_BASE tanÄ±mlÄ± deÄŸil");
  const url = `${CONFIG.API_BASE}?sheet=${encodeURIComponent(CONFIG.SHEET_MAIN)}`;
  const data = await jsonp(url);
  if(!data || data.ok !== true || !Array.isArray(data.rows)) throw new Error("API veri formatÄ± beklenmedik");
  // API -> ham satÄ±rlar
  return data.rows.map(r=>({
    play: String(r["Oyun AdÄ±"] ?? r["Oyun Adi"] ?? r["Oyun"] ?? "").trim(),
    category: String(r["Kategori"] ?? "").trim(),
    role: String(r["GÃ¶rev"] ?? r["Gorev"] ?? "").trim(),
    person: String(r["KiÅŸi"] ?? r["Kisi"] ?? "").trim(),
  })).filter(x=>x.play && x.person);
}

async function tryLoadGviz(){
  const res = await fetch(CONFIG.gvizUrl(), {cache:"no-store"});
  if(!res.ok) throw new Error(`GViz indirilemedi (${res.status}).`);
  const txt = await res.text();
  return buildFromGviz(parseGviz(txt));
}
async function tryLoadCsv(){
  const res = await fetch(CONFIG.csvUrl(), {cache:"no-store"});
  if(!res.ok) throw new Error(`CSV indirilemedi (${res.status}).`);
  const csv = await res.text();
  return buildFromCsv(csvToRows(csv));
}

/* ---------- split general ---------- */
function splitPeopleGeneral(cell){
  const s = (cell||"").toString().trim();
  if(!s) return [];
  const normalized = s
    .replace(/\r?\n/g, " | ")
    .replace(/;/g, " | ")
    .replace(/\s*\/\s*/g, " | ")
    .replace(/\s*,\s*/g, " | ")
    .replace(/\s+\bve\b\s+/gi, " | ");
  const parts = normalized.split("|").map(x=>x.trim()).filter(Boolean);
  const uniq=[]; const seen=new Set();
  for(const p of parts){
    const key=p.toLowerCase();
    if(!seen.has(key)){ seen.add(key); uniq.push(p); }
  }
  return uniq.length ? uniq : [s];
}
function expandRowsByPeople(data){
  const out=[];
  for(const r of data){
    const people = splitPeopleGeneral(r.person);
    if(!people.length){ out.push({...r, person:""}); continue; }
    for(const p of people){ out.push({...r, person:p}); }
  }
  return out;
}

/* ---------- Apps Script compatible figuran extraction ---------- */
function splitPeopleTokensApps(text){
  const cleaned = (text||"").toString().replace(/\r/g, "\n").trim();
  return cleaned.split(/[\n,;]+/g).map(s=>s.trim()).filter(Boolean);
}
function hasFiguranTag(token){
  return /\(\s*fig[Ã¼u]ran\s*\)/i.test((token||"").toString());
}
function stripFiguranTag(token){
  return (token||"").toString().replace(/\(\s*fig[Ã¼u]ran\s*\)/ig, "").replace(/^"+|"+$/g, "").trim();
}
function computeRetiredSetFromRaw(){
  const set = new Set();
  for(const r of rawRows){
    const kategoriRaw = (r.category||"").trim().toLowerCase();
    if(/kurumdan\s*emekl/i.test(kategoriRaw) && r.person){
      const tokens = splitPeopleTokensApps((r.person||"").trim());
      for(const t of tokens){
        const name = stripFiguranTag(t);
        if(name) set.add(name);
      }
    }
  }
  return set;
}

function computeFiguranFromRaw(){
  // Apps Script ile aynÄ± mantÄ±k:
  // - Kategori "Kurumdan Emekli SanatÃ§Ä±" ise: kiÅŸi(ler)i direkt al
  // - Kategori figÃ¼ran ise:
  //   - tek kiÅŸi: al
  //   - Ã§ok kiÅŸi: sadece (FigÃ¼ran) etiketlileri al
  const map = new Map();

  for(const r of rawRows){
    const oyun = (r.play||"").trim();
    const kategoriRaw = (r.category||"").trim();
    const gorevRaw = (r.role||"").trim();
    const kisiRaw = (r.person||"").trim();
    if(!kisiRaw) continue;

    const kategoriLower = kategoriRaw.toLowerCase();
    const isRetiredArtist = /kurumdan\s*emekl/i.test(kategoriLower);
    const isFiguranCategory = /fig[Ã¼u]ran/i.test(kategoriLower);
    if(!isRetiredArtist && !isFiguranCategory) continue;

    const tokens = splitPeopleTokensApps(kisiRaw);
    if(!tokens.length) continue;

    let selectedPeople = [];
    if(isRetiredArtist){
      selectedPeople = tokens.map(stripFiguranTag).filter(Boolean);
    }else{
      if(tokens.length === 1){
        selectedPeople = [stripFiguranTag(tokens[0])].filter(Boolean);
      }else{
        selectedPeople = tokens.filter(hasFiguranTag).map(stripFiguranTag).filter(Boolean);
      }
    }
    if(!selectedPeople.length) continue;

    for(const kisi of selectedPeople){
      if(!map.has(kisi)) map.set(kisi, {games:new Set(), roles:new Set(), cats:new Set(), rows:0});
      const obj = map.get(kisi);
      obj.cats.add(isRetiredArtist ? "Kurumdan Emekli SanatÃ§Ä±" : "FigÃ¼ran");
      if(oyun) obj.games.add(oyun);
      if(gorevRaw) obj.roles.add(gorevRaw);
      obj.rows += 1;
    }
  }

  const out = [...map.entries()].map(([person, obj])=>({
    person,
    cats:[...obj.cats].sort((a,b)=>a.localeCompare(b,"tr")),
    plays:[...obj.games].sort((a,b)=>a.localeCompare(b,"tr")),
    roles:[...obj.roles].sort((a,b)=>a.localeCompare(b,"tr")),
    rows: obj.rows
  }));
  out.sort((a,b)=>a.person.localeCompare(b.person,"tr"));
  return out;
}


/* ---------- notifications (LOG) ---------- */
function parseLogFromGviz(obj){
  const table = obj?.table;
  const cols = (table?.cols||[]).map(c=>(c.label||"").trim());
  const dataRows = (table?.rows||[]).map(r=>(r.c||[]).map(cell => (cell?.v ?? "")));
  // Beklenen baÅŸlÄ±klar (Apps Script): Tarih/Saat, Ä°ÅŸlem, KiÅŸi, ...
  // FarklÄ±lÄ±k olursa yine de ilk 3 sÃ¼tunu baz alÄ±rÄ±z.
  const out = [];
  for(const r of dataRows){
    const when = (r[0] ?? "").toString();
    const action = (r[1] ?? "").toString();
    const person = (r[2] ?? "").toString();
    const beforeCat = (r[3] ?? "").toString();
    const afterCat  = (r[4] ?? "").toString();
    const beforeRole= (r[5] ?? "").toString();
    const afterRole = (r[6] ?? "").toString();
    const beforePlay= (r[7] ?? "").toString();
    const afterPlay = (r[8] ?? "").toString();
    if(!when && !action && !person) continue;
    out.push({when, action, person, beforeCat, afterCat, beforeRole, afterRole, beforePlay, afterPlay});
  }
  // yeni -> eski
  return out.reverse();
}


async function loadNotifications(){
  if(!els.notifPanel) return;

  // BÄ°LDÄ°RÄ°MLER sheet'i yoksa / boÅŸsa kibarca gÃ¶ster
  try{
    const notifBase = CONFIG.NOTIF_API_BASE || CONFIG.API_BASE;
    const url = `${notifBase}?sheet=${encodeURIComponent(CONFIG.SHEET_NOTIFS)}`;
    const data = await jsonp(url);
    if(!data || data.ok !== true || !Array.isArray(data.rows)){
      els.notifList.innerHTML = `<div class="empty">ğŸ”” Bildirimler okunamadÄ±.</div>`;
      els.notifCount.textContent = "";
    els.notifCount.classList.add("hidden");
      return;
    }

    // Beklenen kolonlar: Tarih, TÃ¼r, BaÅŸlÄ±k, Mesaj, Oyun, KiÅŸi, Okundu
    const rows = data.rows.map(r=>({
      ts: String(r["Tarih"] ?? r["Tarih/Saat"] ?? r["Tarih Saat"] ?? "").trim(),
      type: String(r["TÃ¼r"] ?? r["Tur"] ?? "ğŸ””").trim() || "ğŸ””",
      title: String(r["BaÅŸlÄ±k"] ?? r["Baslik"] ?? "").trim(),
      msg: String(r["Mesaj"] ?? r["AÃ§Ä±klama"] ?? r["Aciklama"] ?? "").trim(),
      play: String(r["Oyun"] ?? "").trim(),
      person: String(r["KiÅŸi"] ?? r["Kisi"] ?? "").trim(),
      read: String(r["Okundu"] ?? "").trim()
    })).filter(x=>x.ts || x.title || x.msg);

    // newest first (basit)
    rows.reverse();

    // local okundu (site tarafÄ±): imza Ã¼zerinden
    const seen = JSON.parse(localStorage.getItem("idt_seen_notifs") || "{}");
    const norm = (x)=> (x||"").toString().slice(0,120);
    rows.forEach(n=>{
      const key = `${norm(n.ts)}|${norm(n.type)}|${norm(n.title)}|${norm(n.msg)}|${norm(n.play)}|${norm(n.person)}`;
      n._key = key;
      n._seen = !!seen[key];
    });

    const unread = rows.filter(n=>!n._seen).length;
    if(unread){
      els.notifCount.classList.remove("hidden");
      els.notifCount.textContent = String(unread);
    } else {
      els.notifCount.textContent = "";
      els.notifCount.classList.add("hidden");
    }

    if(!rows.length){

      els.notifList.innerHTML = `<div class="empty">ğŸ”” Bildirim yok.</div>`;
      return;
    }

    
    const typeInfo = (t)=>{
      const tt = (t||"").toString().trim().toUpperCase();
      if(tt.includes("EKLEND")) return {icon:"âœ…", label:"EKLENDÄ°"};
      if(tt.includes("SÄ°L") || tt.includes("CIKAR")) return {icon:"âŒ", label:"SÄ°LÄ°NDÄ°"};
      if(tt.includes("GÃœNC") || tt.includes("GUNC")) return {icon:"âœï¸", label:"GÃœNCELLENDÄ°"};
      if(tt.includes("TOPLU")) return {icon:"ğŸ§¹", label:"TOPLU"};
      if(tt.includes("DEÄÄ°Å") || tt.includes("DEGIS")) return {icon:"ğŸ””", label:"DEÄÄ°ÅÄ°KLÄ°K"};
      if(tt.includes("DÃœZEN") || tt.includes("DUZEN")) return {icon:"ğŸ””", label:"DÃœZENLENDÄ°"};
      return {icon:"ğŸ””", label:(t||"").toString().trim() || "BÄ°LDÄ°RÄ°M"};
    };
els.notifList.innerHTML = rows.map(n=>{
      const info = typeInfo(n.type);
      const meta = [n.play, n.person].filter(Boolean).join(" â€¢ ");
      const who = meta ? `<div class="notif-meta">${escapeHtml(meta)}</div>` : "";
      const titleText = n.title || info.label;
      const title = titleText ? `<div class="notif-title">${escapeHtml(titleText)}</div>` : "";
      const msg = n.msg ? `<div class="notif-msg">${escapeHtml(n.msg)}</div>` : "";
      const ts  = n.ts ? `<div class="notif-ts">${escapeHtml(n.ts)}</div>` : "";
      const cls = n._seen ? "notif-bubble seen" : "notif-bubble";
      return `<div class="${cls}" data-key="${escapeHtml(n._key)}">
        <div class="notif-type">${escapeHtml(info.icon)}</div>
        <div class="notif-body">
          ${title}${msg}${who}${ts}
        </div>
      </div>`;
    }).join("");

    // tÄ±kla â†’ okundu yap
    els.notifList.querySelectorAll(".notif-bubble").forEach(el=>{
      el.addEventListener("click", ()=>{
        const key = el.getAttribute("data-key");
        if(!key) return;
        const seen2 = JSON.parse(localStorage.getItem("idt_seen_notifs") || "{}");
        seen2[key]=true;
        localStorage.setItem("idt_seen_notifs", JSON.stringify(seen2));
        el.classList.add("seen");
        // badge gÃ¼ncelle
        const left = Array.from(els.notifList.querySelectorAll(".notif-bubble")).filter(x=>!x.classList.contains("seen")).length;
        if(left){ els.notifCount.classList.remove("hidden"); els.notifCount.textContent=String(left); } else { els.notifCount.textContent=""; els.notifCount.classList.add("hidden"); }
      });
    });

  }catch(err){
    console.error(err);
    els.notifList.innerHTML = `<div class="empty">ğŸ”” Bildirimler yÃ¼klenemedi. (API/JSONP)
<br><span class="small muted">Not: Apps Script doGet iÃ§inde JSONP (callback) aÃ§Ä±k olmalÄ±.</span></div>`;
    els.notifCount.textContent = "";
    els.notifCount.classList.add("hidden");
  }
}

/* ---------- transforms ---------- */
function groupByPlay(data){
  const map=new Map();
  for(const r of data){ if(!map.has(r.play)) map.set(r.play,[]); map.get(r.play).push(r); }
  const out=[...map.entries()].map(([playName, items])=>{
    const cats=[...new Set(items.map(x=>x.category).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"tr"));
    const persons=[...new Set(items.map(x=>x.person).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"tr"));
    return { id:`play:${playName}`, title: playName, cats, count: persons.length, rows: items };
  });
  out.sort((a,b)=>a.title.localeCompare(b.title,"tr"));
  return out;
}
function groupByPerson(data){
  const map=new Map();
  for(const r of data){
    if(!r.person) continue;
    if(!map.has(r.person)) map.set(r.person,[]);
    map.get(r.person).push(r);
  }
  const out=[...map.entries()].map(([personName, items])=>{
    const cats=[...new Set(items.map(x=>x.category).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"tr"));
    const roles=[...new Set(items.map(x=>x.role).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"tr"));
    const plays=[...new Set(items.map(x=>x.play).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"tr"));
    return { id:`person:${personName}`, title: personName, cats, roles, plays, count: plays.length, rows: items };
  });
  out.sort((a,b)=>a.title.localeCompare(b.title,"tr"));
  return out;
}
function uniqCategories(data){
  const cats=[...new Set(data.map(x=>x.category).filter(Boolean))];
  cats.sort((a,b)=>a.localeCompare(b,"tr"));
  return cats;
}

function groupByRole(rows){
  const map=new Map();
  for(const r of rows){
    const role = (r.role||"").toString().trim();
    if(!role) continue;
    if(!map.has(role)) map.set(role, {title:role, rows:[], people:new Set(), plays:new Set(), cats:new Set()});
    const o=map.get(role);
    o.rows.push(r);
    if(r.person) o.people.add(r.person);
    if(r.play) o.plays.add(r.play);
    if(r.category) o.cats.add(r.category);
  }
  const out=[...map.values()].map((o,i)=>({
    id:"role_"+i,
    title:o.title,
    rows:o.rows,
    count:o.people.size,
    people:[...o.people].sort((a,b)=>a.localeCompare(b,"tr")),
    plays:[...o.plays].sort((a,b)=>a.localeCompare(b,"tr")),
    cats:[...o.cats].sort((a,b)=>a.localeCompare(b,"tr")),
  })).sort((a,b)=>a.title.localeCompare(b.title,"tr"));
  return out;
}
function chipTone(cat){
  const t=(cat||"").toLowerCase();
  if(t.includes("figÃ¼ran") || t.includes("figuran")) return "warn";
  if(t.includes("yÃ¶netim") || t.includes("yonetim")) return "good";
  if(t.includes("oyuncu")) return "bad";
  return "";
}

function applyFilters(list){
  const qRaw = (els.q?.value || "").trim();
  const scope = (els.qScope?.value || "all");
  return list.filter(it=>{
    // Mobil oyun->kiÅŸiler filtresi
    if(activeMode==="people" && activePlayFilter){
      const playKey = normKey(activePlayFilter);
      if(!((it.plays||[]).some(p=>normKey(p)===playKey))) return false;
    }

    // Scope'a gÃ¶re arama metni
    let hay = "";
    if(activeMode==="plays"){
      hay = `${it.title} ${(it.cats||[]).join(" ")} ${(it.rows||[]).map(r=>`${r.person} ${r.role}`).join(" ")}`;
      if(scope==="person") hay = (it.rows||[]).map(r=>r.person).join(" ");
      else if(scope==="role") hay = (it.rows||[]).map(r=>r.role).join(" ");
      else if(scope==="play") hay = it.title;
    }else if(activeMode==="people"){
      hay = `${it.title} ${(it.cats||[]).join(" ")} ${(it.roles||[]).join(" ")} ${(it.plays||[]).join(" ")}`;
      if(scope==="play") hay = (it.plays||[]).join(" ");
      else if(scope==="role") hay = (it.roles||[]).join(" ");
      else if(scope==="person") hay = it.title;
    }else if(activeMode==="roles"){
      // role list
      hay = `${it.title} ${(it.plays||[]).join(" ")} ${(it.people||[]).join(" ")}`;
      if(scope==="play") hay = (it.plays||[]).join(" ");
      else if(scope==="person") hay = (it.people||[]).join(" ");
      else if(scope==="role") hay = it.title;
    }

    return fuzzyMatch(hay, qRaw);
  });
}

/* ---------- UI render ---------- */

function inlinePanelHtml(it){
  // Mobilde kartÄ±n altÄ±nda aÃ§Ä±lan detay (accordion)
  const rows = (it.rows||[]);
  const sorted = [...rows].sort((a,b)=>
    (a.category||"").localeCompare(b.category||"","tr") ||
    (a.role||"").localeCompare(b.role||"","tr") ||
    (a.person||"").localeCompare(b.person||"","tr")
  );
  const head = (activeMode==="plays")
    ? "<thead><tr><th>Kategori</th><th>GÃ¶rev</th><th>KiÅŸi</th></tr></thead>"
    : "<thead><tr><th>Oyun</th><th>GÃ¶rev</th><th>Kategori</th></tr></thead>";
  const body = sorted.map(r=>{
    if(activeMode==="plays"){
      return `<tr><td>${escapeHtml(r.category||"")}</td><td>${escapeHtml(r.role||"")}</td><td>${escapeHtml(r.person||"")}</td></tr>`;
    }else{
      return `<tr><td>${escapeHtml(r.play||"")}</td><td>${escapeHtml(r.role||"")}</td><td>${escapeHtml(r.category||"")}</td></tr>`;
    }
  }).join("");
  return `<div class="inlinePanel"><div class="inlineHead">${escapeHtml(it.title)}</div><div class="inlineTableWrap"><table class="table inlineTable">${head}<tbody>${body}</tbody></table></div></div>`;
}

function renderList(){
  const source = (activeMode==="plays") ? plays : (activeMode==="people" ? people : roles);
  const filtered = applyFilters(source);

  els.list.innerHTML="";
  const frag = document.createDocumentFragment();
  if(!filtered.length){
    els.list.innerHTML = `<div class="empty">SonuÃ§ yok ğŸ˜…</div>`;
    els.hint.textContent = "";
    return;
  }

  for(const it of filtered){
    const isActive = it.id===activeId;
    let meta = "";
    if(activeMode==="plays") meta = `${it.count} kiÅŸi â€¢ ${it.rows.length} satÄ±r`;
    else if(activeMode==="people") meta = `${it.count} oyun â€¢ ${it.rows.length} satÄ±r`;
    else meta = `${it.count} kiÅŸi â€¢ ${it.rows.length} satÄ±r`;
    let meta2 = "";
    if(activeMode==="people"){
      const uniqPlays = [...new Set((it.rows||[]).map(r=>r.play).filter(Boolean))];
      const uniqRoles = [...new Set((it.rows||[]).map(r=>r.role).filter(Boolean))];
      const playsPreview = uniqPlays.slice(0,3);
      if(showAssignments){
        const rolesPreview = uniqRoles.slice(0,3);
        meta2 = `Oyunlar: ${playsPreview.join(", ")}${uniqPlays.length>3?" â€¦":""} â€¢ GÃ¶revler: ${rolesPreview.join(", ")}${uniqRoles.length>3?" â€¦":""}`;
      }else{
        meta2 = playsPreview.length ? `Oyunlar: ${playsPreview.join(", ")}${uniqPlays.length>3?" â€¦":""}` : "";
      }
    }

    const chips = (it.cats||[]).slice(0,6).map(c=>`<span class="chip ${chipTone(c)}">${escapeHtml(c)}</span>`).join("");
    const more = (it.cats||[]).length>6 ? `<span class="chip">+${it.cats.length-6}</span>` : "";
    const retiredTag = (activeMode==="people" && retiredSet.has(it.title)) ? `<span class="tag retired">Kurumdan Emekli SanatÃ§Ä±</span>` : "";

    const div=document.createElement("div");
    div.className="item";
    if(isActive) div.style.borderColor="color-mix(in srgb, var(--accent) 35%, var(--line) 65%)";
    div.innerHTML = `
      <div class="t">
        <div>
          <div class="name">${escapeHtml(it.title)}${retiredTag}</div>
          <div class="meta">${escapeHtml(meta)}</div>${meta2?`<div class="meta" style="margin-top:2px">${escapeHtml(meta2)}</div>`:""}
        </div>
        <div style="color:var(--muted);font-size:12px">â–¶</div>
      </div>
      <div class="chips">${chips}${more}</div>
      ${ (isMobile() && isActive) ? inlinePanelHtml(it) : "" }
    `;
    div.addEventListener("click", ()=>{
      const wasActive = (activeId===it.id);
      activeId = wasActive ? "" : it.id;
      selectedItem = wasActive ? null : it;
      renderList();
      if(!wasActive) renderDetails(it);
      else renderDetails(null);
    });
    frag.appendChild(div);
  }


  els.list.appendChild(frag);

  if(isMobile() && activeMode==="people" && activePlayFilter){
    els.hint.innerHTML = `<div class="mobile-breadcrumb"><button class="btn sm" id="btnBackPlays">â† Oyunlar</button><span class="mb-text">${escapeHtml(activePlayFilter)} ekibi â€¢ ${filtered.length} kiÅŸi</span></div>`;
    setTimeout(()=>{
      const b=document.getElementById("btnBackPlays");
      if(b) b.onclick=()=>{ activePlayFilter=""; setActiveMode("plays"); render(); };
    },0);
  } else {
    els.hint.textContent = `GÃ¶sterilen: ${filtered.length} / ${source.length}`;
  }

}

function renderDetails(it){
  if(!it){ els.details.innerHTML = `<div class="empty">Soldan bir oyun veya kiÅŸi seÃ§.</div>`; return; }

  if(activeMode==="plays"){
    const rowsSorted=[...it.rows].sort((a,b)=>
      (a.category||"").localeCompare(b.category||"","tr") ||
      (a.role||"").localeCompare(b.role||"","tr") ||
      (a.person||"").localeCompare(b.person||"","tr")
    );
    els.details.innerHTML = `
      <h3 class="title">${escapeHtml(it.title)}${personTag(it.title)}</h3>
      <p class="subtitle">${it.count} kiÅŸi â€¢ ${it.rows.length} satÄ±r</p>
      <table class="table" id="detailTable">
        <thead><tr><th>Kategori</th><th>GÃ¶rev</th><th>KiÅŸi</th></tr></thead>
        <tbody>
          ${rowsSorted.map(r=>`<tr><td>${escapeHtml(r.category)}</td><td>${escapeHtml(r.role)}</td><td>${escapeHtml(r.person)}${personTag(r.person)}</td></tr>`).join("")}
        </tbody>
      </table>
    `;

  } else if(activeMode==="roles"){
    const byPlay=new Map();
    for(const r of it.rows){ if(!byPlay.has(r.play)) byPlay.set(r.play,[]); byPlay.get(r.play).push(r); }
    const blocks=[...byPlay.entries()].sort((a,b)=>a[0].localeCompare(b[0],"tr"));
    els.details.innerHTML = `
      <h3 class="title">${escapeHtml(it.title)}</h3>
      <p class="subtitle">${it.count} kiÅŸi â€¢ ${it.rows.length} satÄ±r</p>
      <div id="detailTable">
      ${blocks.map(([p, rs])=>{
        const rs2=[...rs].sort((a,b)=>(a.category||"").localeCompare(b.category||"","tr") || (a.person||"").localeCompare(b.person||"","tr"));
        return `
          <div style="margin:12px 0 10px">
            <div style="font-weight:850;margin:0 0 8px">${escapeHtml(p)}</div>
            <table class="table">
              <thead><tr><th>KiÅŸi</th><th>Kategori</th></tr></thead>
              <tbody>${rs2.map(r=>`<tr><td>${escapeHtml(r.person)}${personTag(r.person)}</td><td>${escapeHtml(r.category)}</td></tr>`).join("")}</tbody>
            </table>
          </div>
        `;
      }).join("")}
      </div>
    `;
  } else {
    const byPlay=new Map();
    for(const r of it.rows){ if(!byPlay.has(r.play)) byPlay.set(r.play,[]); byPlay.get(r.play).push(r); }
    const blocks=[...byPlay.entries()].sort((a,b)=>a[0].localeCompare(b[0],"tr"));
    els.details.innerHTML = `
      <h3 class="title">${escapeHtml(it.title)}${personTag(it.title)}</h3>
      <p class="subtitle">${it.count} oyun â€¢ ${it.rows.length} satÄ±r</p>
      <div id="detailTable">
      ${blocks.map(([p, rs])=>{
        const rs2=[...rs].sort((a,b)=>(a.category||"").localeCompare(b.category||"","tr") || (a.role||"").localeCompare(b.role||"","tr"));
        return `
          <div style="margin:12px 0 10px">
            <div style="font-weight:850;margin:0 0 8px">${escapeHtml(p)}</div>
            <table class="table">
              <thead><tr><th>Kategori</th><th>GÃ¶rev</th></tr></thead>
              <tbody>${rs2.map(r=>`<tr><td>${escapeHtml(r.category)}</td><td>${escapeHtml(r.role)}</td></tr>`).join("")}</tbody>
            </table>
          </div>
        `;
      }).join("")}
      </div>
    `;
  }
}

/* ---------- Copy as Excel-friendly (TSV) ---------- */
function toTSVFromSelected(){
  if(!selectedItem) return "";
  if(activeMode==="plays"){
    const rowsSorted=[...selectedItem.rows].sort((a,b)=>
      (a.category||"").localeCompare(b.category||"","tr") ||
      (a.role||"").localeCompare(b.role||"","tr") ||
      (a.person||"").localeCompare(b.person||"","tr")
    );
    const playTitle = selectedItem.title || "";
    const lines=[["Oyun","Kategori","GÃ¶rev","KiÅŸi"].join("\t")];
    for(const r of rowsSorted){
      lines.push([playTitle, r.category||"", r.role||"", r.person||""].join("\t"));
    }
    return lines.join("\n");
  } else {
    const rs=[...selectedItem.rows].sort((a,b)=>
      (a.play||"").localeCompare(b.play||"","tr") ||
      (a.category||"").localeCompare(b.category||"","tr") ||
      (a.role||"").localeCompare(b.role||"","tr")
    );
    const lines=[["Oyun","Kategori","GÃ¶rev"].join("\t")];
    for(const r of rs){
      lines.push([r.play||"", r.category||"", r.role||""].join("\t"));
    }
    return lines.join("\n");
  }
}


/* ---------- distinct colors (unique per chart) ---------- */
function makeDistinctColors(n){
  const out = [];
  const N = Math.max(1, n|0);
  for(let i=0;i<N;i++){
    const hue = (i * 360 / N);
    out.push(`hsl(${hue} 85% 55%)`);
  }
  return out;
}
function makeColorGetter(keys){
  const uniq = [...new Set((keys||[]).map(k=>String(k)))].sort((a,b)=>a.localeCompare(b,"tr"));
  const cols = makeDistinctColors(uniq.length);
  const map = new Map();
  uniq.forEach((k,i)=>map.set(k, cols[i]));
  return (key)=> map.get(String(key)) || "hsl(0 0% 60%)";
}
/* ---------- charts ---------- */
function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}
function drawBars(canvas, items, topN){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const cssW = canvas.clientWidth || 900;
  const cssH = canvas.clientHeight || 340;
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  const data = items.slice(0, topN);
  const getColor = makeColorGetter(data.map(d=>d.k));

  const card = cssVar("--card");
  const grid = cssVar("--line");
  const text = cssVar("--text");
  const muted = cssVar("--muted");
  const accent = cssVar("--accent");

  chartHits = [];

  ctx.clearRect(0,0,cssW,cssH);
  ctx.fillStyle = card;
  roundRect(ctx, 0, 0, cssW, cssH, 14);
  ctx.fill();

  ctx.strokeStyle = grid;
  ctx.lineWidth = 1;
  const padL=18, padR=14, padT=16, padB=74;
  const w=cssW-padL-padR;
  const h=cssH-padT-padB;

  for(let i=0;i<=4;i++){
    const y=padT + (h*(i/4));
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+w,y); ctx.stroke();
  }

  const maxV = Math.max(...data.map(d=>d.v), 1);
  const barW = w / Math.max(data.length,1);

  for(let i=0;i<data.length;i++){
    const d=data[i];
    const bh = (d.v/maxV)*h;
    const x = padL + i*barW + 6;
    const y = padT + (h-bh);
    const bw = Math.max(barW-12, 14);

    ctx.fillStyle = getColor(d.k);
    ctx.globalAlpha = 0.78;
    roundRect(ctx, x, y, bw, bh, 12);
    ctx.fill();
    ctx.globalAlpha = 1;

    ctx.fillStyle = text;
    ctx.font = "12px system-ui";
    ctx.fillText(String(d.v), x+2, y-6);

    ctx.save();
    ctx.fillStyle = muted;
    ctx.font = "12px system-ui";
    const label = d.k.length>26 ? d.k.slice(0,26)+"â€¦" : d.k;
    // etiketleri yatay yaz (mobilde okunur)
    const yLabel = padT + h + 18;
    ctx.textAlign = "center";
    ctx.fillText(label, x + barW/2, yLabel);
    ctx.restore();

    chartHits.push({type:"bar", key:d.k, x, y, w:bw, h:bh});
  }
}
function drawDoughnut(canvas, items, topN, legendTitle){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const cssW = canvas.clientWidth || 900;
  const cssH = canvas.clientHeight || 340;
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  // Top N + DiÄŸer (okunabilirlik)
  const sorted = items.slice().sort((a,b)=>b.v-a.v);
  const top = sorted.slice(0, topN);
  const rest = sorted.slice(topN);
  if(rest.length){
    const other = rest.reduce((s,x)=>s+x.v,0);
    top.push({k:"DiÄŸer", v:other});
  }
  const data = top;
  const total = data.reduce((s,x)=>s+x.v,0) || 1;

  const card = cssVar("--card");
  const line = cssVar("--line");
  const text = cssVar("--text");
  const muted = cssVar("--muted");

  const palette = [
    cssVar("--accent"), cssVar("--accent2"),
    "#2E7D32","#1565C0","#6A1B9A","#EF6C00",
    "#00838F","#C2185B","#5D4037","#455A64",
    "#9E9D24","#AD1457"
  ];

  chartHits = [];

  ctx.clearRect(0,0,cssW,cssH);
  ctx.fillStyle = card;
  roundRect(ctx, 0, 0, cssW, cssH, 14);
  ctx.fill();

  const isM = isMobile();
  const cx = isM ? cssW*0.50 : cssW*0.34;
  const cy = cssH*0.52;
  const rOuter = Math.min(cssW, cssH)*(isM ? 0.28 : 0.32);
  const rInner = rOuter*0.60;

  let start = -Math.PI/2;
  for(let i=0;i<data.length;i++){
    const d=data[i];
    const ang = (d.v/total) * Math.PI*2;
    const end = start + ang;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, rOuter, start, end);
    ctx.closePath();
    ctx.fillStyle = getColor(d.k);
    ctx.globalAlpha = 0.92;
    ctx.fill();
    ctx.globalAlpha = 1;

    chartHits.push({type:"wedge", key:d.k, cx, cy, rOuter, rInner, start, end});
    start = end;
  }

  // inner hole
  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI*2);
  ctx.fillStyle = card;
  ctx.fill();

  // center total
  ctx.fillStyle = muted;
  ctx.font = "12px system-ui";
  ctx.textAlign="center";
  ctx.fillText("Toplam", cx, cy-6);
  ctx.fillStyle = text;
  ctx.font = "18px system-ui";
  ctx.fillText(String(total), cx, cy+18);
  ctx.textAlign="left";

  // legend
  const lx = isM ? 16 : cssW*0.62;
  let ly = isM ? (cy + rOuter + 20) : 24;

  ctx.fillStyle = text;
  ctx.font = "13px system-ui";
  ctx.fillText(legendTitle || "DaÄŸÄ±lÄ±m", lx, ly);
  ly += 10;

  ctx.font = "12px system-ui";
  const maxLegend = isM ? 10 : data.length;
  for(let i=0;i<Math.min(data.length, maxLegend);i++){
    const d=data[i];
    ly += 18;
    ctx.fillStyle = getColor(d.k);
    roundRect(ctx, lx, ly-11, 10, 10, 3);
    ctx.fill();
    ctx.fillStyle = muted;
    const label = d.k.length>28 ? d.k.slice(0,28)+"â€¦" : d.k;
    ctx.fillText(`${label}  (${d.v})`, lx+16, ly-2);
  }
  if(isM && data.length>maxLegend){
    ly += 16;
    ctx.fillStyle = muted;
    ctx.fillText(`+${data.length-maxLegend} kategori daha (tÄ±kla: listede gÃ¶r)`, lx, ly);
  }

  ctx.strokeStyle = line;
  ctx.strokeRect(0.5,0.5,cssW-1,cssH-1);
}

/* ---------- mobile chart list ---------- */
function renderMobileChartList(items){
  const box = document.getElementById("chartMobileList");
  const wrap = document.querySelector(".mobileChartWrap");
  if(!box || !wrap) return;

  // sadece mobilde gÃ¶ster
  if(!isMobile()){ box.innerHTML=""; wrap.style.display="none"; return; }
  wrap.style.display="block";

  const sorted = items.slice().sort((a,b)=>b.v-a.v);
  const rows = sorted.slice(0, 24); // mobilde Ã§ok uzamasÄ±n

  const getColor = makeColorGetter(rows.map(r=>r.k));

  box.innerHTML = rows.map(it=>{
    const c = getColor(it.k);
    const rawK = String(it.k||"");
    const safeK = escapeHtml(rawK);
    const encK = encodeURIComponent(rawK);
    return `
      <div class="chipRow" data-key="${encK}">
        <div class="chipLeft">
          <div class="dot" style="background:${c}"></div>
          <div class="chipTitle" title="${safeK}">${safeK}</div>
        </div>
        <div class="chipCount">${it.v}</div>
      </div>
    `;
  }).join("");

  // click: drawer aÃ§ (chart ile aynÄ± filtre mantÄ±ÄŸÄ±)
  box.querySelectorAll(".chipRow").forEach(el=>{
    el.addEventListener("click", ()=>{
      const key = decodeURIComponent(el.getAttribute("data-key") || "");
      const map=new Map();
      for(const r of rowsAll()){ // rows global
        const match = (chartMode==="roles") ? ((r.role||"").trim()===key) : ((r.category||"").trim()===key);
        if(match && r.person){
          if(!map.has(r.person)) map.set(r.person, new Set());
          map.get(r.person).add(r.play);
        }
      }
      const items=[...map.entries()].map(([person, s])=>({person, plays:[...s].sort((a,b)=>a.localeCompare(b,"tr"))}));
      items.sort((a,b)=>b.plays.length-a.plays.length || a.person.localeCompare(b.person,"tr"));
      openDrawer(`${chartMode==="roles" ? "GÃ¶rev" : "Kategori"}: ${key}`, `${items.length} kiÅŸi`, items);
      // mobilde drawer aÃ§Ä±kken sayfa kaymasÄ±n
      document.body.classList.add("drawerOpen");
    });
  });
}
function rowsAll(){ return rows || []; }

function drawChart(){
  if(!rows.length) return;
  if(chartMode==="roles"){
    const counts=new Map();
    for(const r of rows){
      const k=((r.role||"Bilinmiyor").trim() || "Bilinmiyor");
      if(!counts.has(k)) counts.set(k, new Set());
      counts.get(k).add((r.person||"").trim());
    }
    const items=[...counts.entries()].map(([k,set])=>({k,v:set.size})).sort((a,b)=>b.v-a.v);
    els.chartTitle.textContent = "GÃ¶revlere GÃ¶re DaÄŸÄ±lÄ±m";
    renderMobileChartList(items);
    drawDoughnut(els.chartMain, items, (isMobile()?10:14), "Top GÃ¶revler");
  }else{
    const counts=new Map();
    for(const r of rows){
      const k=((r.category||"Bilinmiyor").trim() || "Bilinmiyor");
      if(!counts.has(k)) counts.set(k, new Set());
      counts.get(k).add((r.person||"").trim());
    }
    const items=[...counts.entries()].map(([k,set])=>({k,v:set.size})).sort((a,b)=>b.v-a.v);
    els.chartTitle.textContent = "Kategori DaÄŸÄ±lÄ±mÄ±";
    renderMobileChartList(items);
    drawDoughnut(els.chartMain, items, (isMobile()?10:14), "Top Kategoriler");
  }
}

/* ---------- chart drawer ---------- */
function openDrawer(title, subtitle, items){
  els.drawerTitle.textContent = title;
  els.drawerSub.textContent = subtitle;
  drawerData = items.slice();
  els.drawerSearch.value = "";
  renderDrawerList();
  els.drawer.classList.remove("hidden");
  if(isMobile()) document.body.classList.add("drawerOpen");
}
function closeDrawer(){
  els.drawer.classList.add("hidden");
  document.body.classList.remove("drawerOpen");
  drawerData = [];
  els.drawerList.innerHTML = "";
}
els.drawerClose.addEventListener("click", closeDrawer);
els.drawerSearch.addEventListener("input", renderDrawerList);

function renderDrawerList(){
  const q = els.drawerSearch.value.trim().toLowerCase();
  const filtered = drawerData.filter(x=>{
    if(!q) return true;
    return (x.person+" "+(x.plays||[]).join(" ")).toLowerCase().includes(q);
  });

  if(!filtered.length){
    els.drawerList.innerHTML = `<div class="empty">SonuÃ§ yok.</div>`;
    return;
  }
  els.drawerList.innerHTML = filtered.slice(0,250).map(x=>`
    <div class="miniItem">
      <b>${escapeHtml(x.person)}</b>
      <div class="small">${escapeHtml((x.plays||[]).slice(0,10).join(" â€¢ "))}${(x.plays||[]).length>10 ? " â€¢ â€¦" : ""}</div>
    </div>
  `).join("");
}

function hitTestChart(evt){
  const rect = els.chartMain.getBoundingClientRect();
  const x = evt.clientX - rect.left;
  const y = evt.clientY - rect.top;

  for(const h of chartHits){
    if(h.type==="bar"){
      if(x>=h.x && x<=h.x+h.w && y>=h.y && y<=h.y+h.h) return h;
    }else if(h.type==="wedge"){
      const dx=x-h.cx, dy=y-h.cy;
      const rr=Math.sqrt(dx*dx+dy*dy);
      if(rr < h.rInner || rr > h.rOuter) continue;
      let ang=Math.atan2(dy,dx);
      if(ang< -Math.PI/2) ang += Math.PI*2;
      let s=h.start, e=h.end;
      while(ang < s) ang += Math.PI*2;
      if(ang >= s && ang <= e) return h;
    }
  }
  return null;
}

els.chartMain.addEventListener("click", (evt)=>{
  const h = hitTestChart(evt);
  if(!h) return;
  const key = h.key;

  const map=new Map();
  for(const r of rows){
    const match = (chartMode==="roles") ? ((r.role||"").trim()===key) : ((r.category||"").trim()===key);
    if(match && r.person){
      if(!map.has(r.person)) map.set(r.person, new Set());
      map.get(r.person).add(r.play);
    }
  }
  const items=[...map.entries()].map(([person, s])=>({person, plays:[...s].sort((a,b)=>a.localeCompare(b,"tr"))}));
  items.sort((a,b)=>b.plays.length-a.plays.length || a.person.localeCompare(b.person,"tr"));
  openDrawer(`${chartMode==="roles" ? "GÃ¶rev" : "Kategori"}: ${key}`, `${items.length} kiÅŸi`, items);
});

/* ---------- distribution ---------- */
function computeDistribution(){
  const map=new Map();
  for(const r of rows){
    if(!r.person) continue;
    const p=r.person.trim(); if(!p) continue;
    if(!map.has(p)) map.set(p, {plays:new Set(), roles:new Set()});
    map.get(p).plays.add(r.play);
    if(r.role) map.get(p).roles.add(r.role);
  }
  const out=[];
  for(const [person, v] of map.entries()){
    const plays=[...v.plays].sort((a,b)=>a.localeCompare(b,"tr"));
    if(plays.length<=1) continue;
    out.push({person, plays, roles:[...v.roles].sort((a,b)=>a.localeCompare(b,"tr"))});
  }
  out.sort((a,b)=>b.plays.length-a.plays.length || a.person.localeCompare(b.person,"tr"));
  return out;
}
function renderDistribution(){
  const q=els.dq.value.trim().toLowerCase();
  const filtered = distribution.filter(d=>{
    if(!q) return true;
    const hay=(d.person+" "+d.plays.join(" ")+" "+d.roles.join(" ")).toLowerCase();
    return hay.includes(q);
  });

  if(!filtered.length){
    els.distributionBox.innerHTML = `<div class="empty">KayÄ±t yok (veya filtre Ã§ok dar).</div>`;
    return;
  }
  els.distributionBox.innerHTML = `
    <table class="table">
      <thead><tr><th>KiÅŸi</th><th>Oyun SayÄ±sÄ±</th><th>Oyunlar</th><th>GÃ¶revler</th></tr></thead>
      <tbody>
        ${filtered.map(d=>`
          <tr>
            <td><b>${escapeHtml(d.person)}</b></td>
            <td>${d.plays.length}</td>
            <td>${escapeHtml(d.plays.join(" â€¢ "))}</td>
            <td>${escapeHtml(d.roles.join(", "))}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
    <div class="small" style="margin-top:10px">Toplam: ${filtered.length} kiÅŸi</div>
  `;
}

/* ---------- figuran render ---------- */
function renderFiguran(){
  const q=els.fq.value.trim().toLowerCase();
  const filtered = figuran.filter(f=>{
    if(!q) return true;
    const hay=(f.person+" "+(f.cats||[]).join(" ")+" "+f.plays.join(" ")+" "+f.roles.join(" ")).toLowerCase();
    return hay.includes(q);
  });

  if(!filtered.length){
    els.figuranBox.innerHTML = `<div class="empty">FigÃ¼ran / Kurumdan Emekli SanatÃ§Ä± bulunamadÄ±.</div>`;
    return;
  }

  els.figuranBox.innerHTML = `
    <table class="table">
      <thead><tr><th>S.N</th><th>KiÅŸi</th><th>Kategori</th><th>Oyunlar</th><th>GÃ¶revler</th></tr></thead>
      <tbody>
        ${filtered.map((f, idx)=>`
          <tr>
            <td>${idx+1}</td>
            <td><b>${escapeHtml(f.person)}</b></td>
            <td>${escapeHtml((f.cats||[]).join(", "))}</td>
            <td>${escapeHtml(f.plays.join(" â€¢ "))}</td>
            <td>${escapeHtml(f.roles.join(", "))}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
    <div class="small" style="margin-top:10px">Toplam: ${filtered.length} kiÅŸi</div>
  `;
}

/* ---------- intersection ---------- */
function renderPlayOptions(){
  const opts = playsList.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
  els.p1.innerHTML = opts;
  els.p2.innerHTML = opts;
  if(playsList.length){
    els.p1.value = playsList[0];
    els.p2.value = playsList.length>1 ? playsList[1] : playsList[0];
  }
}
function computeIntersection(playA, playB){
  const mapA=new Map();
  const mapB=new Map();
  for(const r of rows){
    if(!r.person) continue;
    if(r.play===playA){
      if(!mapA.has(r.person)) mapA.set(r.person, []);
      mapA.get(r.person).push(r);
    } else if(r.play===playB){
      if(!mapB.has(r.person)) mapB.set(r.person, []);
      mapB.get(r.person).push(r);
    }
  }
  const common=[];
  for(const [person, ra] of mapA.entries()){
    if(!mapB.has(person)) continue;
    const rb = mapB.get(person);
    const rolesA=[...new Set(ra.map(x=>x.role).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"tr"));
    const rolesB=[...new Set(rb.map(x=>x.role).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"tr"));
    const catsA=[...new Set(ra.map(x=>x.category).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"tr"));
    const catsB=[...new Set(rb.map(x=>x.category).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"tr"));
    common.push({person, rolesA, rolesB, catsA, catsB});
  }
  common.sort((a,b)=>a.person.localeCompare(b.person,"tr"));
  return common;
}
function renderIntersection(){
  const a = els.p1.value;
  const b = els.p2.value;
  if(!a || !b){
    els.intersectionBox.innerHTML = `<div class="empty">Oyun seÃ§.</div>`;
    return;
  }
  if(a===b){
    els.intersectionBox.innerHTML = `<div class="empty">Ä°ki farklÄ± oyun seÃ§ersen ortak personeli gÃ¶sterebilirim ğŸ™‚</div>`;
    return;
  }
  const common = computeIntersection(a,b);
  if(!common.length){
    els.intersectionBox.innerHTML = `<div class="empty"><b>${escapeHtml(a)}</b> ile <b>${escapeHtml(b)}</b> arasÄ±nda ortak personel yok.</div>`;
    return;
  }
  els.intersectionBox.innerHTML = `
    <div class="small" style="margin-bottom:10px"><b>${escapeHtml(a)}</b> âˆ© <b>${escapeHtml(b)}</b> â†’ <b>${common.length}</b> kiÅŸi</div>
    <table class="table">
      <thead><tr><th>KiÅŸi</th><th>${escapeHtml(a)} (Kategori / GÃ¶rev)</th><th>${escapeHtml(b)} (Kategori / GÃ¶rev)</th></tr></thead>
      <tbody>
        ${common.map(c=>`
          <tr>
            <td><b>${escapeHtml(c.person)}</b></td>
            <td>${escapeHtml(c.catsA.join(", "))}<br><span class="small">${escapeHtml(c.rolesA.join(", "))}</span></td>
            <td>${escapeHtml(c.catsB.join(", "))}<br><span class="small">${escapeHtml(c.rolesB.join(", "))}</span></td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

/* ---------- navigation ---------- */
function setActiveTab(which){
  const tabs=[["tabPanel","viewPanel"],["tabDistribution","viewDistribution"],["tabIntersection","viewIntersection"],["tabFiguran","viewFiguran"],["tabCharts","viewCharts"]];
  for(const [t,v] of tabs){
    el(t).classList.remove("active");
    el(v).style.display="none";
  }
  el("tab"+which).classList.add("active");
  el("view"+which).style.display="block";
  // A11y: aktif sekme
  ["Panel","Distribution","Intersection","Figuran","Charts"].forEach(n=>{
    const b = el("tab"+n);
    if(b) b.setAttribute("aria-selected", n===which ? "true" : "false");
  });
  // Mobile tabbar senkron
  try{
    const m = {Panel:"Panel",Distribution:"Analiz",Intersection:"Analiz",Figuran:"Figuran",Charts:"Grafikler"};
    setTabbarActive(m[which]||"Panel");
  }catch(e){}


  // URL hash: geri/ileri tuÅŸu + yenilemede aynÄ± sekme
  const slugMap = {
    Panel: "panel",
    Distribution: "analiz",
    Intersection: "kesisim",
    Figuran: "figuran",
    Charts: "grafikler",
  };
  const slug = slugMap[which] || "panel";
  const newHash = "#" + slug;
  if (location.hash !== newHash) {
    // hash deÄŸiÅŸtirirken sayfanÄ±n scroll zÄ±plamasÄ±nÄ± Ã¶nle
    history.replaceState(null, "", newHash);
  }
  if(which==="Charts" && rows.length){
    closeDrawer();
    drawChart();
  }
}

function tabFromHash_(){
  const h = String(location.hash || "").replace(/^#/, "").toLowerCase();
  if (!h) return null;
  if (["panel"].includes(h)) return "Panel";
  if (["analiz","analysis","dagilim","distribution"].includes(h)) return "Distribution";
  if (["kesisim","intersection"].includes(h)) return "Intersection";
  if (["figuran","figÃ¼ran"].includes(h)) return "Figuran";
  if (["grafikler","charts","chart"].includes(h)) return "Charts";
  return null;
}

els.tabPanel && els.tabPanel.addEventListener("click", ()=>setActiveTab("Panel"));
els.tabDistribution && els.tabDistribution.addEventListener("click", ()=>setActiveTab("Distribution"));
els.tabIntersection && els.tabIntersection.addEventListener("click", ()=>setActiveTab("Intersection"));
els.tabFiguran && els.tabFiguran.addEventListener("click", ()=>setActiveTab("Figuran"));
els.tabCharts && els.tabCharts.addEventListener("click", ()=>setActiveTab("Charts"));

// KPI kartlarÄ±: hÄ±zlÄ± sekme geÃ§iÅŸi
document.querySelectorAll(".kpi[data-go]").forEach(card=>{
  const target = String(card.getAttribute("data-go")||"").trim();
  const mode = String(card.getAttribute("data-mode")||"").trim();
  if(!target) return;

  const afterGo = ()=>{
    // Panel iÃ§indeki segmentleri KPI'dan seÃ§ (Oyunlar / KiÅŸiler)
    if(target === "Panel"){
      // KPI -> Panel iÃ§i gÃ¶rÃ¼nÃ¼m
      if(mode === "people"){
        showAssignments = false;
        activeMode = "people";
        if(els.qScope) els.qScope.value = "person";
        els.btnPeople && els.btnPeople.click();
      }else if(mode === "plays"){
        showAssignments = false;
        activeMode = "plays";
        if(els.qScope) els.qScope.value = "play";
        els.btnPlays && els.btnPlays.click();
      }else if(mode === "rows"){
        // GÃ¶rev atamasÄ±: kiÅŸi listesi + oyun/gÃ¶rev Ã¶zeti
        showAssignments = true;
        activeMode = "people";
        if(els.qScope) els.qScope.value = "role";
        els.btnPeople && els.btnPeople.click();
      }

      // Liste alanÄ±na otomatik kaydÄ±r
      const panelList = document.getElementById('viewPanel');
      if(panelList) panelList.scrollIntoView({behavior:'smooth', block:'start'});
    }
    else if(target === "Figuran"){
      const fig = document.getElementById('viewFiguran');
      if(fig) fig.scrollIntoView({behavior:'smooth', block:'start'});
    }
  };

  const goNow = ()=>{
    setActiveTab(target);
    // DOM gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ gÃ¼ncellensin diye kÃ¼Ã§Ã¼k gecikme
    setTimeout(afterGo, 50);
  };

  card.addEventListener("click", goNow);
  card.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      goNow();
    }
  });
});

// URL hash deÄŸiÅŸince sekmeyi gÃ¼ncelle (geri/ileri tuÅŸlarÄ±)
window.addEventListener("hashchange", ()=>{
  const t = tabFromHash_();
  if(t) setActiveTab(t);
});

// Ä°lk aÃ§Ä±lÄ±ÅŸta hash varsa onu aÃ§
(function(){
  const t = tabFromHash_();
  if(t) setActiveTab(t);
})();

/* ---------- events ---------- */
els.reloadBtn.addEventListener("click", ()=>load(false, true));

// Bildirimler (LOG)
els.notifBtn && (()=> {
  const open = async ()=>{
    els.notifPanel.classList.remove("hidden");
    const bd = document.getElementById("notifBackdrop");
    if(bd) bd.classList.remove("hidden");
    await loadNotifications();
    localStorage.setItem("idt_log_seen_ts", String(Date.now()));
    els.notifCount.classList.add("hidden");
  };
  const close = ()=>{
    els.notifPanel.classList.add("hidden");
    const bd = document.getElementById("notifBackdrop");
    if(bd) bd.classList.add("hidden");
  };
  const toggle = async ()=>{
    if(els.notifPanel.classList.contains("hidden")) await open();
    else close();
  };
  const handler = (e)=>{ e.stopPropagation(); toggle(); };
  els.notifBtn.addEventListener("click", (e)=>{ e.preventDefault(); openNotif(); });
els.notifBtn.addEventListener("pointerup", handler);
  els.notifClose && els.notifClose.addEventListener("click", close);
  els.notifClose && els.notifClose.addEventListener("pointerup", close);
  const bd = document.getElementById("notifBackdrop");
  if(bd){
    bd.addEventListener("click", close);
    bd.addEventListener("pointerup", close);
  }
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") close(); });
})();
els.notifClose && els.notifClose.addEventListener("click", ()=>els.notifPanel.classList.add("hidden"));
els.notifRefresh && els.notifRefresh.addEventListener("click", loadNotifications);

els.clearBtn.addEventListener("click", ()=>{ els.q.value="";
renderList(); });

els.q.addEventListener("input", ()=>renderList());
if(els.qScope){
  els.qScope.addEventListener("change", ()=>{
    const v=els.qScope.value;
    if(v==="play"){ showAssignments=false; activeMode="plays"; activePlayFilter=null; }
    else if(v==="person"){ showAssignments=false; activeMode="people"; activePlayFilter=null; }
    else if(v==="role"){ showAssignments=true; activeMode="people"; activePlayFilter=null; }
    // all: mode deÄŸiÅŸtirme
    activeId=null; selectedItem=null;
    renderList(); renderDetails(null);
  });
}

els.btnPlays.addEventListener("click", ()=>{
  activeMode="plays";
  activePlayFilter = null;
  els.btnPlays.classList.add("active"); els.btnPeople.classList.remove("active");
  activeId=null; selectedItem=null;
  renderList(); renderDetails(null);
});
els.btnPeople.addEventListener("click", ()=>{
  activeMode="people";
  activePlayFilter = null;
  els.btnPeople.classList.add("active"); els.btnPlays.classList.remove("active");
  activeId=null; selectedItem=null;
  renderList(); renderDetails(null);
});


// Mobil: oyundan kiÅŸilere geÃ§iÅŸte geri tuÅŸu Oyunlar'a dÃ¶ndÃ¼rsÃ¼n
window.addEventListener("popstate", ()=>{
  if(activePlayFilter){
    activePlayFilter = null;
    activeMode = "plays";
    els.btnPlays.classList.add("active"); 
    els.btnPeople.classList.remove("active");
    activeId=null; selectedItem=null;
    renderList(); 
    renderDetails(null);
    setStatus("â†©ï¸ Oyunlar listesine dÃ¶nÃ¼ldÃ¼", "ok");
  }
});
els.copyBtn.addEventListener("click", async ()=>{
  const tsv = toTSVFromSelected();
  if(!tsv){ setStatus("âš ï¸ Ã–nce bir Ã¶ÄŸe seÃ§", "warn"); return; }
  try{
    await copyToClipboard(tsv);
    setStatus("ğŸ“‹ Excel formatÄ±nda kopyalandÄ±", "ok");
    setTimeout(()=>setStatus("âœ… HazÄ±r", "ok"), 1000);
  }catch{ alert("Kopyalama engellendi."); }
});


async function copyText(text){
  const value = String(text ?? "");
  // Modern Clipboard API (secure context)
  if(navigator.clipboard && window.isSecureContext){
    try{
      await navigator.clipboard.writeText(value);
      toast("ğŸ“‹ Excel iÃ§in kopyalandÄ± (Ctrl+V / YapÄ±ÅŸtÄ±r)");
      setStatus("ğŸ“‹ KopyalandÄ±", "ok");
      return true;
    }catch(e){
      // fall through to legacy
    }
  }
  // Legacy fallback
  try{
    const ta = document.createElement("textarea");
    ta.value = value;
    ta.setAttribute("readonly", "");
    ta.style.position="fixed";
    ta.style.top="-1000px";
    ta.style.left="-1000px";
    document.body.appendChild(ta);
    ta.select();
    ta.setSelectionRange(0, ta.value.length);
    const ok = document.execCommand("copy");
    document.body.removeChild(ta);
    if(ok){
      toast("ğŸ“‹ Excel iÃ§in kopyalandÄ± (Ctrl+V / YapÄ±ÅŸtÄ±r)");
      setStatus("ğŸ“‹ KopyalandÄ±", "ok");
      return true;
    }
  }catch(e){}
  alert("Kopyalama engellendi. TarayÄ±cÄ± izinlerini kontrol et.");
  return false;
}
function downloadText(filename, text){
  // Mobil/Safari uyumu iÃ§in: Ã¶nce Blob dene, gerekirse data: URI fallback
  const ua = navigator.userAgent || "";
  const isIOS = /iPad|iPhone|iPod/.test(ua);
  const useDataUrl = isIOS; // iOS Safari'de Blob+download sÄ±k sÄ±k sorun Ã§Ä±karÄ±yor
  try{
    const a = document.createElement("a");
    a.style.display = "none";
    if(useDataUrl){
      a.href = "data:text/tab-separated-values;charset=utf-8," + encodeURIComponent(text);
    }else{
      const blob = new Blob([text], {type:"text/tab-separated-values;charset=utf-8"});
      a.href = URL.createObjectURL(blob);
    }
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ try{ if(!useDataUrl) URL.revokeObjectURL(a.href); }catch{} a.remove(); }, 100);
  }catch(e){
    // Son Ã§are: yeni sekmede aÃ§
    try{ window.open("data:text/plain;charset=utf-8," + encodeURIComponent(text), "_blank"); }catch{}
  }
}
function safeFileName(s){
  return String(s||"").trim().replace(/[\\\/:*?"<>|]+/g,"-").slice(0,80) || "liste";
}

function toFiguranTSV(figList){
  const out = [["KiÅŸi","Kategori","GÃ¶revler","Oyunlar"]];
  (figList||[]).forEach(f=>{
    out.push([
      f.person,
      (f.cats||[]).join(", "),
      (f.roles||[]).join(", "),
      (f.plays||[]).join(" â€¢ ")
    ]);
  });
  return out.map(line=>line.map(v=>String(v??"").replace(/\t/g," ")).join("\t")).join("\n");
}
function toFiguranTSVFromSelected(){
  if(!selectedItem) return "";
  const rows = selectedItem.rows || [];
  const isFig = (r)=>{
    const cat = norm(r.category);
    const role = norm(r.role);
    return cat.includes("figuran") || role.includes("figuran");
  };
  const out = [["Oyun","KiÅŸi","GÃ¶rev","Kategori"]];
  rows.filter(isFig).forEach(r=>{
    out.push([r.play, r.person, r.role, r.category]);
  });
  // Excel iÃ§in TSV
  return out.map(line=>line.map(v=>String(v??"").replace(/\t/g," ")).join("\t")).join("\n");
}

els.downloadBtn && els.downloadBtn.addEventListener("click", ()=>{
  const tsv = toTSVFromSelected();
  if(!tsv){ setStatus("âš ï¸ Ã–nce bir Ã¶ÄŸe seÃ§", "warn"); return; }
  downloadText(`${safeFileName(selectedItem.title||"liste")}.tsv`, tsv);
  toast("Ä°ndiriliyorâ€¦");
});

els.figuranBtn && els.figuranBtn.addEventListener("click", ()=>{
  const tsv = toFiguranTSVFromSelected();
  if(!tsv || tsv.split("\n").length<=1){
    setStatus("âš ï¸ Bu seÃ§imde figÃ¼ran bulunamadÄ±.", "warn");
    return;
  }
  downloadText(`${safeFileName(selectedItem.title||"figuran")}-figuran.tsv`, tsv);
  toast("FigÃ¼ran listesi indiriliyorâ€¦");
});


// FigÃ¼ranlar sekmesinden indirme
els.figDownloadAllBtn && els.figDownloadAllBtn.addEventListener("click", ()=>{
  if(!figuran || !figuran.length){ setStatus("âš ï¸ FigÃ¼ran verisi yok.", "warn"); return; }
  const tsv = toFiguranTSV(figuran);
  copyText(tsv);
});
els.figDownloadFilteredBtn && els.figDownloadFilteredBtn.addEventListener("click", ()=>{
  const q=els.fq.value.trim().toLowerCase();
  const filtered = (figuran||[]).filter(f=>{
    if(!q) return true;
    const hay=(f.person+" "+(f.cats||[]).join(" ")+" "+f.plays.join(" ")+" "+f.roles.join(" ")).toLowerCase();
    return hay.includes(q);
  });
  if(!filtered.length){ setStatus("âš ï¸ Filtre sonucu yok.", "warn"); return; }
  const tsv = toFiguranTSV(filtered);
  copyText(tsv);
});
els.dq.addEventListener("input", renderDistribution);
els.dClear.addEventListener("click", ()=>{ els.dq.value=""; renderDistribution(); });

els.fq.addEventListener("input", renderFiguran);
els.fClear.addEventListener("click", ()=>{ els.fq.value=""; renderFiguran(); });

els.p1.addEventListener("change", renderIntersection);
els.p2.addEventListener("change", renderIntersection);
els.swapBtn.addEventListener("click", ()=>{
  const a=els.p1.value; els.p1.value=els.p2.value; els.p2.value=a;
  renderIntersection();
});

els.chartTabRoles.addEventListener("click", ()=>{
  chartMode="roles";
  els.chartTabRoles.classList.add("active");
  els.chartTabCats.classList.remove("active");
  closeDrawer();
  drawChart();
});
els.chartTabCats.addEventListener("click", ()=>{
  chartMode="cats";
  els.chartTabCats.classList.add("active");
  els.chartTabRoles.classList.remove("active");
  closeDrawer();
  drawChart();
});

window.addEventListener("resize", ()=>{
  if(rows.length && els.viewCharts.style.display!=="none"){ drawChart(); }
});

/* ---------- KPIs ---------- */
function renderKpis(){
  els.kpiPlays.textContent = String(plays.length || 0);
  const uniqPeople = new Set(rows.map(r=>r.person).filter(Boolean));
  els.kpiPeople.textContent = String(uniqPeople.size);
  els.kpiRows.textContent = String(rawRows.length);
  els.kpiFiguran.textContent = String(figuran.length || 0);
}

/* ---------- main load ---------- */
async function load(isAuto=false, forceRefresh=false){
  if(!isAuto) setStatus("â³ YÃ¼kleniyorâ€¦");
  // Skeleton
  if(els.list) els.list.innerHTML = `<div class="empty">â³ YÃ¼kleniyorâ€¦</div>`;
  if(els.details) els.details.innerHTML = `<div class="empty">â³ YÃ¼kleniyorâ€¦</div>`;
  activeId=null; selectedItem=null;

  try{
    // 1) Cache'den oku (5dk)
    const cached = cacheGet(CACHE_MAIN_KEY);
    const freshData = (!forceRefresh) ? cacheFresh(cached, 5*60*1000) : null;

    if(freshData){
      rawRows = freshData;
      const when = new Date(cached.timestamp).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
      setStatus(`âœ… HazÄ±r (cache) â€¢ ${when}`, "ok");
    }else{
      // 2) AÄŸdan Ã§ek (API â†’ GViz â†’ CSV)
      try{ rawRows = await tryLoadApiJsonp(); }
      catch(e1){
        try{ rawRows = await tryLoadGviz(); }
        catch(e2){ rawRows = await tryLoadCsv(); }
      }
      cacheSet(CACHE_MAIN_KEY, rawRows);
    }

    rows = expandRowsByPeople(rawRows);
    plays = groupByPlay(rows);
    people = groupByPerson(rows);
    roles = groupByRole(rows);
    playsList = plays.map(p=>p.title);

    renderList();
    renderDetails(null);

    distribution = computeDistribution();
    renderDistribution();

    retiredSet = computeRetiredSetFromRaw();
    figuran = computeFiguranFromRaw();
    renderFiguran();

    renderPlayOptions();
    renderIntersection();

    renderKpis();

    const when = new Date().toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
    setStatus(`âœ… HazÄ±r â€¢ ${when}`, "ok");

    // Bildirimleri (BÄ°LDÄ°RÄ°MLER) yÃ¼kle
    loadNotifications();
  }catch(err){
    console.error(err);
    // Offline fallback: cache varsa gÃ¶ster
    const cached = cacheGet(CACHE_MAIN_KEY);
    const cachedData = cached && cached.data;
    if(cachedData){
      rawRows = cachedData;
      rows = expandRowsByPeople(rawRows);
      plays = groupByPlay(rows);
      people = groupByPerson(rows);
      roles = groupByRole(rows);
      playsList = plays.map(p=>p.title);

      renderList();
      renderDetails(null);
      distribution = computeDistribution();
      renderDistribution();
      retiredSet = computeRetiredSetFromRaw();
      figuran = computeFiguranFromRaw();
      renderFiguran();
      renderPlayOptions();
      renderIntersection();
      renderKpis();

      const when = new Date(cached.timestamp).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
      setStatus(`âš ï¸ BaÄŸlantÄ± sorunu â€¢ Cache gÃ¶steriliyor â€¢ ${when}`, "warn");
      // bildirimleri deneyelim (ayrÄ± endpoint)
      try{ loadNotifications(); }catch(e){}
      return;
    }
    setStatus("â›” Veri yÃ¼klenemedi. Sheet paylaÅŸÄ±mÄ±nÄ± ve baÄŸlantÄ±yÄ± kontrol et.", "bad");
  }
}


/* ---------- KPI shortcuts (stabil veri Ã§ekmeyi BOZMADAN) ---------- */
function initKpiShortcuts(){
  // KPI kartlarÄ±nÄ±n tamamÄ± tÄ±klanabilir
  document.querySelectorAll(".kpi[data-go]").forEach(card=>{
    const act = ()=>{
      const go = card.getAttribute("data-go");
      const mode = card.getAttribute("data-mode");
      if(go==="Figuran"){ els.tabFiguran && els.tabFiguran.click(); return; }
      if(go==="Panel"){ els.tabPanel && els.tabPanel.click(); }
      if(mode==="plays"){ showAssignments=false; activeMode="plays"; activePlayFilter=null; }
      else if(mode==="people"){ showAssignments=false; activeMode="people"; activePlayFilter=null; }
      else if(mode==="rows" || mode==="assignments"){ showAssignments=true; activeMode="people"; activePlayFilter=null; }
      try{ if(els.qScope){ els.qScope.value = (activeMode==="plays"?"play":(activeMode==="people"?"person":(activeMode==="roles"?"role":"all"))); } }catch{};
    renderList(); renderDetails(null);
      window.scrollTo({top:0, behavior:"smooth"});
    };
    card.addEventListener("click", act);
    card.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); act(); } });
  });

  if(els.kpiPlays){
    els.kpiPlays.addEventListener("click", ()=>{
      showAssignments = false;
      els.btnPlays && els.btnPlays.click();
    });
  }
  if(els.kpiPeople){
    els.kpiPeople.addEventListener("click", ()=>{
      showAssignments = false;
      els.btnPeople && els.btnPeople.click();
    });
  }
  if(els.kpiRows){
    els.kpiRows.addEventListener("click", ()=>{
      showAssignments = true;
      els.btnPeople && els.btnPeople.click();
      // Liste meta satÄ±rÄ±nda oyun+gÃ¶rev Ã¶zetini gÃ¶ster
      renderList();
    });
  }
  if(els.kpiFiguran){
    els.kpiFiguran.addEventListener("click", ()=>{
      els.tabFiguran && els.tabFiguran.click();
    });
  }
  if(els.chartDownloadBtn){
    els.chartDownloadBtn.addEventListener("click", ()=>{
      // PDF indir: en stabil yÃ¶ntem = grafiÄŸi yeni pencerede aÃ§Ä±p yazdÄ±r (PDF olarak kaydet)
      els.tabCharts && els.tabCharts.click();

      const canvas = els.chartMain;
      try{
        if(canvas && canvas.toDataURL && getComputedStyle(canvas).display !== "none"){
          const dataUrl = canvas.toDataURL("image/png");
          const w = window.open("", "_blank");
          if(w){
            w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Ä°DT Grafik</title>
              <style>body{margin:0;font-family:Arial,sans-serif} img{max-width:100%;height:auto;display:block;margin:16px auto}
/* Mobile tap reliability */
#tabbar .tb{touch-action:manipulation;}
button, a{touch-action:manipulation;}
</style>
              </head><body><img src="${dataUrl}" alt="Grafik"></body></html>`);
            w.document.close();
            w.focus();
            setStatus("ğŸ§¾ PDF indir: AÃ§Ä±lan sekmede YazdÄ±r â†’ PDF olarak kaydet.", "ok");
            setTimeout(()=>{ try{ w.print(); }catch{} }, 250);
            return;
          }
        }
      }catch(err){
        console.warn(err);
      }

      // Fallback
      setStatus("ğŸ§¾ PDF indir: YazdÄ±r ekranÄ±nda 'PDF olarak kaydet' seÃ§.", "ok");
      requestAnimationFrame(()=>{ window.print(); });
    });
  }
}

// ---- expose critical functions (prevent scope issues) ----
try{ window.load = load; }catch(e){}
try{ window.renderDetails = renderDetails; }catch(e){}
try{ window.loadNotifications = loadNotifications; }catch(e){}
window.addEventListener('DOMContentLoaded', ()=>{
  try{ initKpiShortcuts(); }catch(e){console.error(e)}
  try{ initTabbar(); }catch(e){console.error(e)}
  try{ load(false); }catch(e){console.error(e)}
});


function applyRespStack(table){
  if(!table) return;
  table.classList.add("resp-stack");
  const ths = Array.from(table.querySelectorAll("thead th")).map(th=>th.textContent.trim());
  table.querySelectorAll("tbody tr").forEach(tr=>{
    Array.from(tr.children).forEach((td,i)=>{
      if(td && td.tagName==="TD") td.setAttribute("data-label", ths[i] || "");
    });
  });
}


function isMobile(){ return window.matchMedia("(max-width: 768px)").matches; }

function openNotif(){
  if(isMobile()){
    // Use mobile modal as a shell and render notifPanel inside it
    const panel = els.notifPanel;
    if(!panel) return;
    // clone to keep original in DOM
    const clone = panel.cloneNode(true);
    clone.id = "notifPanelMobile";
    clone.classList.remove("hidden");
    // wire close in clone
    clone.querySelector("#notifClose")?.addEventListener("click", closeMobileModal);
    openMobileModal("<div id='notifMount'></div>");
    const mount = document.getElementById("notifMount");
    if(mount){ mount.replaceWith(clone); }
    // click outside closes
    els.mobileOverlay.addEventListener("click", closeMobileModal, { once:true });
  }else{
    els.notifPanel.classList.toggle("hidden");
  }
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    toast("Panoya kopyalandÄ±!");
    return true;
  }catch(e){
    // On mobile / restricted clipboard: show manual modal
    openCopyModal(text);
    toast("Kopyalama iÃ§in manuel ekran aÃ§Ä±ldÄ±.");
    return false;
  }
}
</script>
<!-- Mobile detail modal -->
<div aria-hidden="true" class="overlay hidden" id="mobileOverlay"></div>
<div aria-label="Detay" aria-modal="true" class="modal hidden" id="mobileModal" role="dialog">
<div class="modalHead">
<div class="modalTitle">Detay</div>
<button class="btn sm" id="modalClose">Kapat</button>
</div>
<div class="modalBody" id="mobileContent"></div>
</div>
<!-- Mobile Tab Bar -->
<nav aria-label="Alt MenÃ¼" class="tabbar" id="tabbar">
<button class="tb active" data-tab="Panel" type="button"><span class="ico">ğŸ </span><span class="lbl">Panel</span></button>
<button class="tb" data-tab="Analiz" type="button"><span class="ico">ğŸ§©</span><span class="lbl">Analiz</span></button>
<button class="tb" data-tab="Figuran" type="button"><span class="ico">ğŸŸï¸</span><span class="lbl">FigÃ¼ran</span></button>
<button class="tb" data-tab="Grafikler" type="button"><span class="ico">ğŸ“ˆ</span><span class="lbl">Grafikler</span></button>
</nav>
<!-- Manual copy modal (Excel TSV) -->
<div aria-hidden="true" class="modal-backdrop hidden" id="copyModalBackdrop"></div>
<div aria-label="Kopyala" aria-modal="true" class="modal hidden" id="copyModal" role="dialog">
<div class="modal-head">
<div>
<div class="modal-title">Kopyala</div>
<div class="modal-sub">Ctrl+C / Kopyala â†’ Excel'de Ctrl+V</div>
</div>
<button aria-label="Kapat" class="btn btn-ghost" id="copyModalClose">âœ•</button>
</div>
<textarea class="modal-text" id="copyModalText" spellcheck="false"></textarea>
<div class="modal-foot">
<button class="btn" id="copyModalSelect">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
<button class="btn" id="copyModalCopy">Kopyala</button>
</div>
</div>
</body>
</html>
