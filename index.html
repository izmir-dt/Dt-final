<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Ä°zmir Devlet Tiyatrosu MÃ¼dÃ¼rlÃ¼ÄŸÃ¼ â€¢ Repertuvar KiÅŸi Takip Sistemi</title>
  <style>

:root{
      --bg:#e9ded1;            /* premium warm ivory */
      --card:#fbf7f1;
      --text:#16161a;
      --muted:#5a5560;
      --line:#dccbb7;

      --accent:#7a1e2c;        /* bordo */
      --accent2:#c07a2a;       /* altÄ±n */
      --ok:#18794e;
      --warn:#b45309;
      --bad:#b42318;
      --shadow:0 10px 30px rgba(24,16,8,.12);
      --radius:18px;
      --radius2:14px;
    }


/* --- Alias tokens (compat) --- */
:root{
  --r: var(--radius);
  --r2: var(--radius2);
  --good: var(--ok);
  --border: var(--line);
  --primary: var(--accent);
  --ink: var(--text);
  --chip: color-mix(in srgb, var(--card) 82%, var(--bg) 18%);
}
html[data-theme="dark"]{
  --border: var(--line);
  --primary: var(--accent);
  --ink: var(--text);
}
html[data-theme="dark"]{
      --bg:#0b1020;
      --card:#0f172a;
      --text:#f1f5f9;
      --muted:#cbd5e1;
      --line:#1f2a44;

      --accent:#60a5fa;
      --accent2:#93c5fd;

      --shadow: 0 18px 44px rgba(0,0,0,.55);
      --chip:#111827;

      --soft1:rgba(96,165,250,.14);
      --soft2:rgba(34,197,94,.14);
      --soft3:rgba(245,158,11,.14);
      --soft4:rgba(236,72,153,.14);

      --tabActiveBg: rgba(148,163,184,.12);
      --tabActiveBorder: rgba(148,163,184,.25);
      --tabActiveText: #f1f5f9;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, sans-serif;color:var(--text);background:var(--bg);}
    a{color:inherit}
    header{
      position:sticky;top:0;z-index:40;
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1220px;margin:0 auto;padding:16px}
    .top{display:flex;align-items:center;flex-wrap:wrap;
      padding:12px 16px;justify-content:space-between;gap:16px;}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:var(--shadow);
      display:grid;place-items:center;color:#fff;font-weight:900;
      letter-spacing:.6px;
    }
    .brand h1{margin:0;font-size:14px;line-height:1.25}
    .brand .sub{margin-top:3px;color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:nowrap;margin-left:auto;}

    .notif{position:relative}
    .badge{
      margin-left:6px;
      background:var(--accent);
      color:#fff;
      border-radius:999px;
      padding:2px 7px;
      font-size:11px;
      font-weight:800;
    }
    .hidden{display:none !important}
    .notifPanel{
      position:absolute;
      right:0;
      top:46px;
      width:min(520px, 92vw);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
      z-index:80;
    }
    .notifHd{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:flex;justify-content:flex-start;align-items:flex-start;gap:10px;
      background:linear-gradient(180deg,color-mix(in srgb, var(--card) 100%, transparent), color-mix(in srgb, var(--card) 92%, var(--bg) 8%));
    }
    .notifBd{max-height:60vh;overflow:auto;padding:12px}

    /* Mobilde bildirim paneli viewport dÄ±ÅŸÄ±na taÅŸmasÄ±n */
    @media (max-width: 760px){
      .notifPanel{
        position:fixed;
        top:76px;
        left:12px;
        right:12px;
        width:auto;
        max-height:78vh;
      }
      .notifBd{max-height:calc(78vh - 70px)}
    }
    .logItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      margin-bottom:8px;
      background:color-mix(in srgb, var(--card) 92%, var(--bg) 8%);
    }
    .logItem .meta{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;font-weight:700;
      background:var(--chip);
      color:var(--text);
      margin-left:8px;
      white-space:nowrap;
    }
    .tag.retired{
      border-color: color-mix(in srgb, var(--accent2) 35%, var(--line) 65%);
      background: color-mix(in srgb, var(--accent2) 10%, var(--card) 90%);
      color: color-mix(in srgb, var(--text) 60%, var(--accent) 40%);
    }

    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:var(--card);
      font-size:12px;color:var(--muted);
      display:flex;gap:8px;align-items:center;
      max-width:60vw; overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:9px 11px;border-radius:12px;
      cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;
      text-decoration:none;
      font-size:13px;
    }
    .btn:hover{border-color:color-mix(in srgb, var(--line) 55%, var(--accent) 45%)}
    .btn.primary{border-color:color-mix(in srgb, var(--accent) 35%, var(--line) 65%);background:color-mix(in srgb, var(--accent) 8%, var(--card) 92%);color:var(--accent2)}
    .btn.good{border-color:color-mix(in srgb, var(--good) 30%, var(--line) 70%);background:color-mix(in srgb, var(--good) 7%, var(--card) 93%);color:var(--good)}

    .nav{
      display:flex;gap:8px;flex-wrap:wrap;
      padding:0 16px 12px;
    }
    .tab{
      padding:9px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      cursor:pointer;font-size:13px;
    }
    .tab.active{
      border-color:var(--tabActiveBorder);
      background:var(--tabActiveBg);
      color:var(--tabActiveText);
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:flex-start;gap:10px;flex-wrap:wrap;
      background:linear-gradient(180deg,color-mix(in srgb, var(--card) 100%, transparent), color-mix(in srgb, var(--card) 92%, var(--bg) 8%));
    }
    .card .hd h2{margin:0;font-size:14px}
    .card .bd{padding:12px}
    .grid{display:grid;gap:12px;grid-template-columns: 1.1fr .9fr;margin-top:12px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} header{position:relative} }

    .kpis{
      display:grid;gap:12px;
      grid-template-columns:repeat(4,1fr);
      margin-bottom:12px;
    }
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr)}}
    @media (max-width: 520px){ .kpis{grid-template-columns:1fr}}
    .kpi{
display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  padding:18px 18px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.06);
  box-shadow: var(--shadow);
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:22px;font-weight:900;letter-spacing:.2px}
    .kpi .icon{
width:48px;
  height:48px;
  display:grid;
  place-items:center;
  border-radius:14px;
  font-size:26px; /* bigger icon */
  line-height:1;
  flex:0 0 auto;
  margin-left:18px;
  background: rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.06);
}
.kpi > div:first-child{flex:1; min-width:0;}

    .kpi.soft1{background:linear-gradient(135deg,var(--soft1), var(--card));}
    .kpi.soft2{background:linear-gradient(135deg,var(--soft2), var(--card));}
    .kpi.soft3{background:linear-gradient(135deg,var(--soft3), var(--card));}
    .kpi.soft4{background:linear-gradient(135deg,var(--soft4), var(--card));}

    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;flex:1;justify-content:center;margin-left:auto;margin-right:auto}
    .input{
      display:flex;align-items:center;gap:8px;min-width:260px;max-width:560px;flex:0 1 560px;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      min-width: 190px;
      max-width: 640px;
      flex:1 1 260px;
    }
    .input input, .input select{
      width:100%;background:transparent;border:0;outline:0;
      color:var(--text);font-size:14px;
      appearance:none;
    }
    /* Dark-mode select dropdown readability */
    select, option{
      color:var(--text);
      background: color-mix(in srgb, var(--card) 95%, var(--bg) 5%);
    }
    html[data-theme="dark"] select, html[data-theme="dark"] option{
      background:#0f172a;
      color:#e5e7eb;
    }

    .seg{
      display:inline-flex;align-items:center;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background:var(--card);
    }
    .seg button{
      border:0;background:transparent;color:var(--muted);
      padding:10px 12px;cursor:pointer;font-size:13px;
    }
    .seg button.active{
      color:var(--text);
      background: color-mix(in srgb, var(--card) 78%, var(--bg) 22%);
      font-weight:800;
    }

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      padding:12px;border-radius:var(--r2);
      border:1px solid var(--line);
      background:var(--card);
      cursor:pointer;
    }
    .item:hover{border-color:color-mix(in srgb, var(--line) 60%, var(--accent) 40%)}
    .item .t{display:flex;align-items:flex-start;justify-content:flex-start;gap:10px}
    .name{font-weight:850; letter-spacing:.2px}
    .meta{margin-top:4px;color:var(--muted);font-size:12px}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .chip{
      padding:6px 9px;border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      font-size:12px;color:var(--muted);
      max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .chip.warn{border-color:color-mix(in srgb, var(--warn) 30%, var(--line) 70%);background:color-mix(in srgb, var(--warn) 10%, var(--chip) 90%);color:color-mix(in srgb, var(--warn) 65%, var(--text) 35%)}
    .chip.good{border-color:color-mix(in srgb, var(--good) 30%, var(--line) 70%);background:color-mix(in srgb, var(--good) 10%, var(--chip) 90%);color:var(--good)}
    .chip.bad{border-color:color-mix(in srgb, var(--bad) 30%, var(--line) 70%);background:color-mix(in srgb, var(--bad) 10%, var(--chip) 90%);color:var(--bad)}
    .empty{
      padding:16px;border-radius:14px;
      border:1px dashed color-mix(in srgb, var(--line) 70%, var(--muted) 30%);
      color:var(--muted);text-align:center;
      background:var(--card);
    }
    .title{margin:0 0 6px;font-size:18px}
    .subtitle{margin:0 0 12px;color:var(--muted);font-size:13px}

    .table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      border:1px solid var(--line);
      border-radius:14px;overflow:hidden;
      background:var(--card);
    }
    .table th,.table td{
      padding:10px 10px;border-bottom:1px solid var(--line);
      text-align:left;font-size:13px;vertical-align:top;
    }
    .table th{color:var(--muted);font-weight:800;background:color-mix(in srgb, var(--card) 70%, var(--bg) 30%)}
    .table tr:last-child td{border-bottom:0}
    footer{padding:12px 14px;color:var(--muted);font-size:12px;border-top:1px solid var(--line);background:var(--card)}
    code{background:color-mix(in srgb, var(--card) 70%, var(--bg) 30%);padding:2px 6px;border-radius:8px;border:1px solid var(--line)}
    .small{color:var(--muted);font-size:12px}

    /* Charts */
    .chartsNav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .chartsNav .tab{border-radius:999px}
    canvas{width:100%;height:340px;display:block;border-radius:14px;border:1px solid var(--line);background:var(--card);cursor:pointer}

    .drawer{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:var(--card);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:sticky; top:98px;
      height: fit-content;
      min-height: 140px;
    }
    .drawer .hd{padding:12px;border-bottom:1px solid var(--line);display:flex;justify-content:flex-start;gap:10px;align-items:center}
    .drawer .bd{padding:12px}
    .drawer.hidden{display:none}
    .drawerTitle{font-weight:900}
    .drawerSub{color:var(--muted);font-size:12px;margin-top:2px}
    .miniList{display:flex;flex-direction:column;gap:8px;margin-top:10px;max-height:60vh;overflow:auto}
    .miniItem{border:1px solid var(--line);border-radius:14px;padding:10px;background:color-mix(in srgb, var(--card) 88%, var(--bg) 12%)}
    .miniItem b{display:block}
  

    /* ---- UI tweaks ---- */
    .seg button{ padding:12px 16px; font-size:15px; }
    .seg button.active{ box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 55%, transparent); }
    input, select, textarea{ color: var(--text); background: var(--card); border:1px solid var(--border); }
    input::placeholder, textarea::placeholder{ color: color-mix(in srgb, var(--text) 45%, transparent); }
    table{ color: var(--text); }
    th, td{ color: var(--text); }
    .muted{ color: var(--muted); }

    /* Mobile detail as modal */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:50; }
    .modal{ position:fixed; left:50%; transform:translateX(-50%); bottom:12px; width:min(980px, calc(100% - 24px));
            max-height:80vh; background:var(--card); border:1px solid var(--border); border-radius:16px; z-index:60;
            box-shadow: 0 20px 60px rgba(0,0,0,.25); overflow:hidden; }
    .modalHead{ display:flex; align-items:center; justify-content:flex-start; padding:12px 12px; border-bottom:1px solid var(--border); }
    .modalTitle{ font-weight:800; }
    .modalBody{ padding:12px; overflow:auto; max-height:calc(80vh - 54px); }
    .hidden{ display:none !important; }

    @media (min-width: 981px){
      /* Desktop: keep modal hidden */
      #mobileModal, #mobileOverlay{ display:none !important; }
    }

/* --- UI sadeleÅŸtirme: sadece Panel + Grafikler --- */
.tabs button#tabDistribution,
.tabs button#tabIntersection,
.tabs button#tabFiguran { display:none !important; }

/* Dark mode dÃ¼ÄŸmesini gizle (tema sabit) */


/* Mobilde detay modalÄ± daha geniÅŸ ve okunur */
@media (max-width: 900px){
  .modal{ width:min(92vw, 720px) !important; }
  .modalContent{ max-height: 75vh !important; overflow:auto; }

  /* Grafikler: mobilde tek kolon + Ã§izimler taÅŸmasÄ±n */
  #viewCharts .grid{ grid-template-columns: 1fr !important; }
  /* Mobilde canvas yerine dokunmatik liste kullanacaÄŸÄ±z */
  #chartMain{ display:none !important; }
  canvas{ max-width:100%; height:auto; }

  /* Mobil modal iÃ§indeki tablolar yatay kaydÄ±rÄ±labilir olsun */
  #mobileModalBd table{ display:block; width:100%; overflow-x:auto; }
}

/* ---- Mobil Grafik Listesi (Canvas alternatifi) ---- */
.mobileChartWrap{ display:none; }
.mobileChartList{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
.chipRow{ display:flex; align-items:center; justify-content:flex-start; gap:10px; padding:12px 12px; border-radius:14px; cursor:pointer; user-select:none;
  border:1px solid rgba(0,0,0,.08); box-shadow: 0 6px 20px rgba(0,0,0,.06); }
.chipLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
.dot{ width:14px; height:14px; border-radius:999px; flex:0 0 14px; box-shadow:0 0 0 4px rgba(255,255,255,.35) inset; }
.chipTitle{ font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:62vw; }
.chipCount{ font-weight:900; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.55); border:1px solid rgba(255,255,255,.35); }

@media (max-width: 900px){
  .mobileChartWrap{ display:block; }
}

/* Grafik yazÄ±larÄ± daha okunur */
.chartWrap svg text{ font-size: 12px; fill: var(--text); }


/* --- Notifications (chat bubble) --- */
.notif-bubble{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;margin:10px 0;border-radius:14px;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06);box-shadow:0 8px 18px rgba(0,0,0,.06);cursor:pointer}
.notif-bubble:hover{transform:translateY(-1px)}
.notif-bubble.seen{opacity:.62}
.notif-type{width:34px;height:34px;display:flex;align-items:center;justify-content:center;margin-left:auto;margin-right:auto;border-radius:10px;background:rgba(0,0,0,.04);font-size:16px;flex:0 0 34px}
.notif-title{font-weight:700;margin-bottom:2px}
.notif-msg{margin:2px 0 6px 0}
.notif-meta{font-size:12px;opacity:.8}
.notif-ts{font-size:11px;opacity:.65;margin-top:6px}

/* Mobil breadcrumb (oyun -> ekip) */
.mobile-breadcrumb{display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:8px 10px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.55);backdrop-filter: blur(6px);}
.mobile-breadcrumb .mb-text{font-weight:600;color:var(--ink);opacity:.9}
@media (max-width: 980px){
  .mobile-breadcrumb{position:sticky;top:8px;z-index:5}
}



    /* --- Responsive: mobilde canvas gizle, renkli liste gÃ¶ster --- */
    @media (max-width: 820px){
  #chartMain{ display:none !important; }
  .mobileChartWrap{ display:block !important; }
  .drawer{ position:relative !important; top:auto !important; inset:auto !important; border-radius: var(--r) !important; z-index:auto !important; }
}
.miniItem{ padding:14px !important; }
      .miniItem b{ font-size:16px; }
    }



body.drawerOpen{ overflow:auto; }



/* Enforce theme text colors */
body{ background:var(--bg); color:var(--text); }
a{ color:inherit; }
.table th, .table td{ color:var(--text); }
.btn{ color:var(--text); }
.input input, .input select, input, select, textarea{ color:var(--text); background:transparent; }



    /* Dark mode â€“ bazÄ± tarayÄ±cÄ±larda siyah kalan metinleri zorla dÃ¼zelt */
    html[data-theme="dark"] body{ color: var(--text); }
    html[data-theme="dark"] button,
    html[data-theme="dark"] input,
    html[data-theme="dark"] select,
    html[data-theme="dark"] textarea,
    html[data-theme="dark"] option,
    html[data-theme="dark"] label,
    html[data-theme="dark"] summary,
    html[data-theme="dark"] .btn,
    html[data-theme="dark"] .input,
    html[data-theme="dark"] .table,
    html[data-theme="dark"] .table td,
    html[data-theme="dark"] .table th,
    html[data-theme="dark"] .modal,
    html[data-theme="dark"] .drawer{
      color: var(--text);
    }
    html[data-theme="dark"] .subtitle,
    html[data-theme="dark"] .muted,
    html[data-theme="dark"] .pill,
    html[data-theme="dark"] footer{
      color: var(--muted);
    }
    /* Safari/Chrome autofill siyah yazÄ± bug'Ä± */
    html[data-theme="dark"] input:-webkit-autofill,
    html[data-theme="dark"] textarea:-webkit-autofill,
    html[data-theme="dark"] select:-webkit-autofill{
      -webkit-text-fill-color: var(--text) !important;
      transition: background-color 999999s ease-in-out 0s;
    }
    /* SVG iÃ§inde text (ikon vb.) */
    html[data-theme="dark"] svg text{ fill: var(--text); }



    #distributionBox th:nth-child(2){white-space:nowrap; width:110px}


/* UX: tÄ±klanabilir liste Ã¶ÄŸeleri */
.miniItem, .miniRow{
  cursor:pointer;
}
.miniItem:hover, .miniRow:hover{
  filter: brightness(1.04);
}

@media (max-width: 720px){.actions{flex-wrap:wrap;margin-left:0} .top{flex-wrap:wrap;justify-content:flex-start}}

/* --- Polishing: arama scope + temizle --- */
.input{position:relative}
.q-scope{
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--card) 90%, var(--bg) 10%);
  color:var(--text);
  border-radius:10px;
  padding:8px 10px;
  font-size:12px;
  font-weight:700;
  max-width:140px;
}
.q-clear{
  border:0;
  background:transparent;
  color:var(--muted);
  cursor:pointer;
  font-size:16px;
  line-height:1;
  padding:6px 8px;
  border-radius:10px;
}
.q-clear:hover{ background: color-mix(in srgb, var(--card) 75%, var(--bg) 25%); color:var(--text); }

/* --- Polishing: GeliÅŸmiÅŸ menÃ¼sÃ¼ --- */
.menu{ position:relative; }
.menuPanel{
  position:absolute;
  right:0;
  top:46px;
  width:min(280px, 92vw);
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  box-shadow:var(--shadow);
  overflow:hidden;
  z-index:90;
}
.menuPanel .mi{
  padding:10px 12px;
  cursor:pointer;
  border-bottom:1px solid var(--line);
  display:flex; align-items:center; justify-content:space-between;
  font-weight:700;
}
.menuPanel .mi:last-child{border-bottom:0}
.menuPanel .mi:hover{ background: color-mix(in srgb, var(--card) 78%, var(--bg) 22%); }
.menuPanel .mi small{ color:var(--muted); font-weight:600; }

/* Mobil: modal head sticky */
@media (max-width: 980px){
  .modalHead{ position:sticky; top:0; background:var(--card); z-index:2; }
}


/* --- Mobile polishing (layout fixes) --- */
@media (max-width: 760px){
  .top{flex-direction:column; align-items:flex-start; gap:10px; padding:10px 12px;}
  .brand h1{font-size:13px; line-height:1.25;}
  .actions{width:100%; flex-wrap:wrap; justify-content:flex-start; gap:8px; margin-left:0;}
  .pill{max-width:100%; width:100%;}
  .btn{padding:9px 10px; border-radius:12px;}
  .wrap{padding:12px;}
  .kpis{grid-template-columns:repeat(2,1fr);}
  .kpi{padding:14px 14px;}
}
/* Tabs: yatay kaydÄ±rma (mobil) */
@media (max-width: 980px){
  .nav{overflow-x:auto; -webkit-overflow-scrolling:touch; flex-wrap:nowrap; gap:8px; padding-bottom:10px;}
  .nav::-webkit-scrollbar{display:none;}
  .tab{white-space:nowrap;}
}
/* Mobile chart list visuals */
@media (max-width: 900px){
  .chipRow{border:1px solid color-mix(in srgb, var(--line) 75%, transparent); }
  .chipTitle{max-width:58vw;}
}

/* --- Mobile nav: scrollable & Intersection visible --- */
@media (max-width: 980px){
  .nav{overflow-x:auto; -webkit-overflow-scrolling:touch; flex-wrap:nowrap; gap:8px; padding-bottom:10px;}
  .nav::-webkit-scrollbar{display:none;}
  .tab{white-space:nowrap;}
  #tabIntersection{order:2;}
  #tabFiguran{order:3;}
  #tabCharts{order:4;}
  #tabDistribution{order:5;}
}
/* --- Overflow safety: no clipped text --- */
*{ overflow-wrap:anywhere; }
.name,.meta,.chip,.pill,.btn,.tab,.drawerTitle,.drawerSub,.miniItem b,.miniItem div{ word-break:break-word; }
.chip,.pill{ max-width:100%; white-space:normal; text-overflow:clip; }
.table{ display:block; width:100%; overflow-x:auto; }
.table th,.table td{ white-space:nowrap; }
@media (min-width: 981px){
  .table{ display:table; overflow:visible; }
  .table th,.table td{ white-space:normal; }
}
/* --- Arama kapsamÄ±: gÃ¶rÃ¼nÃ¼r kutucuk --- */
.qScopeBox{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border:1px solid var(--line);
  border-radius:12px;
  background: color-mix(in srgb, var(--card) 86%, var(--bg) 14%);
}
select.q-scope{
  border:0;
  background:transparent;
  padding:6px 6px;
  font-weight:900;
  font-size:13px;
  color:var(--text);
  outline:none;
  cursor:pointer;
}

/* input satÄ±rÄ±nda dÃ¼zgÃ¼n hizalama */
.filters .input{ gap:10px; flex-wrap:wrap; }
.filters .input input{ flex:1 1 220px; min-width:220px; }

/* Sadece mobilde Ek AraÃ§lar butonunu kaldÄ±r */

/* --- Kapsam seÃ§ici: label kalktÄ±, ok eklendi --- */
.qScopeBox{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background: color-mix(in srgb, var(--card) 86%, var(--bg) 14%);
}
.qScopeBox::after{
  content:"â–¾";
  font-weight:900;
  color:var(--muted);
  margin-left:2px;
}
select.q-scope{
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  border:0;
  background:transparent;
  padding:6px 0;
  font-weight:900;
  font-size:13px;
  color:var(--text);
  outline:none;
  cursor:pointer;
}


/* --- MasaÃ¼stÃ¼ sekme sÄ±rasÄ±: Grafikler 1, Panel 2 --- */
.nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
#tabCharts{order:1;}
#tabPanel{order:2;}
#tabDistribution{order:3;}
#tabIntersection{order:4;}
#tabFiguran{order:5;}
#advBtn{order:6;}


/* =========================
   v26 HOTFIX (SAFE)
   - Ek AraÃ§lar tamamen kaldÄ±r (CSS ile gizle, JS kÄ±rÄ±lmasÄ±n)
   - KesiÅŸim: tek satÄ±r + modern numara badge
   - Kapsam oku hizasÄ± iyileÅŸtir
   ========================= */

/* Ek AraÃ§lar: tamamen gizle */
#advBtn, #advMenu { display:none !important; }
.menu { display:none !important; } /* ek araÃ§lar menÃ¼sÃ¼ komple */

/* Kapsam seÃ§ici ok hizasÄ± (override) */
.qScopeBox{ position:relative; }
.qScopeBox::after{
  content:"â–¾";
  position:absolute; right:10px; top:50%;
  transform:translateY(-50%);
  pointer-events:none;
  font-weight:900;
  color:var(--muted);
}
select.q-scope{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  padding-right:28px !important;
}

/* KesiÅŸim: input satÄ±rÄ± tek satÄ±r */
#viewIntersection .filters .input{
  display:flex !important;
  align-items:center !important;
  gap:10px !important;
  flex-wrap:nowrap !important;
  white-space:nowrap;
}
#viewIntersection .filters .input select{
  min-width:0 !important;
  flex:1 1 auto !important;
}
.numBadge{
  width:26px;height:26px;display:grid;place-items:center;
  border-radius:10px;font-weight:900;font-size:13px;
  background: color-mix(in srgb, var(--accent) 10%, var(--card) 90%);
  border:1px solid color-mix(in srgb, var(--accent) 22%, var(--line) 78%);
  color: var(--accent);
  flex:0 0 auto;
}

/* =========================
   NOTIFICATIONS: CONTRAST FIX (v28)
   ========================= */
#notifBell{ position:relative; }
#notifBtn{
  display:inline-flex;
  align-items:center;
  gap:8px;
}
#notifBadge{
  min-width:20px;
  height:20px;
  padding:0 6px;
  border-radius:999px;
  font-weight:900;
  font-size:12px;
  line-height:20px;
  color: var(--card);
  background: var(--bad);
}
#notifPanel{
  position:absolute;
  right:0;
  top:calc(100% + 10px);
  width:min(420px, calc(100vw - 24px));
  max-height:420px;
  overflow:auto;
  border:1px solid var(--line);
  border-radius:14px;
  background: var(--card);
  color: var(--text);
  box-shadow: var(--shadow);
  padding:10px;
  z-index:999;
}
.notifItem{
  border:1px solid color-mix(in srgb, var(--line) 70%, transparent 30%);
  border-radius:12px;
  padding:10px 12px;
  margin:8px 0;
  background: color-mix(in srgb, var(--card) 88%, var(--bg) 12%);
  color: var(--text);
}
.notifTop{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
  margin-bottom:6px;
}
.notifTop b{ color: var(--text); }
.notifTop .muted,
.notifItem .muted{
  color: var(--muted) !important;
  opacity:1 !important;
}
.notifItem div{ color: var(--text); }

/* dark theme: ensure panel stays dark but text stays light */
html[data-theme="dark"] #notifPanel{
  background: color-mix(in srgb, var(--card) 92%, #000 8%);
  border-color: color-mix(in srgb, var(--line) 70%, #000 30%);
}

/* =========================
   NOTIF BUBBLES THEME FIX (v30)
   Fix: dark theme had white text on light bubble background.
   ========================= */

/* Base (light) */
#notifPanel .notif-bubble{
  background: #ffffff !important;
  color: #0f172a !important;
}
#notifPanel .notif-title,
#notifPanel .notif-msg,
#notifPanel .notif-meta,
#notifPanel .notif-ts{
  color:#0f172a !important;
}
#notifPanel .notif-meta{ color:#334155 !important; opacity:1 !important; }
#notifPanel .notif-ts{ color:#64748b !important; opacity:1 !important; }
#notifPanel .notif-type{
  background: rgba(15,23,42,.06) !important;
}

/* Seen state: don't fade text; just soften bg */
#notifPanel .notif-bubble.seen{
  opacity:1 !important;
  background: #f8fafc !important;
  border-color: rgba(15,23,42,.08) !important;
}

/* Dark theme */
html[data-theme="dark"] #notifPanel{
  background: rgba(11,16,32,.96) !important;
  color:#f8fafc !important;
}
html[data-theme="dark"] #notifPanel .notif-bubble{
  background: rgba(30,41,59,.92) !important;
  border-color: rgba(148,163,184,.18) !important;
  color:#f8fafc !important;
}
html[data-theme="dark"] #notifPanel .notif-title,
html[data-theme="dark"] #notifPanel .notif-msg{
  color:#f8fafc !important;
}
html[data-theme="dark"] #notifPanel .notif-meta{
  color:#cbd5e1 !important;
  opacity:1 !important;
}
html[data-theme="dark"] #notifPanel .notif-ts{
  color:#94a3b8 !important;
  opacity:1 !important;
}
html[data-theme="dark"] #notifPanel .notif-type{
  background: rgba(255,255,255,.08) !important;
}
html[data-theme="dark"] #notifPanel .notif-bubble.seen{
  opacity:1 !important;
  background: rgba(30,41,59,.72) !important;
}
</style>
</head>
<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo">IDT</div>
      <div>
        <h1>Ä°zmir Devlet Tiyatrosu MÃ¼dÃ¼rlÃ¼ÄŸÃ¼<br>Repertuvar KiÅŸi Takip Sistemi<br>Sanat Teknik BÃ¼rosu</h1>
        </div>
    </div>
    <div class="actions">
      <button class="btn" id="themeBtn" title="AydÄ±nlÄ±k/KaranlÄ±k">ğŸŒ“ Tema</button>
      <span id="status" class="pill">â³ YÃ¼kleniyorâ€¦</span>
      <button class="btn" id="reloadBtn">â†» Yenile</button>

      <div class="menu">
        <button class="btn" id="advBtn" title="Ek AraÃ§lar">ğŸ§° Ek AraÃ§lar</button>
        <div class="menuPanel hidden" id="advMenu" role="menu" aria-label="Ek AraÃ§lar">
          <div class="mi" id="advDist">ğŸ“Š DaÄŸÄ±lÄ±m <small>Oyunlara gÃ¶re</small></div>
          <div class="mi" id="advInter">ğŸ§© KesiÅŸim <small>2 oyun</small></div>
        </div>
      </div>

      <div class="notif">
        <button class="btn" id="notifBtn" title="Bildirimler (LOG)">
          ğŸ”” Bildirimler <span class="badge hidden" id="notifCount">0</span>
        </button>
        <div class="notifPanel hidden" id="notifPanel" role="dialog" aria-label="Bildirimler">
          <div class="notifHd">
            <div>
              <b>Bildirimler</b>
              <div class="small">Kaynak: BÄ°LDÄ°RÄ°MLER (Google Sheets)</div>
            </div>
            <div class="row" style="gap:8px">
              <button class="btn" id="notifRefresh">â†»</button>
              <button class="btn" id="notifClose">âœ•</button>
            </div>
          </div>
          <div class="notifBd" id="notifList">
            <div class="empty">LOG okunuyorâ€¦</div>
          </div>
        </div>
      </div>
      <a class="btn primary" id="sheetBtn" href="#" target="_blank" rel="noreferrer">ğŸ“„ Google Sheetâ€™i AÃ§</a>
    </div>
  </div>

  <div class="nav">
    <button class="tab active" id="tabPanel">Panel</button>
    <button class="tab" id="tabDistribution">Oyunlara GÃ¶re Personel DaÄŸÄ±lÄ±mÄ±</button>
    <button class="tab" id="tabIntersection">KesiÅŸim Analizi</button>
    <button class="tab" id="tabFiguran">FigÃ¼ranlar</button>
    <button class="tab" id="tabCharts">Grafikler</button>
  </div>
</header>

<div class="wrap">
  <div class="kpis" id="kpis">
    <div class="kpi soft1"><div><div class="label">Aktif Oyun</div><div class="value" id="kpiPlays">-</div></div><div class="icon">ğŸ­</div></div>
    <div class="kpi soft2"><div><div class="label">Toplam Personel</div><div class="value" id="kpiPeople">-</div></div><div class="icon">ğŸ‘¥</div></div>
    <div class="kpi soft3"><div><div class="label">GÃ¶rev AtamasÄ± (SatÄ±r)</div><div class="value" id="kpiRows">-</div></div><div class="icon">ğŸ§¾</div></div>
    <div class="kpi soft4"><div><div class="label">FigÃ¼ran</div><div class="value" id="kpiFiguran">-</div></div><div class="icon">ğŸŸï¸</div></div>
  </div>

  <!-- PANEL -->
  <section id="viewPanel">
    <div class="card">
      <div class="hd">
        <h2>Liste</h2>
        <div class="filters">
          <div class="input" title="Ara">
            ğŸ” <input id="q" type="search" placeholder="Oyun / kiÅŸi / gÃ¶rev araâ€¦" autocomplete="off"/>
            <div class="qScopeBox"><select id="qScope" class="q-scope" title="Arama kapsamÄ±">
              <option value="all">TÃ¼mÃ¼</option>
              <option value="play">Oyun</option>
              <option value="person">KiÅŸi</option>
              <option value="role">GÃ¶rev</option>
            </select></div>
            <button class="q-clear" id="qClear" title="Temizle">âœ•</button>
          </div>
<div class="seg" title="GÃ¶rÃ¼nÃ¼m">
            <button id="btnPlays" class="active">ğŸ­ Oyunlar</button>
            <button id="btnPeople">ğŸ‘¥ KiÅŸiler</button>
          </div>

          <button class="btn" id="clearBtn">Temizle</button>
        </div>
      </div>
      <div class="bd">
        <div class="grid">
          <div>
            <div class="list" id="list"></div>
            <div class="small" id="hint" style="margin-top:10px"></div>
          </div>
          <div class="card" style="box-shadow:none">
            <div class="hd">
              <h2>Detay</h2>
              <button class="btn" id="copyBtn">ğŸ“‹ Kopyala (Excel)</button>
</div>
            <div class="bd" id="details">
              <div class="empty">Soldan bir oyun veya kiÅŸi seÃ§.</div>
            </div>
            <footer>
              <div><b>CanlÄ±:</b> Sheetâ€™te yaptÄ±ÄŸÄ±n deÄŸiÅŸiklikler <b>yenileyince</b> gelir.</div>
              <div style="margin-top:6px"><b>PaylaÅŸÄ±m:</b> Sheet â†’ PaylaÅŸ â†’ <code>BaÄŸlantÄ±ya sahip herkes: GÃ¶rÃ¼ntÃ¼leyebilir</code></div>
            </footer>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- OYUNLARA GÃ–RE PERSONEL DAÄILIMI -->
  <section id="viewDistribution" style="display:none">
    <div class="card">
      <div class="hd">
        <h2>Oyunlara GÃ¶re Personel DaÄŸÄ±lÄ±mÄ±</h2>
        <div class="small">AynÄ± personelin birden fazla oyunda yer almasÄ± â€œdaÄŸÄ±lÄ±m yoÄŸunluÄŸuâ€ olarak listelenir.</div>
      </div>
      <div class="bd">
        <div class="filters" style="margin-bottom:10px">
          <div class="input" title="Ara">
            ğŸ” <input id="dq" type="search" placeholder="KiÅŸi veya oyun araâ€¦" autocomplete="off"/>
          </div>
          <button class="btn" id="dClear">Temizle</button>
        </div>
        <div id="distributionBox"></div>
      </div>
    </div>
  </section>

  <!-- KESÄ°ÅÄ°M -->
  <section id="viewIntersection" style="display:none">
    <div class="card">
      <div class="hd">
        <h2>KesiÅŸim Analizi</h2>
        <div class="small">Ä°ki oyunu seÃ§ â€” ortak personeli ve gÃ¶revlerini gÃ¶sterir.</div>
      </div>
      <div class="bd">
        <div class="filters" style="margin-bottom:10px">
          <div class="input" title="1. Oyun">
            1ï¸âƒ£
            <select id="p1"></select>
          </div>
          <div class="input" title="2. Oyun">
            2ï¸âƒ£
            <select id="p2"></select>
          </div>
          <button class="btn" id="swapBtn">â‡„ DeÄŸiÅŸtir</button>
        </div>
        <div id="intersectionBox"></div>
      </div>
      <footer>
        Not: KesiÅŸim iÃ§in kiÅŸi hÃ¼cresindeki â€œvirgÃ¼l / ve / / / satÄ±r sonuâ€ ayrÄ±mlarÄ± otomatik yapÄ±lÄ±r.
      </footer>
    </div>
  </section>

  <!-- FÄ°GÃœRAN -->
  <section id="viewFiguran" style="display:none">
    <div class="card">
      <div class="hd">
        <h2>FigÃ¼ranlar</h2>
        <div class="small">Apps Script mantÄ±ÄŸÄ±yla: Ã§oklu kiÅŸi varsa sadece <code>(FigÃ¼ran)</code> etiketi olanlar alÄ±nÄ±r.</div>
      </div>
      <div class="bd">
        <div class="filters" style="margin-bottom:10px">
          <div class="input" title="Ara">
            ğŸ” <input id="fq" type="search" placeholder="FigÃ¼ran / oyun araâ€¦" autocomplete="off"/>
          </div>
          <button class="btn" id="figDownloadAllBtn">ğŸ“‹ Excelâ€™e Kopyala (TÃ¼mÃ¼)</button>
                    <button class="btn" id="fClear">Temizle</button>
        </div>
        <div id="figuranBox"></div>
      </div>
    </div>
  </section>

  <!-- GRAFÄ°KLER -->
  <section id="viewCharts" style="display:none">
    <div class="chartsNav">
      <button class="tab active" id="chartTabRoles">GÃ¶revlere GÃ¶re DaÄŸÄ±lÄ±m</button>
      <button class="tab" id="chartTabCats">Kategori DaÄŸÄ±lÄ±mÄ±</button>
    </div>

    <div class="grid" style="grid-template-columns: 1.1fr .9fr">
      <div class="card">
        <div class="hd">
          <h2 id="chartTitle">GÃ¶revlere GÃ¶re DaÄŸÄ±lÄ±m</h2>
          <div class="small" id="chartHint">Ä°pucu: grafik dilimine/bara tÄ±kla â†’ saÄŸda liste aÃ§Ä±lÄ±r.</div>
        </div>
        <div class="bd">
          <canvas id="chartMain" width="900" height="340"></canvas>
          <div class="mobileChartWrap">
            <div class="small" style="margin:10px 0 6px">Mobil ipucu: kategoriye dokun â†’ detay listesi aÃ§Ä±lÄ±r.</div>
            <div class="mobileChartList" id="chartMobileList"></div>
          </div>
        </div>
      </div>

      <aside class="drawer hidden" id="chartDrawer">
        <div class="hd">
          <div>
            <div class="drawerTitle" id="drawerTitle">SeÃ§im</div>
            <div class="drawerSub" id="drawerSub">â€”</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" id="drawerCopyAll" title="Excel'e Kopyala (Ã–zet)" style="display:none">Excelâ€™e Kopyala (Ã–zet)</button>
            <button class="btn" id="drawerCopyVisible" title="Excel'e Kopyala (GÃ¶rÃ¼nen)" style="display:none">Excelâ€™e Kopyala (GÃ¶rÃ¼nen)</button>
            <button class="btn" id="drawerCopyExpanded" title="Excel'e Kopyala (SatÄ±r SatÄ±r)" style="display:none">Excelâ€™e Kopyala (SatÄ±r SatÄ±r)</button>
            <button class="btn" id="drawerBack" title="Geri" style="display:none">â†</button>
            <button class="btn" id="drawerClose">âœ•</button>
          </div>
        </div>
        <div class="bd">
          <div class="input" style="min-width:unset" title="Ara">
            ğŸ” <input id="drawerSearch" type="search" placeholder="Ä°sim / oyun araâ€¦" autocomplete="off"/>
          </div>
          <div class="miniList" id="drawerList"></div>
        </div>
      </aside>
    </div>
  </section>
  <!-- Ä°STATÄ°STÄ°KLER -->
  

</div>

<script>
const CONFIG = {
  SPREADSHEET_ID: "1sIzswZnMkyRPJejAsE_ylSKzAF0RmFiACP4jYtz-AE0",
  API_BASE: "https://script.google.com/macros/s/AKfycbx-Q5P-dF5EB3GGCSHMUFV3din4OEYHhvSeGSZZjmSj7fN4_XtEL4h9E55XFy0-tL8V/exec",
  SHEET_MAIN: "BÃœTÃœN OYUNLAR",
  SHEET_FIGURAN: "FÄ°GÃœRAN LÄ°STESÄ°",
  // Bildirimler iÃ§in en stabil kaynak: Apps Script'in otomatik oluÅŸturduÄŸu LOG sayfasÄ±
  // (EÄŸer sende BÄ°LDÄ°RÄ°MLER diye ayrÄ± sayfa varsa, aÅŸaÄŸÄ±da fallback var.)
  SHEET_NOTIFS: "BÄ°LDÄ°RÄ°MLER",


    NOTIF_SHEET_NAME: "BÄ°LDÄ°RÄ°MLER",
  NOTIF_GVIZ_URL: "", // boÅŸ bÄ±rak (aÅŸaÄŸÄ±da otomatik oluÅŸturulacak)
// Ana veri (genelde: "BÃœTÃœN OYUNLAR")
  GID: "1233566992",

  // Apps Script'in oluÅŸturduÄŸu LOG sayfasÄ±nÄ±n gid'sini buraya yaz (URL'den kopyala: ...?gid=XXXX)
  LOG_GID: "",

  sheetUrl(gid=this.GID){ return `https://docs.google.com/spreadsheets/d/${this.SPREADSHEET_ID}/edit?gid=${gid}`; },
  gvizUrl(gid=this.GID){ return `https://docs.google.com/spreadsheets/d/${this.SPREADSHEET_ID}/gviz/tq?gid=${gid}&tqx=out:json&_=${Date.now()}`; },
  csvUrl(gid=this.GID){  return `https://docs.google.com/spreadsheets/d/${this.SPREADSHEET_ID}/export?format=csv&gid=${gid}&_=${Date.now()}`; },
};

function isMobile(){
  return window.matchMedia && window.matchMedia("(max-width: 980px)").matches;
}
function openMobileModal(html){
  if(!isMobile()) return;
  els.mobileContent.innerHTML = html;
  els.mobileOverlay.classList.remove("hidden");
  els.mobileModal.classList.remove("hidden");
  els.mobileOverlay.setAttribute("aria-hidden","false");
  document.body.style.overflow="hidden";
}
function closeMobileModal(){
  els.mobileOverlay.classList.add("hidden");
  els.mobileModal.classList.add("hidden");
  els.mobileOverlay.setAttribute("aria-hidden","true");
  document.body.style.overflow="";
}

const el = (id)=>document.getElementById(id);
const els = {
  themeBtn: el("themeBtn"),
  status: el("status"),
  sheetBtn: el("sheetBtn"),
  reloadBtn: el("reloadBtn"),
  advBtn: el("advBtn"),
  advMenu: el("advMenu"),
  advDist: el("advDist"),
  advInter: el("advInter"),
  notifBtn: el("notifBtn"),
  notifPanel: el("notifPanel"),
  notifCount: el("notifCount"),
  notifList: el("notifList"),
  notifRefresh: el("notifRefresh"),
  notifClose: el("notifClose"),

  tabPanel: el("tabPanel"),
  tabDistribution: el("tabDistribution"),
  tabIntersection: el("tabIntersection"),
  tabFiguran: el("tabFiguran"),
  tabCharts: el("tabCharts"),

  viewPanel: el("viewPanel"),
  viewDistribution: el("viewDistribution"),
  viewIntersection: el("viewIntersection"),
  viewFiguran: el("viewFiguran"),
  viewCharts: el("viewCharts"),

  q: el("q"),
  qScope: el("qScope"),
  qClear: el("qClear"),
  category: el("category"),
  clearBtn: el("clearBtn"),
  list: el("list"),
  hint: el("hint"),
  details: el("details"),
  copyBtn: el("copyBtn"),

  btnPlays: el("btnPlays"),
  btnPeople: el("btnPeople"),

  dq: el("dq"),
  dClear: el("dClear"),
  distributionBox: el("distributionBox"),

  p1: el("p1"),
  p2: el("p2"),
  swapBtn: el("swapBtn"),
  intersectionBox: el("intersectionBox"),

  fq: el("fq"),
  figDownloadAllBtn: el("figDownloadAllBtn"),
  fClear: el("fClear"),
  figuranBox: el("figuranBox"),

  chartTabRoles: el("chartTabRoles"),
  chartTabCats: el("chartTabCats"),
  chartTitle: el("chartTitle"),
  chartMain: el("chartMain"),
  chartMobileList: el("chartMobileList"),

  drawer: el("chartDrawer"),
  drawerTitle: el("drawerTitle"),
  drawerSub: el("drawerSub"),
  drawerClose: el("drawerClose"),
  drawerBack: el("drawerBack"),
  drawerCopyAll: el("drawerCopyAll"),
  drawerCopyVisible: el("drawerCopyVisible"),
  drawerCopyExpanded: el("drawerCopyExpanded"),
  drawerSearch: el("drawerSearch"),
  drawerList: el("drawerList"),

  kpiPlays: el("kpiPlays"),
  kpiPeople: el("kpiPeople"),
  kpiRows: el("kpiRows"),
  kpiFiguran: el("kpiFiguran"),
};
els.sheetBtn.href = CONFIG.sheetUrl();

// --- Chart canvas interactions (desktop) ---
if(els.chartMain){
  els.chartMain.addEventListener('click', onChartCanvasClick);
  els.chartMain.addEventListener('mousemove', (ev)=>{
    const hit = chartHitKeyFromEvent(ev);
    els.chartMain.style.cursor = hit ? 'pointer' : 'default';
  });
}


let rawRows = [];
let rows = [];
let ACTIVE_TAB = 'Panel';
let plays = [];
let people = [];
let playsList = [];
let activeMode = "plays";
let activeId = null;
let selectedItem = null;

let distribution = [];
let figuran = [];
let retiredSet = new Set();
let activePlayFilter = null; // mobilde: oyundan kiÅŸilere geÃ§ince filtre

let chartMode = "roles"; // roles | cats
let chartHits = []; // clickable regions
let drawerData = [];
let drawerStack = []; // for drill-down navigation
let drawerMode = "items"; // 'items' or 'labels'

/* ---------- Theme toggle ---------- */
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("idt_theme", theme);
}
(function initTheme(){
  const saved = localStorage.getItem("idt_theme");
  if(saved === "dark" || saved === "light") applyTheme(saved);
  else applyTheme("light");
})();
/* ---------- UI state (search/mode) ---------- */
(function initUiState(){
  try{
    const savedQ = localStorage.getItem("idt_q") || "";
    const savedScope = localStorage.getItem("idt_qscope") || "all";
    const savedMode = localStorage.getItem("idt_mode") || "plays";
    if(els.q) els.q.value = savedQ;
    if(els.qScope) els.qScope.value = savedScope;
    if(savedMode==="people" || savedMode==="plays"){
      activeMode = savedMode;
      if(activeMode==="plays"){ els.btnPlays.classList.add("active"); els.btnPeople.classList.remove("active"); }
      else { els.btnPeople.classList.add("active"); els.btnPlays.classList.remove("active"); }
    }
  }catch(_e){}
})();


els.themeBtn.addEventListener("click", ()=>{
  const cur = document.documentElement.getAttribute("data-theme") || "light";
  applyTheme(cur === "dark" ? "light" : "dark");
  if(rows.length && els.viewCharts.style.display!=="none"){ drawChart(); }
});

/* ---------- helpers ---------- */
function setStatus(text, tone="") {
  els.status.textContent = text;
  els.status.style.borderColor = "";
  els.status.style.background = "";
  els.status.style.color = "var(--muted)";
  if (tone === "ok") {
    els.status.style.borderColor = "color-mix(in srgb, var(--good) 25%, var(--line) 75%)";
    els.status.style.background = "color-mix(in srgb, var(--good) 10%, var(--card) 90%)";
    els.status.style.color = "var(--good)";
  } else if (tone === "bad") {
    els.status.style.borderColor = "color-mix(in srgb, var(--bad) 25%, var(--line) 75%)";
    els.status.style.background = "color-mix(in srgb, var(--bad) 10%, var(--card) 90%)";
    els.status.style.color = "var(--bad)";
  } else if (tone === "warn") {
    els.status.style.borderColor = "color-mix(in srgb, var(--warn) 25%, var(--line) 75%)";
    els.status.style.background = "color-mix(in srgb, var(--warn) 10%, var(--card) 90%)";
    els.status.style.color = "var(--warn)";
  } else {
    els.status.style.borderColor = "var(--line)";
    els.status.style.background = "var(--card)";
  }
}
function escapeHtml(s) {
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function personTag(name){
  const n=(name||"").toString().trim();
  return (n && retiredSet && retiredSet.has(n)) ? `<span class="tag retired">Kurumdan Emekli SanatÃ§Ä±</span>` : "";
}

function normalizeHeader(h){ return (h||"").trim().toLowerCase().replace(/\s+/g," "); }
function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

/* ---------- chart colors (canlÄ± + kategori sabit renk) ---------- */
// ---------- Grafik renkleri: her grafikte benzersiz / canlÄ± ----------
function currentTheme(){
  return (document.documentElement.getAttribute("data-theme") || "light") === "dark" ? "dark" : "light";
}
// Golden-angle ile birbirinden uzak renkler
function makeUniqueColors(n){
  const N = Math.max(1, n|0);
  const theme = currentTheme();
  const L = theme === "dark" ? 62 : 50;

  // First use a hand-picked distinct palette (good separation)
  const base = [
    "#e11d48","#f97316","#f59e0b","#84cc16","#22c55e","#10b981",
    "#06b6d4","#0ea5e9","#3b82f6","#6366f1","#8b5cf6","#a855f7",
    "#d946ef","#ec4899","#fb7185","#fda4af","#fdba74","#fde047",
    "#bef264","#86efac","#67e8f9","#93c5fd","#a5b4fc","#c4b5fd"
  ];
  const out = [];
  for(let i=0;i<N;i++){
    if(i < base.length){ out.push(base[i]); continue; }
    // Golden-angle fallback for large counts
    const hue = (i * 137.508) % 360;
    out.push(`hsl(${hue} 88% ${L}%)`);
  }
  return out;
}
function makeChartColorGetter(keys){
  const uniq = [...new Set((keys||[]).map(k=>String(k)))];
  const cols = makeUniqueColors(uniq.length);
  const map = new Map();
  uniq.forEach((k,i)=> map.set(k, cols[i]));
  // "DiÄŸer" ayrÄ± ve tÄ±klanabilir bir toplamdÄ±r
  const otherCol = cssVar("--accent2") || "#c07a2a";
  return (key)=> (String(key)==="DiÄŸer" ? otherCol : (map.get(String(key)) || otherCol));
}


/* ---------- load from Google ---------- */
function parseGviz(text){
  const m = text.match(/setResponse\((.*)\);?\s*$/s);
  if(!m) throw new Error("GViz formatÄ± okunamadÄ±.");
  return JSON.parse(m[1]);
}
function buildFromGviz(obj){
  const table = obj?.table;
  const cols = (table?.cols||[]).map(c=>(c.label||"").trim());
  const dataRows = (table?.rows||[]).map(r=>(r.c||[]).map(cell => (cell?.v ?? "")));

  const hn = cols.map(normalizeHeader);
  const need = ["oyun adÄ±","kategori","gÃ¶rev","kiÅŸi"];
  if(!need.every(n=>hn.includes(n))) throw new Error("BaÅŸlÄ±klar farklÄ±: Oyun AdÄ± / Kategori / GÃ¶rev / KiÅŸi");

  const idx = { play: hn.indexOf("oyun adÄ±"), cat: hn.indexOf("kategori"), role: hn.indexOf("gÃ¶rev"), person: hn.indexOf("kiÅŸi") };
  const out=[];
  for(const r of dataRows){
    const play=(r[idx.play]??"").toString().trim();
    const category=(r[idx.cat]??"").toString().trim();
    const role=(r[idx.role]??"").toString().trim();
    const person=(r[idx.person]??"").toString().trim();
    if(!play && !person && !role && !category) continue;
    if(!play) continue;
    out.push({play, category, role, person});
  }
  return out;
}
function csvToRows(csvText){
  const rows=[]; let cur="", inQ=false; let row=[];
  for(let i=0;i<csvText.length;i++){
    const ch=csvText[i], next=csvText[i+1];
    if(ch === '"' && inQ && next === '"'){ cur+='"'; i++; }
    else if(ch === '"'){ inQ=!inQ; }
    else if(ch === ',' && !inQ){ row.push(cur); cur=""; }
    else if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && next === '\n') i++;
      row.push(cur); cur="";
      if(row.some(v=>v!=="")) rows.push(row);
      row=[];
    } else cur+=ch;
  }
  row.push(cur);
  if(row.some(v=>v!=="")) rows.push(row);
  return rows;
}
function buildFromCsv(raw){
  const need=["oyun adÄ±","kategori","gÃ¶rev","kiÅŸi"];
  let headerIdx=-1;
  for(let i=0;i<Math.min(raw.length,30);i++){
    const hdr=raw[i].map(normalizeHeader);
    if(need.every(n=>hdr.includes(n))){ headerIdx=i; break; }
  }
  if(headerIdx===-1) throw new Error("BaÅŸlÄ±k satÄ±rÄ± bulunamadÄ±. (CSV)");
  const header=raw[headerIdx].map(x=>(x||"").trim());
  const hn=header.map(normalizeHeader);
  const idx={ play: hn.indexOf("oyun adÄ±"), cat: hn.indexOf("kategori"), role: hn.indexOf("gÃ¶rev"), person: hn.indexOf("kiÅŸi") };

  const out=[];
  for(let i=headerIdx+1;i<raw.length;i++){
    const r=raw[i];
    const play=(r[idx.play]||"").trim();
    const category=(r[idx.cat]||"").trim();
    const role=(r[idx.role]||"").trim();
    const person=(r[idx.person]||"").trim();
    if(!play && !person && !role && !category) continue;
    if(!play) continue;
    out.push({play, category, role, person});
  }
  return out;
}

function jsonp(url, timeoutMs=20000){
  return new Promise((resolve, reject)=>{
    const cb = "idt_cb_" + Math.random().toString(36).slice(2);
    const s = document.createElement("script");
    let done=false;
    const t = setTimeout(()=>{
      if(done) return;
      done=true;
      cleanup();
      reject(new Error("JSONP zaman aÅŸÄ±mÄ±"));
    }, timeoutMs);

    function cleanup(){
      clearTimeout(t);
      try{ delete window[cb]; }catch{}
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb] = (data)=>{
      if(done) return;
      done=true;
      cleanup();
      resolve(data);
    };

    const sep = url.includes("?") ? "&" : "?";
    s.src = url + sep + "callback=" + cb + "&_=" + Date.now();
    s.onerror = ()=>{
      if(done) return;
      done=true;
      cleanup();
      reject(new Error("JSONP yÃ¼klenemedi"));
    };
    document.body.appendChild(s);
  });
}

async function tryLoadApiJsonp(){
  if(!CONFIG.API_BASE) throw new Error("API_BASE tanÄ±mlÄ± deÄŸil");
  const url = `${CONFIG.API_BASE}?sheet=${encodeURIComponent(CONFIG.SHEET_MAIN)}`;
  const data = await jsonp(url);
  if(!data || data.ok !== true || !Array.isArray(data.rows)) throw new Error("API veri formatÄ± beklenmedik");
  // API -> ham satÄ±rlar
  return data.rows.map(r=>({
    play: String(r["Oyun AdÄ±"] ?? r["Oyun Adi"] ?? r["Oyun"] ?? "").trim(),
    category: String(r["Kategori"] ?? "").trim(),
    role: String(r["GÃ¶rev"] ?? r["Gorev"] ?? "").trim(),
    person: String(r["KiÅŸi"] ?? r["Kisi"] ?? "").trim(),
  })).filter(x=>x.play && x.person);
}

async function tryLoadGviz(){
  const res = await fetch(CONFIG.gvizUrl(), {cache:"no-store"});
  if(!res.ok) throw new Error(`GViz indirilemedi (${res.status}).`);
  const txt = await res.text();
  return buildFromGviz(parseGviz(txt));
}
async function tryLoadCsv(){
  const res = await fetch(CONFIG.csvUrl(), {cache:"no-store"});
  if(!res.ok) throw new Error(`CSV indirilemedi (${res.status}).`);
  const csv = await res.text();
  return buildFromCsv(csvToRows(csv));
}

/* ---------- split general ---------- */
function splitPeopleGeneral(cell){
  const s = (cell||"").toString().trim();
  if(!s) return [];
  const normalized = s
    .replace(/\r?\n/g, " | ")
    .replace(/;/g, " | ")
    .replace(/\s*\/\s*/g, " | ")
    .replace(/\s*,\s*/g, " | ")
    .replace(/\s+\bve\b\s+/gi, " | ");
  const parts = normalized.split("|").map(x=>x.trim()).filter(Boolean);
  const uniq=[]; const seen=new Set();
  for(const p of parts){
    const key=p.toLowerCase();
    if(!seen.has(key)){ seen.add(key); uniq.push(p); }
  }
  return uniq.length ? uniq : [s];
}
function expandRowsByPeople(data){
  const out=[];
  for(const r of data){
    const people = splitPeopleGeneral(r.person);
    if(!people.length){ out.push({...r, person:""}); continue; }
    for(const p of people){ out.push({...r, person:p}); }
  }
  return out;
}

/* ---------- Apps Script compatible figuran extraction ---------- */
function splitPeopleTokensApps(text){
  const cleaned = (text||"").toString().replace(/\r/g, "\n").trim();
  return cleaned.split(/[\n,;]+/g).map(s=>s.trim()).filter(Boolean);
}
function hasFiguranTag(token){
  return /\(\s*fig[Ã¼u]ran\s*\)/i.test((token||"").toString());
}
function stripFiguranTag(token){
  return (token||"").toString().replace(/\(\s*fig[Ã¼u]ran\s*\)/ig, "").replace(/^"+|"+$/g, "").trim();
}
function computeRetiredSetFromRaw(){
  const set = new Set();
  for(const r of rawRows){
    const kategoriRaw = (r.category||"").trim().toLowerCase();
    if(/kurumdan\s*emekl/i.test(kategoriRaw) && r.person){
      const tokens = splitPeopleTokensApps((r.person||"").trim());
      for(const t of tokens){
        const name = stripFiguranTag(t);
        if(name) set.add(name);
      }
    }
  }
  return set;
}

function computeFiguranFromRaw(){
  // Apps Script ile aynÄ± mantÄ±k:
  // - Kategori "Kurumdan Emekli SanatÃ§Ä±" ise: kiÅŸi(ler)i direkt al
  // - Kategori figÃ¼ran ise:
  //   - tek kiÅŸi: al
  //   - Ã§ok kiÅŸi: sadece (FigÃ¼ran) etiketlileri al
  const map = new Map();

  for(const r of rawRows){
    const oyun = (r.play||"").trim();
    const kategoriRaw = (r.category||"").trim();
    const gorevRaw = (r.role||"").trim();
    const kisiRaw = (r.person||"").trim();
    if(!kisiRaw) continue;

    const kategoriLower = kategoriRaw.toLowerCase();
    const isRetiredArtist = /kurumdan\s*emekl/i.test(kategoriLower);
    const isFiguranCategory = /fig[Ã¼u]ran/i.test(kategoriLower);
    if(!isRetiredArtist && !isFiguranCategory) continue;

    const tokens = splitPeopleTokensApps(kisiRaw);
    if(!tokens.length) continue;

    let selectedPeople = [];
    if(isRetiredArtist){
      selectedPeople = tokens.map(stripFiguranTag).filter(Boolean);
    }else{
      if(tokens.length === 1){
        selectedPeople = [stripFiguranTag(tokens[0])].filter(Boolean);
      }else{
        selectedPeople = tokens.filter(hasFiguranTag).map(stripFiguranTag).filter(Boolean);
      }
    }
    if(!selectedPeople.length) continue;

    for(const kisi of selectedPeople){
      if(!map.has(kisi)) map.set(kisi, {games:new Set(), roles:new Set(), cats:new Set()});
      const obj = map.get(kisi);
      obj.cats.add(isRetiredArtist ? "Kurumdan Emekli SanatÃ§Ä±" : "FigÃ¼ran");
      if(oyun) obj.games.add(oyun);
      if(gorevRaw) obj.roles.add(gorevRaw);
    }
  }

  const out = [...map.entries()].map(([person, obj])=>({
    person,
    cats:[...obj.cats].sort((a,b)=>a.localeCompare(b,"tr")),
    plays:[...obj.games].sort((a,b)=>a.localeCompare(b,"tr")),
    roles:[...obj.roles].sort((a,b)=>a.localeCompare(b,"tr"))}));
  out.sort((a,b)=>a.person.localeCompare(b.person,"tr"));
  return out;
}


/* ---------- notifications (LOG) ---------- */
function parseLogFromGviz(obj){
  const table = obj?.table;
  const cols = (table?.cols||[]).map(c=>(c.label||"").trim());
  const dataRows = (table?.rows||[]).map(r=>(r.c||[]).map(cell => (cell?.v ?? "")));
  // Beklenen baÅŸlÄ±klar (Apps Script): Tarih/Saat, Ä°ÅŸlem, KiÅŸi, ...
  // FarklÄ±lÄ±k olursa yine de ilk 3 sÃ¼tunu baz alÄ±rÄ±z.
  const out = [];
  for(const r of dataRows){
    const when = (r[0] ?? "").toString();
    const action = (r[1] ?? "").toString();
    const person = (r[2] ?? "").toString();
    const beforeCat = (r[3] ?? "").toString();
    const afterCat  = (r[4] ?? "").toString();
    const beforeRole= (r[5] ?? "").toString();
    const afterRole = (r[6] ?? "").toString();
    const beforePlay= (r[7] ?? "").toString();
    const afterPlay = (r[8] ?? "").toString();
    if(!when && !action && !person) continue;
    out.push({when, action, person, beforeCat, afterCat, beforeRole, afterRole, beforePlay, afterPlay});
  }
  // yeni -> eski
  return out.reverse();
}


async function loadNotifications(){
  // 1) Ã–nce Apps Script Web App JSON endpoint (BÄ°LDÄ°RÄ°MLER) dene
  try{
    const url = `${CONFIG.API_BASE}?sheet=${encodeURIComponent(CONFIG.SHEET_NOTIFS)}&limit=120`;
    const res = await fetch(url, { method:"GET" });
    if(res.ok){
      const j = await res.json();
      if(j && j.ok && Array.isArray(j.rows)){
        const items = j.rows.map(r => ({
          time: r["Tarih"] || r["Tarih/Saat"] || "",
          type: r["Ä°ÅŸlem"] || r["TÃ¼r"] || "BÄ°LGÄ°",
          title: r["KiÅŸi"] || "",
          desc: r["AÃ§Ä±klama"] || r["Mesaj"] || "",
          oyun: r["Oyun"] || "",
          gorev: r["GÃ¶rev"] || ""
        }));
        showNotifItems(items);
        setNotifBadge(items.length);
        return;
      }
    }
  }catch(e){
    // JSON endpoint eriÅŸilemezse sessizce alt yola dÃ¼ÅŸ
  }

  // 2) Fallback: JSONP (eÄŸer endpoint callback destekliyorsa)
  try{
    const cbName = `__notif_cb_${Date.now()}`;
    await new Promise((resolve, reject) => {
      window[cbName] = (json) => {
        try{
          delete window[cbName];
          script.remove();
          if(json && json.ok && Array.isArray(json.rows)){
            const items = json.rows.map(r => ({
              time: r["Tarih"] || r["Tarih/Saat"] || "",
              type: r["Ä°ÅŸlem"] || r["TÃ¼r"] || "BÄ°LGÄ°",
              title: r["KiÅŸi"] || "",
              desc: r["AÃ§Ä±klama"] || r["Mesaj"] || "",
              oyun: r["Oyun"] || "",
              gorev: r["GÃ¶rev"] || ""
            }));
            showNotifItems(items);
            setNotifBadge(items.length);
            resolve();
          } else {
            reject(new Error(json?.error || "JSONP baÅŸarÄ±sÄ±z"));
          }
        }catch(err){ reject(err); }
      };
      const url = `${CONFIG.API_BASE}?sheet=${encodeURIComponent(CONFIG.SHEET_NOTIFS)}&limit=120&callback=${cbName}`;
      const script = document.createElement("script");
      script.src = url;
      script.onerror = () => {
        delete window[cbName];
        script.remove();
        reject(new Error("JSONP yÃ¼klenemedi"));
      };
      document.body.appendChild(script);
    });
  }catch(e){
    // En son Ã§are: LOG Ã¼zerinden GViz (eÄŸer hÃ¢lÃ¢ kullanÄ±yorsan)
    try{
      const items = await loadLogSheetAsNotifs();
      showNotifItems(items);
      setNotifBadge(items.length);
    }catch(_){}
  }
}
async function load(isAuto=false){
  if(!isAuto) setStatus("â³ YÃ¼kleniyorâ€¦");
  activeId=null; selectedItem=null;
  try{
    // ğŸš€ HÄ±zlÄ± aÃ§Ä±lÄ±ÅŸ: varsa cache'ten anÄ±nda Ã§iz (arkada gÃ¼ncelle)
    if(!isAuto){
      try{
        const cached = localStorage.getItem("idt_cache_v1");
        const cachedAt = Number(localStorage.getItem("idt_cache_v1_at")||0);
        if(cached){
          const ageMin = (Date.now()-cachedAt)/60000;
          rawRows = JSON.parse(cached);
          rows = expandRowsByPeople(rawRows);
          plays = groupByPlay(rows);
          people = groupByPerson(rows);
          playsList = plays.map(p=>p.title);
          renderList();
          renderDetails(null);
          distribution = computeDistribution();
          renderDistribution();
          retiredSet = computeRetiredSetFromRaw();
          figuran = computeFiguranFromRaw();
          renderFiguran();
          renderPlayOptions();
          renderIntersection();
          renderKpis();
          setStatus(`â³ GÃ¼ncelleniyorâ€¦ (cache${ageMin?` â€¢ ${Math.round(ageMin)}dk`:""})`);
        }
      }catch(_){/* cache bozuksa gÃ¶rmezden gel */}
    }

    try{ rawRows = await tryLoadApiJsonp(); }
    catch(e1){
      try{ rawRows = await tryLoadGviz(); }
      catch(e2){ rawRows = await tryLoadCsv(); }
    }

    // Cache (bir sonraki aÃ§Ä±lÄ±ÅŸta hÄ±zlÄ± render iÃ§in)
    try{
      localStorage.setItem("idt_cache_v1", JSON.stringify(rawRows));
      localStorage.setItem("idt_cache_v1_at", String(Date.now()));
    }catch(_){/* localStorage doluysa sorun deÄŸil */}

    rows = expandRowsByPeople(rawRows);
    plays = groupByPlay(rows);
    people = groupByPerson(rows);
    playsList = plays.map(p=>p.title);


    renderList();
    renderDetails(null);

    distribution = computeDistribution();
    renderDistribution();

    retiredSet = computeRetiredSetFromRaw();
    retiredSet = computeRetiredSetFromRaw();
    figuran = computeFiguranFromRaw();
    renderFiguran();

    renderPlayOptions();
    renderIntersection();

    renderKpis();

    // cache'e yaz
    try{
      localStorage.setItem("idt_cache_v1", JSON.stringify(rawRows));
      localStorage.setItem("idt_cache_v1_at", String(Date.now()));
    }catch(_){/* storage dolu olabilir */}

    const when = new Date().toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
    setStatus(`âœ… HazÄ±r â€¢ ${when}`, "ok");
    // Bildirimleri (BÄ°LDÄ°RÄ°MLER) yÃ¼kle
    loadNotifications();
  }catch(err){
    console.error(err);
    setStatus("â›” Veri Ã§ekilemedi", "bad");
    els.list.innerHTML = `<div class="empty" style="text-align:left;white-space:pre-wrap">
<b>Veri Ã§ekilemedi.</b>

1) Sheet paylaÅŸÄ±mÄ±: PaylaÅŸ â†’ â€œBaÄŸlantÄ±ya sahip herkes: GÃ¶rÃ¼ntÃ¼leyebilirâ€
2) Netlify / GitHub Pagesâ€™da genelde sorunsuz Ã§alÄ±ÅŸÄ±r.

Hata: ${escapeHtml(err.message || String(err))}
</div>`;
    els.details.innerHTML = `<div class="empty">Ã–nce veri gelsin ğŸ™‚</div>`;
    els.distributionBox.innerHTML = `<div class="empty">Veri yok.</div>`;
    els.figuranBox.innerHTML = `<div class="empty">Veri yok.</div>`;
    els.intersectionBox.innerHTML = `<div class="empty">Veri yok.</div>`;
  }
}

load(false);
/* --- Fallback init: ensure data load runs --- */
document.addEventListener("DOMContentLoaded", ()=>{
  try{
    if(typeof boot === "function") boot();
    else if(typeof loadAll === "function") loadAll();
    else if(typeof load === "function") load();
    else if(typeof init === "function") init();
  }catch(e){ console.error(e); }
});

/* --- Nav polish: Ek AraÃ§lar sekmeye taÅŸÄ±nÄ±r + ikonlar --- */
document.addEventListener("DOMContentLoaded", ()=>{
  try{
    const nav = document.querySelector(".nav");
    const advBtn = document.getElementById("advBtn");
    if(nav && advBtn){
      advBtn.classList.add("tab");
      advBtn.classList.remove("btn");
      nav.appendChild(advBtn);
    }
    const iconMap = [
      ["tabPanel","ğŸ  "],
      ["tabDistribution","ğŸ­ "],
      ["tabIntersection","ğŸ” "],
      ["tabFiguran","ğŸ‘¥ "],
      ["tabCharts","ğŸ“Š "],
      ["advBtn","ğŸ§° "],
    ];
    iconMap.forEach(([id,ico])=>{
      const el = document.getElementById(id);
      if(el && !el.dataset.iconed){
        el.dataset.iconed="1";
        el.textContent = ico + el.textContent.replace(/^(ğŸ§°|ğŸ“Š|ğŸ‘¥|ğŸ”|ğŸ­|ğŸ )\s+/,"");
      }
    });
  }catch(e){ console.error(e); }
});

/* v26: Intersection badge replace (emoji -> span) */
document.addEventListener("DOMContentLoaded", ()=>{
  try{
    const makeBadge = (n)=>{
      const s=document.createElement("span");
      s.className="numBadge";
      s.textContent=String(n);
      return s;
    };
    const fix = (title,n)=>{
      const box = document.querySelector(`#viewIntersection .input[title="${title}"]`);
      if(!box) return;
      // Remove leading emoji text nodes (1ï¸âƒ£/2ï¸âƒ£) if present
      for(const node of Array.from(box.childNodes)){
        if(node.nodeType===Node.TEXT_NODE && node.textContent.includes("ï¸âƒ£")){
          node.textContent = node.textContent.replace(/\s*\dï¸âƒ£\s*/g,"");
        }
      }
      if(!box.querySelector(".numBadge")){
        box.insertBefore(makeBadge(n), box.firstChild);
      }
    };
    fix("1. Oyun",1);
    fix("2. Oyun",2);
  }catch(e){ console.error(e); }
});
</script>

  <!-- Mobile detail modal -->
  <div id="mobileOverlay" class="overlay hidden" aria-hidden="true"></div>
  <div id="mobileModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Detay">
    <div class="modalHead">
      <div class="modalTitle">Detay</div>
      <button id="modalClose" class="btn sm">Kapat</button>
    </div>
    <div id="mobileContent" class="modalBody"></div>
  </div>

</body>
</html>
